# -*- coding: utf-8 -*-
"""
Created on Wed Mar 18 06:26:25 2015

@author: Alex

this paper is different than the Fagaalu-SSY paper because the figures are combined with figures from a collaborator
in this case the figures are generated by other scripts and manually combined with the collaborators figures
these cannot be automated but the scripts have README's associated with the figures.

"""
#### Import modules
## Data Processing
import os
import numpy as np
import pandas as pd
#import math
import datetime as dt
import matplotlib.pyplot as plt
#### Plotting Tools
import matplotlib.pyplot as plt
import matplotlib as mpl
plt.ioff()
plt.close('all')

## Python docx
from docx import *
from docx.shared import Inches
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH

## Set Directories
git=True
if git==True: ## Git repository
    maindir = 'C:/Users/Alex/Documents/GitHub/Faga-alu-Bay-water-circulation/' 
    datadir=maindir+'Data/'
    trackdir = maindir+'Data/AllTracks/'
    GISdir = maindir+'Data/DriftersGIS/'
    figdir = maindir+'Figures/fromAlex/'
    dirs={'main':maindir,'data':datadir,'track':trackdir,'GIS':GISdir,'fig':figdir}
elif git!=True: ## Local folders
    datadir = 'C:/Users/Alex/Desktop/'
    trackdir = 'samoa/DRIFTERS/AllTracks/'


##  Create Document
document = Document()
tables_and_figures = Document()

######## SOME TOOLS
figure_captions = []
def add_figure_caption(fig_num=str(len(document.inline_shapes)),caption=''):
    manuscript_cap = document.add_paragraph("Insert Figure "+fig_num+" here")
    manuscript_cap = document.add_paragraph("Figure "+fig_num+". "+caption)
    manuscript_cap.paragraph_style = 'caption'
    
    #figs_cap = tables_and_figures.add_paragraph("Figure "+fig_num+". "+caption)
    figure_captions.append("Figure "+fig_num+". "+caption)
    return

table_titles = []
def dataframe_to_table(df=pd.DataFrame(),table_num=str(len(document.tables)+1),caption='',fontsize=11):
    table = tables_and_figures.add_table(rows=1, cols=len(df.columns)) 
    ## Merge all cells in top row and add caption text
    table_caption = table.rows[0].cells[0].merge(table.rows[0].cells[len(df.columns)-1])
    table_caption.text = "Table "+table_num+". "+caption
    ## Add  header
    header_row = table.add_row().cells
    col_count =0 ## counter  to iterate over columns
    for col in  header_row:
        col.text = df.columns[col_count] #df.columns[0] is the index
        col_count+=1
    ## Add data by  iterating over the DataFrame rows, then using a dictionary of DataFrame column labels to extract data
    col_labels = dict(zip(range(len(df.columns)),df.columns.tolist())) ## create dictionary where '1  to  n' is key for DataFrame columns
    for row in df.iterrows():  ## iterate over  rows in  DataFrame
        #print row[1]
        row_cells = table.add_row().cells ## Add a row to the  table
        col_count  = 0
        for cell in row_cells: ## iterate over the columns in the row
            #print row[1][str(col_labels[col_count])]
            cell.text = str(row[1][str(col_labels[col_count])]) ## and plug in data using a dictionary to  get column labels for DataFrame
            col_count+=1
    ## Format Table Style  
    table.style = 'TableGrid' 
    table.style.font.size = Pt(fontsize)
    table.autofit
    #table.num = str(len(document.tables)+1)
    table_titles.append("Table "+table_num+". "+caption)
    return table
    
def add_equation(eq_table):
    t = document.add_table(rows=len(eq_table.rows),cols=len(eq_table.columns))
    t.rows[0].cells[1].text = eq_table.rows[0].cells[1].text
    t.rows[0].cells[2].text = eq_table.rows[0].cells[2].text   
    if len(eq_table.rows)>1:
        t.rows[1].cells[0].merge(t.rows[1].cells[2]).text = eq_table.rows[1].cells[0].text
    t.style = 'TableGrid'   
    t.autofit
    return t
###################################################################################################################################################################    


#### TABLES ###########################################################################################################################
table_count=0
def tab_count():
    global table_count
    table_count+=1
    return str(table_count)
    
## End member definitions
def Endmember_definitions_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    endmember_table = XL.parse('EndmemberDefn',header=0,index_col=0,parse_cols='A:D',parse_dates=False)
    endmember_table['End member']=endmember_table.index
    endmember_table = endmember_table[['End member','Year Day 2014', 'Gregorian Day (UTC)','Gregorian Day (Local)']]
    return endmember_table  
Endmember_table = Endmember_definitions_table()
Endmember_table.table_num = str(tab_count())    
    
## Drifter deployment dates
def Drifter_deployments_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    deployment_table = XL.parse('Table',header=1,index_col=0,parse_cols='C:P',parse_dates=False)
    deployment_table['Deployment'] = deployment_table.index
    deployment_table['Date'] = deployment_table['Date'].apply(lambda x: "{:%m/%d/%Y}".format(x))
    ## Tide start, end, movement
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft']*0.3048 #ft to m
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft'].round(1)
    deployment_table['Tide End m'] = deployment_table['Tide End ft']*0.3048 #ft to m
    deployment_table['Tide End m'] = deployment_table['Tide End m'].round(1)
    deployment_table['Tide movement m'] = deployment_table['Tide movement ft']*0.3048 #ft to m
    deployment_table['Tide movement m'] = deployment_table['Tide movement m'].round(2)
    ## Wind speed, gust direction
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg kts']*0.514 # kts to m/s
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg m/s'].round(1)
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max kts']*0.514 # kts to m/s
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max m/s'].round(0)
    deployment_table['Wind Direction Avg deg'] = deployment_table['Wind Direction Avg deg'].apply(int)
    ## Wave height
    deployment_table['Wave Height m'] = deployment_table['Wave Height m']
    ## Combine into table
    deployment_table= deployment_table[['Deployment','Year Day 2014 (local)','Start Time','End Time','Tide Start m','Tide End m','Tide movement m','Wind Speed Avg m/s','Wind Gust Max m/s','Wind Direction Avg deg','Wave Height m']]
    return deployment_table
Drifter_deployment_table = Drifter_deployments_table()
Drifter_deployment_table.table_num = str(tab_count())    


#### FIGURES ########################################################################################################################################################
figure_count=0
def fig_count():
    global figure_count
    figure_count+=1
    return str(figure_count)
    
## INTRODUCTION
#### Study Area Map
Study_Area_map = {'filename':maindir+'Figures/Maps/Drifter LZ ADCP.jpg', 'fig_num':str(fig_count())}

### Pics of Bay
Bay_sedplume = {'filename':maindir+'Figures/Pics/Bay clear and plume.png', 'fig_num':str(fig_count())}

### Pics of Drifters and ADCP's
Drifter_ADCP_pics = {'filename':maindir+'Figures/Pics/ADCP Drifter pics.png', 'fig_num':str(fig_count())}

### Forcing data
Forcing_data_timeseries = {'filename':maindir+'Figures/Forcing/AmSam_ADCPdrifter_Fig_3_forcing_lettered.jpg', 'fig_num':str(fig_count())}

### ADCP measurements
ADCP_measurements = {'filename':maindir+'Figures/ADCP measurements/Figure4_ADCP.png', 'fig_num':str(fig_count())}

### All Drifter tracks
ALL_Drifter_tracks = {'filename':maindir+'Figures/ALL drifter tracks/drifters_all_arrows_speed.png', 'fig_num':str(fig_count())}

### Progressive Vectors vs drifter tracks
Progressive_Vectors_ADCP_vs_Drifters = {'filename':maindir+'Figures/Progressive Vectors/Figure6_progvec_driftervelocity_lettered.png', 'fig_num':str(fig_count())}

## Gridded PCA by endmember
PCA_gridded = {'filename':maindir+'Figures/Gridded PCA endmembers/Figure7_paxes_map_OMC_lettered.png', 'fig_num':str(fig_count())}

#### Gridded velocity by endmember
#Gridded_Velocity_endmembers = {'filename':maindir+'Figures/Gridded velocity endmembers/Fagaalu_velocity-endmembers.png', 'fig_num':str(fig_count())}

### Gridded residence time by endmember
Gridded_ResidenceTime_endmembers = {'filename':maindir+'Figures/Residence Times/Fagaalu_gridded_residence_time_lettered.png','fig_num':str(fig_count())}

###### EQUATIONS ############################################################################################################################################
equation_count=0
def eq_count():
    global equation_count
    equation_count+=1
    return str(equation_count)
    
#Equations = Document(maindir+'/Manuscript/Equations.docx').tables
#
### SSYev = Q*SSC 
#Equation_one = Equations[0].table
#Equation_one.eq_num = eq_count()

##### APPENDIX #################################################################################################################################
#### Appendix
table_count,figure_count,equation_count=0, 0, 0
### Appendix Table One
#Appendix_table_one = table_function() ## function to create table data
#Appendix_table_one.table_num =str(tab_count())

############################################################################################################################################

#### TITLE
title_title = document.add_heading('TITLE:',level=1)
title_title.paragraph_format.space_before = 0
title = document.add_heading("Eulerian and Lagrangian measurements of flow and residence time on a fringing reef flat embayment, American Samoa",level=1)
title.paragraph_format.space_before = 0
## Authors
document.add_heading('Authors:',level=3)
document.add_paragraph("Messina, A.M.a*, Storlazzi, C.D.b, Cheriton, O.M.b, Biggs, T.W.a")
document.add_paragraph("a San Diego State University, Department of Geography, San Diego, CA 92182, amessina@rohan.sdsu.edu, +1-619-594-5437, tbiggs@mail.sdsu.edu, +1-619-594-0902")
document.add_paragraph("b US Geological Survey, Pacific Coastal and Marine Science Center, Santa Cruz, CA 95060, cstorlazzi@usgs.gov, +1-831-460-7521, ocheriton@usgs.gov, +1-831-460-7579")

document.add_paragraph("scripted terms: a, b, km2")
#### ABSTRACT
abstract_title = document.add_heading('ABSTRACT',level=2)
abstract_title.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER
abstract = document.add_paragraph("Hydrodynamic processes on coral reefs are important for nutrient cycling, larval dispersal, temperature variability, and understanding the impacts of terrestrial sediment, nutrients, and contaminants from adjacent impaired watersheds on coral reef ecosystems. In order to understand the spatial and temporal variability in flow velocities and the resulting residence time of water in the fringing coral reef flat-lined embayment of Faga'alu, on the island of Tutuila in American Samoa, data from acoustic current profilers and ocean surface current drifter deployments were combined with meteorologic data and numerical wave model results. These data and model results, collected over nine days, made it possible to evaluate the relative contribution of tidal, wind, and wave forcing on the flow patterns and resulting residence times of water masses over the reef. Mean residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.55-0.04 hr under tidal, wind, and wave forcing, respectively; the lowest residence times were on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment. These results demonstrate the applicability of a hybrid Lagrangian-Eulerian measurement scheme to understand flow patterns and thus residence time in geomorphically-complex embayments that characterize many reef-lined coasts.")

## Keywords
document.add_heading('KEYWORDS:',level=3)
document.add_paragraph("coral reefs, drifters, Water circulation, Residence time")

#### INTRODUCTION
introduction_title = document.add_heading('INTRODUCTION',level=2)
document.add_paragraph("Hydrodynamic conditions, including the residence time of waters over the reef flat, are a primary control on sediment dynamics in fringing reef embayments (Draut et al., 2009; Storlazzi et al., 2009 ), and are important for other biologically important processes like nutrient cycling, larval dispersal, and temperature regimes (Falter et al., 2004; Wyatt et al., 2012). Current conservation planning is done with coarse estimations of pollutant discharge and distance-based plume models (Klein et al., 2012), but understanding the spatial and temporal variability in current speeds, flow directions, and residence time of water over corals is critical for understanding sedimentation patterns and impacts to coral health. However, spatially distributed flows under variable forcing conditions are logistically difficult to quantify. ")

document.add_paragraph("Hydrodynamic conditions control sediment accumulation in two ways: by limiting primary deposition, and by resuspending and advecting previously deposited sediment. Following large or intense storm events, sediment-rich freshwater is discharged into reef-fringed bays and advected seaward over the reef by momentum in a thin surface layer. This sediment-rich layer significantly attenuates photosynthetically active radiation and transports fine sediment over the reef where it can settle out of the water column and damage corals. Although the hypopycnal surface plume is able to move counter to prevailing ocean currents (upcurrent) by sliding over denser seawater, as sediment particles settle they are entrained in the prevailing current and transported accordingly (Wolanski et al., 2003). As flow velocities increase, residence time of the plume over the reef flat is decreased, limiting time for small particles to settle out of the water column. In reef environments where shallow reef crests limit the propagation of incoming surface wave energy, wave action alone may be insufficient to resuspend and disperse sediment, but in combination with wave- or wind-driven currents, orbital velocities may reach critical shear stress for sediment resuspension and dispersal (Ogston et al., 2004; Hoeke et al., 2013). By influencing orbital velocities, bed shear stress, and suspended sediment transport, current circulation is a strong control on the spatial distribution of deposition, resuspension, and dispersal of terrigenous sediment discharged to reefs (Hoitink and Hoekstra, 2003; Storlazzi et al., 2004; Presto et al., 2006; Hoeke et al., 2013).")

document.add_paragraph("Studies in various coral reef environments adjacent high islands showed current speeds, directions, and residence times over reef flats are controlled by wave, wind, and tidal forcing, depending on the orientation and shape of the reef, relative to the prevailing wave, wind, and tidal climates (Hench et al., 2008; Hoeke et al., 2011; Presto et al., 2006; Storlazzi and Field, 2008; Storlazzi et al., 2004). Variations in reef morphology relative to the orientation of the dominant meteorological and oceanographic forcing can generate heterogeneous waves and currents over relatively small (hundreds of meters) spatial scales, unlike those observed along relatively linear sandy shorelines (Storlazzi et al., 2009; Hoeke et al., 2011, 2013). Buoyancy forcing from hypopycnal river floods is generally ignored or considered inconsequential due to their rarity and short duration relative to other forcings (Hench et al., 2008; Hoeke et al., 2011). Current speeds and patterns over reefs exposed to remotely-generated groundswells are generally dominated by wave forcing (Hench et al., 2008; Hoeke et al., 2011; Vetter et al., 2010), whereas wind forcing is dominant for reefs protected from groundswells (Presto et al., 2006). Tidal elevation modulates both wave-driven currents by controlling the reef crest depth and subsequent wave energy propagation into the reef flat, and wind-driven currents by regulating water depth for wind-driven surface wave development (Presto et al., 2006). Reef flat currents in wave-driven environments exhibit a pattern of rapid, cross-shore flow near the reef crest that slows moving shoreward and turns along-shore towards a deep channel where water returns seaward (Hench et al., 2008; Lowe et al., 2009; Wyatt et al., 2010). In wind-driven systems, current directions are more predominantly in the direction of the wind with possible cross-shore exchange from the reef flat to the forereef (Storlazzi et al., 2004).")

## SHORTEN AND COMBINE THIS
document.add_paragraph("Water flow can be quantified in two ways: 1) the Lagrangian perspective observes an individual fluid parcel as it moves through space and time, 2) the Eulerian perspective focuses on specific locations, observing the fluid flow past that location over time. Eulerian methods characterize water circulation on the reef using bottom-mounted instruments to record wave height and period, current speed and direction, and/or tidal elevation (Presto et al., 2006; Storlazzi et al., 2009). Eulerian methods are well-suited to characterizing flows over long periods and a large range of forcing conditions. However, collecting high spatial resolution data of hydrodynamic processes using strictly Eulerian methods is expensive and logistically difficult (Curt D. Storlazzi et al., 2006; Storlazzi et al., 2004). Spatially distributed current speeds and directions can be predicted by hydrodynamic computer models (Hoeke et al., 2011), but models typically require accurate bathymetry, detailed forcing data, and significant modeling expertise (Hoeke, 2010; King et al., 2012; Wolanski et al., 2009). While imagery-based remote sensing is useful to map the temporal and spatial distribution of flood plume boundaries (Klemas, 2012; Warrick et al., 2007), even high resolution imagery may not quantify the underlying current circulation, which is a strong control on sediment transport. Instead, Lagrangian methods including the use of GPS-tracking drifters have been used to map flow patterns in coastal areas, compare to Eulerian descriptions of flow speeds (C. D. Storlazzi et al., 2006; Storlazzi et al., 2004; Wyatt et al., 2012) or validate hydrodynamic computer models (Ouillon et al., 2010). Research on rip currents in beach surf zones have shown the ability to capture synoptic measurements of small-scale flow structures and patterns by deploying large numbers of GPS-logging drifters to collect high-density observations of flow velocities (Johnson et al., 2003; MacMahan et al., 2010). While deploying a fleet of GPS-logging drifters has yielded synoptic measurements of water movement in surf zones near linear, sandy beaches, it has not been attempted in a shallow reef environment.")

document.add_paragraph("While Lagrangian measurements provide spatially explicit data on the flow field, drifter studies in nearshore environments are typically limited in number of drifters, number of deployments, and the range of oceanic and meteorological conditions experienced during deployments, making it uncertain whether they describe the dominant patterns, or short-lived anomalies (C. D. Storlazzi et al., 2006; Wyatt et al., 2010). Storlazzi et al., (2006) successfully combined Eulerian and Lagrangian methods by comparing Lagrangian drifter tracks with progressive vectors of cumulative flow calculated from Eulerian current meters to determine if short-term observations from drifters were representative of the dominant patterns. This approach yields spatially distributed flow data from the Lagrangian drifters, within the context of the longer time series of flow forcing from the Eulerian methods.")

## You now need a paragraph that wraps it all up. It needs to say, 
## â€œWell, because of these data/knowledge gaps we just described, we did x, y, and z to try to understand a, b, and c, etc.
#document.add_paragraph("Since it is known that hydrodynamic conditions control sediment accumulation and impact coral health, it is desirable to characterize spatially distributed flow patterns at the study site in relation to wave, wind, and tide forcings. For this study, Eulerian current profilers were used to characterize flow at fixed points on the reef flat in relation to long-term forcing conditions, and provide context for short-term, spatially distributed flow measurments from Lagrangian drifters.") 
document.add_paragraph("Since water residence time is critical to sediment dynamics and coral heath, what is the water residence time over the Faga'alu reef flat and how does it change under wave, wind and tidal forcing? To address this main research question we compared the spatially extensive Lagrangian measurements with the longer term Eulerian measurements to calculate spatially distributed water residence time under different 'end-member' forcing conditions: tide, wind, wave.")

#### STUDY AREA
study_area_title = document.add_heading('STUDY AREA',level=2)

## Study Area map
if 'Study_Area_map' in locals():
    tables_and_figures.add_picture(Study_Area_map['filename'],width=Inches(6))
    add_figure_caption(Study_Area_map['fig_num'],"Data collection locations in Faga'alu Bay. Wind speed and direction were recorded at the weather station (WxStation), a Dobie wave gauge recorded wave height and period (Wave Gauge), three ADCP's were deployed for one week to measure current speed and direction, and five GPS-logging drifters were deployed from the same five launch zones (DrifterLaunch) for thirty separate deployments (January to March, 2014).")

document.add_paragraph("Faga'alu Bay, on the island of Tutuila, American Samoa (14.290 S, 170.677 W) is a V-shaped, reef-fringed embayment at the mouth of a small (2.48 km2), steep-sided watershed (Figure "+Study_Area_map['fig_num']+"). The reef is characterized by a shallow reef flat extending from just off the shore to the reef crest, where it then descends nearly vertically to the deep waters of Pago Pago Bay. Wave breaking is constrained to the shallow reef crests, the transitions between the steeply-sloping fore reef and the roughly horizontal reef flats.  Near the reef crest, the reef flat is cemented reef pavement, but near the shore in the southern backreef there are areas of deeper (1-5m) pools. An anthropogenically altered, vertical-walled, 5-10 m deep paleo-stream channel ('ava) extends from the mouth of Faga'alu Stream eastward to Pago Pago Bay; this 'ava divides the reef into a larger southern and a smaller northern section . NOAA surveys found coral coverage varies from <10% on the degraded northern reef, to >50% on the more intact southern reef. Following large or intense storm events, suspended sediment is discharged from Faga'alu Stream in the northwest corner of the Bay, and advected seaward over the reef by momentum in a thin surface layer of freshwater. Suspended sediment concentrations (SSC) in this layer often exceed 500mg/l which significantly attenuates photosynthetically active radiation and transports fine sediment over the reef where it can settle out of the water column and onto coral reef organisms. Although the hypopycnal surface plume is able to move counter to prevailing currents (upcurrent) by sliding over denser seawater, as sediment particles settle they are entrained in the prevailing current and transported accordingly (Wolanski et al., 2003). As flow velocities increase, residence time of the plume over the reef flat decreases, limiting time for small particles to settle out of the water column and controlling the sedimentation rate, even for the same concentration and magnitude of different plumes. ") 

## Picture of sediment plume
if 'Bay_sedplume' in locals():
    tables_and_figures.add_picture(Bay_sedplume['filename'],width=Inches(6))
    add_figure_caption(Bay_sedplume['fig_num']," A) Image of the embayment on a typical, rain-free day. The darker areas of the bay are live coral, and the light areas are deeper pools with carbonate sand bottom. B) Image of a flood plume (2/21/14) in the northern portion of the bay following a heavy precipitation event. Plumes usually persist for several hours, and rarely are seen after 24h due to the flushing of water through the deep channel and out to sea.")  

document.add_paragraph("Faga'alu Bay is situated on the western side of Pago Pago Harbor where the surrounding high topography blocks wet-season northerly winds from October-April, but the bay is exposed to dry-season southeasterly tradewinds and accompanying short-period wind waves during May-September. Faga'alu is characterized by a semi-diurnal, microtidal regime where parts of the shallow reef crest and reef flat are exposed at extreme low tides (<0 m MSL). Given that the reef crest is exposed at low tide, cross-reef transfer of wave energy and water flow is strongly dependent on the tidal stage and wave setup. Faga'alu is only open to a narrow window (south-southeast) of swell directions, and swells approaching from a southerly angle must refract to the west, reducing their energy. Offshore significant wave heights (Hs) from southerly and southeasterly directions are generally less than 2.5 m and rarely exceed 3.0 m. Peak wave periods (Tp) are generally about 9 s or less, rarely exceed 13 s but occasionally reach 25 s during austral winter storms (Thompson and Demirbilek, 2002). Vetter (2013)  recorded peak significant wave heights on the fore reef in Faga'alu up to 1.7 m, but wave heights greater than 1.0 m were rare.")

document.add_paragraph("Little data on current circulation around Tutuila is available, and almost no data on circulation over the reef flat has been collected (CH2M HILL, 1984; Jacob et al., 2012; Wiles et al., 2012). Militello et al. (2003) modeled wave-induced setup on reef flats and developed stage-frequency relationships for large tropical storms and hurricanes in American Samoa. Thompson and Demirbilek (2002) characterized offshore wave climate from data collected near Western Samoa (1985-1990), and used numerical modeling to simulate wave propagation dynamics in Pago Pago Harbor. Vetter et al (2013)  deployed wave/tide gauges in Faga'alu Bay on the southern forereef and reef flat, and an ADCP in the 'ava , for one year (2012-2013). Vetter (2013) concluded flow dynamics in the bay were predominantly forced by waves breaking over the southern reef crest, and the wave influence increased linearly with tide height. Using an estimate of total lagoon volume, Vetter (2013) calculated flushing time varied from thirty-three hours during low wave height, to less than two hours during conditions when peak significant wave height was 1.6 m, and mean current speed out of the main channel was 0.14 m/s. ")
  
    
#### METHODS
methods_title = document.add_heading('METHODS',level=2)

document.add_paragraph("To characterize the spatial pattern of flows and determine the relationship between forcing conditions and residence time of water over the reef flat in Faga'alu Bay, a combination of Eulerian and Lagrangian measurements was used. Lagrangian drifters were used to collect spatially distributed data on flow velocities, in conjunction with Eulerian current profilers at fixed locations to collect long-term data in relation to forcing conditions.")

## Eulerian measurements (ADCP's)
document.add_heading('Eulerian Measurements',level=3) 

document.add_paragraph("Three Nortek Aquadopp 2-MHz acoustic current profilers recorded tide, wave, and current data at three locations on the reef flat in Faga'alu for one week (Figure "+Study_Area_map['fig_num']+"). The profilers were attached to cinder block anchors and placed on sand or rubble patches amongst the corals, as deep as possible to maintain adequate water levels over the profiler during low tide (Figure "+Drifter_ADCP_pics['fig_num']+"). The profilers collected 580 current samples at 2 Hz every 10 min and 2048 wave samples at 2 Hz every 60 min. On the northern reef, the water level dropped below the minimum blanking distance of the current profilers at low tides, and flow was assumed to be nearly zero during these times given the relatively low water depth relative to the height of the corals.") 

## Pics of drifters and ADCP
if 'Drifter_ADCP_pics' in locals():
    tables_and_figures.add_picture(Drifter_ADCP_pics['filename'],width=Inches(6))
    add_figure_caption(Drifter_ADCP_pics['fig_num'],"Five GPS-logging drifters and three acoustic current profilers were deployed on the reef flat in Faga'alu. TOP: Images of the shallow-water drifters on land, and deployed in the field. BOTTOM: Images of the acoustic current profilers deployed on the southern reef flat (AS1).")

## Lagrangian measurements (GPS-logging drifters)
document.add_heading('Lagrangian Measurements',level=3)

document.add_paragraph("Drifters for shallow coral reef environments need to be shallow enough to avoid interaction with corals, deep enough to not be affected by the surface movements, extend high enough to be visible but not high enough to be affected by winds, and finally, rugged enough to sustain the impact of a breaking wave onto the reef in the event it is entrained in the surf zone. Due to Faga'alu Bay's relatively small area (0.25 km2), high-density drifter data could be collected with a small number of drifters (n = 5) and field personnel (n = 1). Five drifters were designed and constructed with materials available on-island, from PVC tubing and plastic sheeting, with a small waterproof housing for a HOLUX M1000 GPS recorder, and a float collar to maintain upright orientation (Figure 4). The fins of the drifters were roughly 30 cm wide and 18 cm in height, constructed of 1.3 cm diameter PVC with holes drilled to flood the piping and compensate for the buoyancy of the pipe; the GPS logger was housed in a PVC housing. The drifters were transported to the launch zones and retrieved using a stand-up paddle board.")

document.add_paragraph("Drifter position data was recorded by the GPS logger at 5 s intervals and resampled to 1 min intervals to reduce signal noise. Drifters were allowed to drift until they exited the 'ava channel, but tracks were limited to 1 hr for analysis. Drifter speed and direction were calculated using a forward difference scheme on the drifter locations (Davis, 1991; MacMahan et al., 2010) and gridded in 100 m x 100 m bins for analyses.")


## Ancillary Data
document.add_heading('Ancillary Data',level=3) 

document.add_paragraph("The instrument deployments were timed to capture end-member forcing conditions that characterize the study area. The end member conditions time ranges were defined post-deployment using modeled and in situ wave, wind, and tide data following the methodology described by Presto et al. (2006).") 
## Wave data
document.add_paragraph("Incident wave conditions were recorded by a NIWA Dobie-A wave/tide gauge (DOBIE) deployed on the southern reef slope at a depth of 10 m (Figure "+Study_Area_map['fig_num']+"). The DOBIE sampled a 512s burst at 2 Hz every hour. The DOBIE malfunctioned and recorded no data coinciding with the ADCP deployment, but compared well (not shown) with NOAA WaveWatchIII (WW3; REFERENCE) modeled data on swell height and direction for the recorded data (Hoeke et al., 2011). WW3 model data, calibrated to wave data recorded in situ by the DOBIE wave/tide gauge, were used to define forcing during the ADCP and drifter deployments.")
## Wind data
document.add_paragraph("Wind speed, wind direction, barometric pressure, and precipitation were recorded at 15 min intervals using a Davis VantagePro weather station installed near the stream mouth, approximately 5 m above sea level on a pole mounted to a building (Figure "+Study_Area_map['fig_num']+"). Meteorological and tide data were also recorded at NOAA's National Data Buoy Center's NSTP6 station (REFERENCE) located approximately 1.8 km north of Faga'alu. Wind speed, wind direction, barometric pressure, and tidal elevation data were ralso ecorded at NSTP6 at 6 min intervals. For this study, wind conditions are sufficiently described qualitatively so the topographic effects on wind speed and direction recorded at the stations are considered inconsequential.")


## Analytical Methods
document.add_heading('Analytical Methods',level=3)

document.add_paragraph("Data from the drifters and current profilers was subset by end-member forcing condition, and two techniques were used to compare the drifter results with the profiler results: Empirical orthogonal functions (EOF) and progressive vectors of cumulative flow. Spatially distributed water residence times were calculated for end-member conditions from drifter data only.")
## Progressive Vectors
document.add_paragraph("Progressive vectors, which are cumulative summations of flow assuming spatial homogeneity, were generated for the profiler data following the methodology used by Storlazzi et al. (2006) and were compared to simultaneous 1 hr tracks of drifter data. A series of 1-h progressive vector diagrams of projected cumulative flow were computed from ADCP data collected during each end member condition period, and compared to drifter tracks to demonstrate the usefulness of drifters for illustrating spatially variable flows compared to fixed current profilers. The progressive vectors from the current profilers illustrate the flow variability at those fixed points during the 1 hr drift duration. However, progressive vectors are calculated assuming spatial homogeneity of the flow, causing them to move onshore in some instances.")
## EOF's, mean current, residence time
document.add_paragraph("EOF principal axes, variance ellipses, and mean flow vectors were calculated for spatially binned drifter data (100 m x 100 m) (MacMahan et al., 2010) and profiler data. Where drifters did not travel through a spatial bin, no EOF or residence time could be calculated .EOF's and mean vectors from drifters and profilers were compared to determine if the short-term observations from the drifters adequately described the flow characterized by the long-term current profilers, and characterize the spatial variability of flow over the reef flat. Mean flow vectors were used to calculate water residence time over the reef under different forcing conditions. Mean flow vectors from the current profilers and driftes were compared to assess whether the short term drifter deployments agreed with estimates from the long-term current profilers. ")
#### TODO describe res time calculations for ADCP



#### RESULTS ####
results_title = document.add_heading('RESULTS',level=2)
## Forcing: Wave, wind, tide during ADCP deployment
document.add_heading('Oceanographic and Meteorologic Forcing ',level=3)

### Forcing data
if 'Forcing_data_timeseries' in locals():
    tables_and_figures.add_picture(Forcing_data_timeseries['filename'],width=Inches(6))
    add_figure_caption(Forcing_data_timeseries ['fig_num'],caption="Time series of physical forcing data was used to define end-member periods for analysis. Forcing data included: a) Tide stage, b) wind speed, c) wind direction from NDBC station NSTP6, d) wave height, e) wave period, and f) wave direction from NOAA WW3. Day 47=16 Feb 2014, Day 54=23 Feb 2014. Forcing ")
    
document.add_paragraph("During the period of overlapping ADCP and intensive drifter deployments, 2014 Year Day (YD) 47-55 (15-23 February 2014), a large range of tide, wind, and wave conditions was sampled including a strong onshore wind event, a high southeast groundswell, and weak winds from variable directions where tidal forcing was dominant (Figure "+Forcing_data_timeseries ['fig_num']+"). Based on this wide range of forcing conditions, the sampling period can be separated into three distinct end-member forcings: 1) Small waves and strong onshore winds ('WIND') during 2014 Year Day (YD) 47-49; 2) Small waves and weak winds ('TIDE') during YD 50-51; and 3) Large waves and weak winds ('WAVE') during YD 52- 55 (Table "+Endmember_table.table_num+"). During WIND, average wind speed reached a maximum of 9.7 m/s with maximum gusts of 28 m/s from the northeast to southeast on YD 48. These wind conditions are typical of average wind conditions observed during the winter tradewind season. During TIDE, wind speeds were low to moderate (3-6 m/s) and wind directions were variable, which is typical during the summer wet season. During WAVE, maximum wave height reached 1.3 m on YD 52, which is near the annual maximum height expected for this location (O. Vetter, unpublished data).")

## Table: End member definitions
if 'Endmember_table' in locals():
    dataframe_to_table(df=Endmember_table,table_num=Endmember_table.table_num,caption="End member periods",fontsize=9)
document.add_paragraph("**Note: Local time is UTC-11 so local dates are actually one day earlier (e.g. Tide=2/18-2/19 Local time)")

## Eulerian Measurements (ADCP)    
document.add_heading('Eulerian Measurements',level=3)

document.add_paragraph("Current profilers at three locations on the reef flat recorded water flow for one week during YD 47-55. On the northern reef flat (AS3) the water level dropped below the minimum blanking distance of the ADCP at low tides (Figure "+ADCP_measurements['fig_num']+"), and flow wass assumed to be nearly zero during these times given the relatively low water depth. The highest velocity flows during all forcing conditions were observed at AS1 on the sourthern reef, adjacent the section of the reef crest that experiences the most breaking waves, even during small wave conditions.")

## ADCP measurements
if 'ADCP_measurements' in locals():
    tables_and_figures.add_picture(ADCP_measurements['filename'],width=Inches(6))
    add_figure_caption(ADCP_measurements['fig_num'],caption="Current profilers at three locations on the reef flat recorded water flow for one week. Time series of tide (a) and water flow measured by the acoustic current profilers at the southernmost point, AS1 (b), the central part of the reef, AS2 (c), and northern reef, AS3 (d). At AS3 (d), water depths at low tide were too shallow to measure flow data. Note the variations in current speeds both in space and time due to the different forcing conditions.")     
    
document.add_paragraph("The highest velocity flow was observed over the southernmost part of the reef (AS1) and was oriented predominantly in a northwesterly direction, indicating the strong influence of even small breaking waves over the reef crest. The portion of the reef crest adjacent AS1 receives the most wave energy in Faga'alu, and flow from the reef further to the south of AS1 is open to an even wider window of wave directions from the south and southwest. High speed currents were also measured on the southern reef adjacent to the 'ava at AS2, though not as consisently as at AS1, and predominantly in a southwesterly direction, reflecting the relative orientation of the reef crest. Whereas the flow at AS1 was deflected by the shore, turning the cross-reef flow of water north toward the deeper parts of the bay and the 'ava channel, the flow at AS2 was primarily shoreward into the deep pools in the inshore side of the reef flat. Flow data at AS1 also illustrate the modulating effect of tidal stage on flow speed over the reef flat similar to that observed by Storlazzi et al. (2004) and Presto et al. (2006). During YD 52-55, a decrease in flow speed was observed that coincided with the low tide. As the tide level decreased, less wave energy was able to propagate over the reef crest and friction and turbulence over the reef increases. This effect was observed, but smaller in magnitude, at AS2 because the mean water depth is greater and the height of the corals is less at AS2.")

document.add_paragraph("Flow speeds and direction at AS1 were fairly consistent during all endmember conditions, whereas flow was more variable at AS2 and varied more with increasing wave height. As the wave direction rotated more to the east (Figure "+Forcing_data_timeseries['fig_num']+"), more wave energy was directly incident upon the northern portion of the southern reef. Under tidal influence or offshore winds in the absence of strong waves, there is potential for cross-reef flow directions.  When the waves were larger, the flow speeds at AS2 were higher and oriented predominantly towards shore. Flow velocities were most variable at AS3 on the northern reef, and while flow speed and direction at AS1 and AS2 were predominantly influenced by incident wave conditions, flow at AS3 did not show strong correlation with any of the endmember forcing conditions.")
## explain this better: more wave energy was directly incident upon the northern portion of the southern reef. Under tidal influence or offshore 

## Lagrangian Measurements (GPS-logging Drifters)
document.add_heading('Lagrangian Measurements',level=3)
document.add_paragraph("Thirty drifter deployments were conducted from January to February 2014, with 22 of those deployments coinciding with the ADCP deployments during YD XX-YY (February 15-23; Table 2). Five drifters were released from the same five launch zones within a 10-m time frame at the beginning of each deployment, and allowed to drift until they exited the offshore end of the 'ava channel at Pago Pago Harbor (Figure "+Drifter_deployment_table.table_num+"). Five drifters were released from the same five launch zones within a 10-m time frame at the beginning of each deployment, and allowed to drift until they exited the offshore end of the 'ava channel at Pago Pago Harbor (Figure "+Study_Area_map['fig_num']+"). Three general spatial patterns were evident, as shown in Figure "+ALL_Drifter_tracks['fig_num']+": 1) Faster onshore flow speeds (lower residence times) over the southern reef flat; 2) Slower, more variable currents (longer residence times) over the deeper inshore portion of the southern reef flat and inner portion of the embayment that converge on the inshore end of the 'ava channel; and 3) Faster offshore current speeds (lower residence times) over the offshore end of the 'ava channel. Only a few drifters traveled seaward across the reef crest, mainly exiting through a subtle depression in the southern reef crest, and these only occurred at high tide under calm wave and wind conditions. Other anomalous drifter tracks show where drifters were entrained in the surf zone at the reef crest and quickly exited back out to sea in the far northeast portion of the study area.")

## Table: Drifter deployments dates and conditions
if 'Drifter_deployment_table' in locals():
    dataframe_to_table(df=Drifter_deployment_table,table_num=Drifter_deployment_table.table_num,caption="Drifter deployment dates and conditions. Red numbered Deployments coincide with ADCP deployment",fontsize=9)
    document.add_paragraph("")    
    
if 'ALL_Drifter_tracks' in locals():
    tables_and_figures.add_picture(ALL_Drifter_tracks['filename'],width=Inches(6))
    add_figure_caption(ALL_Drifter_tracks['fig_num'],caption="Map of all drifter tracks, colored by speed, recorded during the experiment.")
    
## Comparing Eulerian and Lagrangian Measurements
document.add_heading('Comparison of Eulerian and Lagrangian Measurements',level=3)

# Progressive Vectors
document.add_heading('Progressive Vectors',level=4)
document.add_paragraph("The progressive vectors for AS1 and AS2 show little variation in flow direction, indicating the flow velocity was relatively consistent (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). The progressive vectors for AS3 are much more erratic, and travel relatively shorter distances due to the lower flow speeds observed over the northern reef. The progressive vectors for AS3 are much more erratic, and travel relatively shorter distances due to the lower flow speeds and more variable flow directions observed over the northern reef. Compared to the progressive vectors, the drifter tracks show the spatial heterogeneity of the flow pattern as the water flows over the reef flat, turns parallel to shore and into the 'ava channel  (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). Under tidal forcing the drifter tracks over the northern reef are highly erratic, but travel longer distances than under strong onshore winds (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"b). This indicates that under tidal forcing water movement is variable over the reef but strong winds push water into the northwest corner of the embayment, piling up water over the northern reef and increasing residence time. Drifter tracks crossing the reef crest are observed over the southern reef under tidal forcing, in the absence of breaking waves that would strongly force water flow across the reef, preventing seaward flow. Under strong wave conditions (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e), a more coherent, clockwise flow pattern is observed over both the northern and southern reef as large breaking waves force large amounts of water onto the reef flat, driving flow quickly across the southern reef flat and into the main channel. Despite waves breaking on the the northern reef crest, it appears the flow across the southern reef and into the main channel influences an overall eastward flow over the northern reef and out the main channel (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e).")

if 'Progressive_Vectors_ADCP_vs_Drifters' in locals():
    tables_and_figures.add_picture(Progressive_Vectors_ADCP_vs_Drifters['filename'],width=Inches(6))
    add_figure_caption(Progressive_Vectors_ADCP_vs_Drifters['fig_num'],caption="Progressive vectors calculated from ADCP data, compared to actual Lagrangian drifter tracks under different forcing conditions. ") 

# EOF's
## PCA Plots of all drifter data, in 100m bins, color ellipses by number of observations
document.add_heading('Empirical Orthogonal Functions (EOF)',level=4)

document.add_paragraph("EOF's and mean flow velocity were calculated from ADCP data collected during each end member condition period. Variance ellipses are more ellipsoid at AS1 and AS2, and more circular at AS3, under all forcing conditions. Similar to the progressive vectors, this indicates the current  is more unidirectional at AS1 and AS2, flowing in the direction of the main principal component axis. Currents at AS3 are more variable in direction and lower in magnitude, as indicated by the lower mean flow velocity arrows (Figure "+PCA_gridded['fig_num']+").")

## Gridded EOF by endmembers
if 'PCA_gridded' in locals():
    tables_and_figures.add_picture(PCA_gridded['filename'],width=Inches(6))
    add_figure_caption(PCA_gridded['fig_num'],caption="EOF's calculated from ADCP data, compared to EOF's calculated from spatially binned (100m x 100m grid cell) Lagrangian drifter data under different forcing conditions. Drifter EOF's are colored by number of observations to illustrate varying data density depending on grid cell.")    

document.add_paragraph("Drifter data was spatially binned and EOF's and mean flow velocity were calculated for each 100m x 100m grid cell (Figure "+PCA_gridded['fig_num']+"). Due to their spatial position relative to the flow pattern, some grid cells had a much higher number of observations, especially those grid cells in the middle parts of the bay. More observations suggests more certainty in observed patterns, while some of the outlying grid cells with a small number of observations may have been influenced by an anomalous drifter track. However, the overall pattern of drifter tracks is similar to the results from corresponding Eulerian results: Flow over the southern reef is driven by cross-shore wave-driven transport which flows northward to the main channel. However, while it may be hypothesized that water flows into the main channel and out to sea, the Eulerian data from the ADCPs' suggests all flow is into the bay. Finer resolution drifter data resolves the general counterclockwise flow from the southern reef, over the northern reef and out to sea. The drifter data also illustrates the decreased flow velocity near shore and in the deeper pools on the reef flat. The drifter data also illustrate the increase in flow velocity moving seaward in the main channel. Under both wave and tide forcing, the velocity steadily increases in the main channel, reaching a maximum at the reef crest. The same pattern is not evident under wind forcing, possibly due to wind driven flow being forced into the bay at the surface, but the data density is too low to be sure. Hench (2008) vertically binned ADCP data in Moorea showed that under low wave forcing surface currents were lower in the reef pass, and could reverse near the bottom. The increase in flow is either caused by the increasing volume of water contributed by the reef flats on either side or a narrowing of the channel cross-section. Either way the increase is notable for it's implications for placing a Eulerian ADCP at a fixed point in the channel, and using data from that one point to define flow for the whole bay.")


## Gridded velocity by endmembers
document.add_heading('Mean flow speed and direction in 100m gridded cells under Wind, Wave, Calm conditions',level=4)
document.add_paragraph("Drifter data was spatially binned and mean flow velocity was calculated for all drifter tracks under each forcing condition. Over the whole bay, mean flow velocity varied from 1-37 cm/s, 1-36 cm/s, and 5-64 cm/s under tidal, wind, and wave forcing, respectively. Vetter (2013) observed flow speed in the main channel of 1-60 cm/s, with a mean of 14 cm/s. Drifter observations in the gridcell corresponding to Vetter's (2013) ADCP location showed flow speeds of 1-30 cm/s wtih a mean of 8 cm/s, for all forcing conditions. Vetter's (2013) ADCP time series shows lower flow speeds in the channel Jan-April than duriung the more active tradewind season June-October so it is likely that the drifter deployments included more quiescent distribution of days than occur during the whole year. While one large swell event was sampled during the drifter deployments, these conditions appear to be more common during the year than were observed during the one intensive week of drifter deployments. Also, Vetter's (2013) ADCP data ampled the full depth of the water column, as opposed to just the surface current that could be affected by winds, especially when strong east winds blow into the bay. This suggests that perhaps Eulerian and Lagrangian methods are more comparable in shallow depths, where the drifter is influenced by a relatively larger portion of the water column.")

if 'Gridded_Velocity_endmembers' in locals():
    tables_and_figures.add_picture(Gridded_Velocity_endmembers['filename'],width=Inches(6))
    add_figure_caption(Gridded_Velocity_endmembers['fig_num'],caption="Drifter tracks and calculated mean velocity, colored by speed for different forcing conditions. Cells with no drifter observations are left empty.") 

document.add_paragraph("The overrall pattern of mean flow speeds and flow directions shows a strong clockwise circulation through the bay with higher flow speeds during wave forcing conditions, compared with tidal and wind forcing. The west-northwest flow directions over the southern reef remain nearly constant under all forcing conditions, but the flow speeds are highest under wave forcing and lowest under tidal forcing. Over the northern reef, however, mean flow directions are more variable, reversing and flowing towards the river mouth under strong onshore winds and tidal forcing. The drifter tracks for wind and wave forcing show nearly stationary drifter tracks over the northern reef, and only make alot of progress once they are entrained in the seaward flow of the main channel. ")


    
document.add_paragraph("")    

## Residence Times for 100m bin grid
document.add_heading('Residence Times from drifter observations', level=4)

document.add_paragraph("Residence times for 100m x 100m grid cells were computed from the mean flow speeds calculated from drifter data under different forcing conditions (Figure "+Gridded_ResidenceTime_endmembers['fig_num']+"). Residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.56-0.04 hr under tidal, wind, and wave forcing, respectively. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment.")

if 'Gridded_ResidenceTime_endmembers' in locals():
    tables_and_figures.add_picture(Gridded_ResidenceTime_endmembers['filename'],width=Inches(3))
    add_figure_caption(Gridded_ResidenceTime_endmembers['fig_num'],caption="Residence time calculated from mean velocity of drifters under endmember conditions")    
    
#### DISCUSSION
document.add_heading('Discussion',level=2)

document.add_paragraph(". It would seem that flow over the southern reef would flow directly into the main channel, however this flow is deflected away from the main channel, shoreward. This deflection is caused by wave energy refracting and surging into the main channel, pushing southward from the main channel onto the soouthern reef. Observations on the reef flat in Molokai, Hawaii, showed current speeds were faster where the reef is deeper and narrower (Curt D Storlazzi et al., 2006) but field observations at the proposed study site suggest the opposite; current speeds are rapid over the shallow reef crest, slowing significantly when reaching deeper pools in the reef and the main channel that bisects the reef.")

conclusion_text = document.add_paragraph("The bay-wide mean current speeds (residence times) varied from 1-37 cm/s (2.78-0.08 hr), 1-36 cm/s (2.78-0.08 hr), and 5-64 cm/s (0.56-0.04 hr) under tidal, wind, and wave forcing, respectively. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment. These circulation patterns cause the spatial pattern of suspended sediment plumes observed in timelapse imagery. The spatial flow pattern and longer residence times result in greater exposure (=intensity x duration) of the corals in these areas to sediment stress and likely causes the reduced coral health in these locations. ")

#### Acknowledgements
document.add_heading('Acknowledgements',level=2)
document.add_paragraph("This work was carried out in collaboration between San Diego State University and the US Geological Survey's Coral Reef Project. Funding was provided by a grant by the NOAA Coral Reef Conservation Program. A significant contribution of equipment and expertise was provided by the USGS Pacific Coastal and Marine Science Center. We would like to thank Dr. Michael Favazza for providing logistical support in the field.")

#### References
document.add_page_break()
document.add_heading('References')
document.add_paragraph('Add at the end, using Mendeley refs')

#### Table Titles
document.add_heading('Table Titles',level=2)
for title in table_titles:
    document.add_paragraph(title)
#### Figure Captions
document.add_heading('Figure Captions',level=2)
for caption in figure_captions:
    document.add_paragraph(caption)
    
#### Appendix
document.add_page_break()
document.add_heading('APPENDIX',level=2)
## Appendix stuff goes here...

## Save Document
document.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation.docx')
tables_and_figures.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation_tables_and_figures.docx')

## Clean up any open figures
plt.close('all')

