# -*- coding: utf-8 -*-
"""
Created on Wed Mar 18 06:26:25 2015

@author: Alex

this paper is different than the Fagaalu-SSY paper because the figures are combined with figures from a collaborator
in this case the figures are generated by other scripts and manually combined with the collaborators figures
these cannot be automated but the scripts have README's associated with the figures.

"""
#### Import modules
## Data Processing
import os
import numpy as np
import pandas as pd
#import math
import datetime as dt
import matplotlib.pyplot as plt
#### Plotting Tools
import matplotlib.pyplot as plt
import matplotlib as mpl
plt.ioff()
plt.close('all')

## Python docx
from docx import *
from docx.shared import Inches
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH

## Set Directories
git=True
if git==True: ## Git repository
    maindir = 'C:/Users/Alex/Documents/GitHub/Faga-alu-Bay-water-circulation/' 
    datadir=maindir+'Data/'
    trackdir = maindir+'Data/AllTracks/'
    GISdir = maindir+'Data/DriftersGIS/'
    figdir = maindir+'Figures/fromAlex/'
    dirs={'main':maindir,'data':datadir,'track':trackdir,'GIS':GISdir,'fig':figdir}
elif git!=True: ## Local folders
    datadir = 'C:/Users/Alex/Desktop/'
    trackdir = 'samoa/DRIFTERS/AllTracks/'


##  Create Document
document = Document()
tables_and_figures = Document()

######## SOME TOOLS
figure_captions = []
def add_figure_caption(fig_num=str(len(document.inline_shapes)),caption=''):
    manuscript_cap = document.add_paragraph("Insert Figure "+fig_num+" here")
    manuscript_cap = document.add_paragraph("Figure "+fig_num+". "+caption)
    manuscript_cap.paragraph_style = 'caption'
    
    #figs_cap = tables_and_figures.add_paragraph("Figure "+fig_num+". "+caption)
    figure_captions.append("Figure "+fig_num+". "+caption)
    return

table_titles = []
def dataframe_to_table(df=pd.DataFrame(),table_num=str(len(document.tables)+1),caption='',fontsize=11):
    ## Add a place holder in the manuscript
    manuscript_cap = document.add_paragraph("Insert Table "+table_num+" here")
    manuscript_cap = document.add_paragraph("Table "+table_num+". "+caption)
    manuscript_cap.paragraph_style = 'caption'
    
    ## construct table
    try:
        table = tables_and_figures.add_table(rows=1, cols=len(df.columns)) 
        ## Merge all cells in top row and add caption text
        table_caption = table.rows[0].cells[0].merge(table.rows[0].cells[len(df.columns)-1])
        table_caption.text = "Table "+table_num+". "+caption
        ## Add  header
        header_row = table.add_row().cells
        col_count =0 ## counter  to iterate over columns
        for col in  header_row:
            col.text = df.columns[col_count] #df.columns[0] is the index
            col_count+=1
        ## Add data by  iterating over the DataFrame rows, then using a dictionary of DataFrame column labels to extract data
        col_labels = dict(zip(range(len(df.columns)),df.columns.tolist())) ## create dictionary where '1  to  n' is key for DataFrame columns
        for row in df.iterrows():  ## iterate over  rows in  DataFrame
            #print row[1]
            row_cells = table.add_row().cells ## Add a row to the  table
            col_count  = 0
            for cell in row_cells: ## iterate over the columns in the row
                #print row[1][str(col_labels[col_count])]
                cell.text = str(row[1][str(col_labels[col_count])]) ## and plug in data using a dictionary to  get column labels for DataFrame
                col_count+=1
        ## Format Table Style  
        table.style = 'TableGrid' 
        table.style.font.size = Pt(fontsize)
        table.autofit
        #table.num = str(len(document.tables)+1)
    except:
        pass
    table_titles.append("Table "+table_num+". "+caption)
    return table
    
def add_equation(eq_table):
    t = document.add_table(rows=len(eq_table.rows),cols=len(eq_table.columns))
    t.rows[0].cells[1].text = eq_table.rows[0].cells[1].text
    t.rows[0].cells[2].text = eq_table.rows[0].cells[2].text   
    if len(eq_table.rows)>1:
        t.rows[1].cells[0].merge(t.rows[1].cells[2]).text = eq_table.rows[1].cells[0].text
    t.style = 'TableGrid'   
    t.autofit
    return t
###################################################################################################################################################################    


#### TABLES ###########################################################################################################################
table_count=0
def tab_count():
    global table_count
    table_count+=1
    return str(table_count)
    
## End member definitions
def Endmember_definitions_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    endmember_table = XL.parse('EndmemberDefn',header=0,index_col=0,parse_cols='A:D',parse_dates=False)
    endmember_table['End member']=endmember_table.index
    endmember_table = endmember_table[['End member','Year Day 2014', 'Gregorian Day (UTC)','Gregorian Day (Local)']]
    return endmember_table  
Endmember_table = Endmember_definitions_table()
Endmember_table.table_num = str(tab_count())    

## Empty holder
compare_drifters_ADCP_speed_res_time = pd.DataFrame()
compare_drifters_ADCP_speed_res_time.table_num = str(tab_count()) 

## Appendix
table_count=0   
## Drifter deployment dates
def Drifter_deployments_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    deployment_table = XL.parse('Table',header=1,index_col=0,parse_cols='C:P',parse_dates=False)
    deployment_table['Deployment'] = deployment_table.index
    deployment_table['Date'] = deployment_table['Date'].apply(lambda x: "{:%m/%d/%Y}".format(x))
    ## Tide start, end, movement
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft']*0.3048 #ft to m
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft'].round(1)
    deployment_table['Tide End m'] = deployment_table['Tide End ft']*0.3048 #ft to m
    deployment_table['Tide End m'] = deployment_table['Tide End m'].round(1)
    deployment_table['Tide movement m'] = deployment_table['Tide movement ft']*0.3048 #ft to m
    deployment_table['Tide movement m'] = deployment_table['Tide movement m'].round(2)
    ## Wind speed, gust direction
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg kts']*0.514 # kts to m/s
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg m/s'].round(1)
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max kts']*0.514 # kts to m/s
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max m/s'].round(0)
    deployment_table['Wind Direction Avg deg'] = deployment_table['Wind Direction Avg deg'].apply(int)
    ## Wave height
    deployment_table['Wave Height m'] = deployment_table['Wave Height m']
    ## Combine into table
    deployment_table= deployment_table[['Deployment','Year Day 2014 (local)','Start Time','End Time','Tide Start m','Tide End m','Tide movement m','Wind Speed Avg m/s','Wind Gust Max m/s','Wind Direction Avg deg','Wave Height m']]
    return deployment_table
Drifter_deployment_table = Drifter_deployments_table()
Drifter_deployment_table.table_num = str(tab_count())    


#### FIGURES ########################################################################################################################################################
figure_count=0
def fig_count():
    global figure_count
    figure_count+=1
    return str(figure_count)
    
## INTRODUCTION
#### Study Area Map
Study_Area_map = {'filename':maindir+'Figures/Maps/Drifter LZ ADCP.jpg', 'fig_num':str(fig_count())}

### Pics of Bay
Bay_sedplume = {'filename':maindir+'Figures/Pics/Bay clear and plume.png', 'fig_num':str(fig_count())}

### Pics of Drifters and ADCPs
Drifter_ADCP_pics = {'filename':maindir+'Figures/Pics/ADCP Drifter pics.png', 'fig_num':str(fig_count())}

### Forcing data
Forcing_data_timeseries = {'filename':maindir+'Figures/Forcing/AmSam_ADCPdrifter_Fig_3_forcing_lettered.jpg', 'fig_num':str(fig_count())}

### ADCP measurements
ADCP_measurements = {'filename':maindir+'Figures/ADCP measurements/Figure4_ADCP.png', 'fig_num':str(fig_count())}

### All Drifter tracks
ALL_Drifter_tracks = {'filename':maindir+'Figures/ALL drifter tracks/drifters_all_arrows_speed.png', 'fig_num':str(fig_count())}

### Progressive Vectors vs drifter tracks
Progressive_Vectors_ADCP_vs_Drifters = {'filename':maindir+'Figures/Progressive Vectors/Figure6_progvec_driftervelocity_lettered.png', 'fig_num':str(fig_count())}

## Gridded PCA by endmember
PCA_gridded = {'filename':maindir+'Figures/Gridded PCA endmembers/Figure7_paxes_map_OMC_lettered.png', 'fig_num':str(fig_count())}

#### Gridded velocity by endmember
#Gridded_Velocity_endmembers = {'filename':maindir+'Figures/Gridded velocity endmembers/Fagaalu_velocity-endmembers.png', 'fig_num':str(fig_count())}

### Gridded residence time by endmember
Gridded_ResidenceTime_endmembers = {'filename':maindir+'Figures/Residence Times/Fagaalu_gridded_residence_time_lettered.png','fig_num':str(fig_count())}

###### EQUATIONS ############################################################################################################################################
equation_count=0
def eq_count():
    global equation_count
    equation_count+=1
    return str(equation_count)
    
#Equations = Document(maindir+'/Manuscript/Equations.docx').tables
#
### SSYev = Q*SSC 
#Equation_one = Equations[0].table
#Equation_one.eq_num = eq_count()

##### APPENDIX #################################################################################################################################
#### Appendix
table_count,figure_count,equation_count=0, 0, 0
### Appendix Table One
#Appendix_table_one = table_function() ## function to create table data
#Appendix_table_one.table_num =str(tab_count())

############################################################################################################################################

#### TITLE
title_title = document.add_heading('TITLE:',level=1)
title_title.paragraph_format.space_before = 0
title = document.add_heading("Eulerian and Lagrangian measurements of flow and residence time on a fringing reef flat embayment, American Samoa",level=1)
title.paragraph_format.space_before = 0
## Authors
document.add_heading('Authors:',level=3)
document.add_paragraph("Messina, A.M.a*, Storlazzi, C.D.b, Cheriton, O.M.b, Biggs, T.W.a")
document.add_paragraph("a San Diego State University, Department of Geography, San Diego, CA 92182, amessina@rohan.sdsu.edu, +1-619-594-5437, tbiggs@mail.sdsu.edu, +1-619-594-0902")
document.add_paragraph("b US Geological Survey, Pacific Coastal and Marine Science Center, Santa Cruz, CA 95060, cstorlazzi@usgs.gov, +1-831-460-7521, ocheriton@usgs.gov, +1-831-460-7579")

document.add_paragraph("scripted terms: a, b, km2")
#### ABSTRACT
abstract_title = document.add_heading('ABSTRACT',level=2)
abstract_title.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER
abstract = document.add_paragraph("Hydrodynamic processes on coral reefs are important for nutrient cycling, larval dispersal, temperature variability, and understanding the impacts of terrestrial sediment, nutrients, and contaminants from adjacent disturbed watersheds on coral reef ecosystems. In order to understand the spatial and temporal variability in flow velocities and the resulting residence time of water in the fringing coral reef flat-lined embayment of Faga'alu, on the island of Tutuila in American Samoa, data from acoustic current profilers and ocean surface current drifter deployments were combined with meteorologic data and numerical wave model results. These data and model results, collected over nine days, made it possible to evaluate the relative contribution of tidal, wind, and wave forcing on the flow patterns and resulting residence times of water masses over the reef. Mean residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.55-0.04 h under tidal, wind, and wave forcing, respectively; the lowest residence times were on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment near the streammouth. The observed spatial flow pattern suggests increased sediment discharge from human disturbance is deflected over the northern reef where sediment stress on corals is increased relative to the southern reef. These results demonstrate the applicability of a hybrid Lagrangian-Eulerian measurement scheme to understand spatially distribued and temporally extensive flow patterns and thus residence time in geomorphically-complex embayments that characterize many reef-lined coasts.")

## Keywords
document.add_heading('KEYWORDS:',level=3)
document.add_paragraph("coral reefs, drifters, Water circulation, Residence time")

#### INTRODUCTION
introduction_title = document.add_heading('INTRODUCTION',level=2)
document.add_paragraph("Hydrodynamic conditions, including the residence time of waters over the reef flat, are a primary control on sediment dynamics in fringing reef embayments (Draut et al., 2009; Storlazzi et al., 2009 ), and are important for other biologically important processes like nutrient cycling, larval dispersal, and temperature regimes (Falter et al., 2004; Wyatt et al., 2012). Spatially distributed flow patterns under variable forcing conditions are logistically difficult to quantify, so conservation planning and remediation studies are currently done with coarse estimations of pollutant discharge and distance-based plume models (Klein et al., 2012). An improved understanding of the spatial and temporal variability in flow speeds, flow directions, and residence times of water over corals is needed for understanding sedimentation patterns and impacts to coral health. ....seems like it needs one more sentence here...")

document.add_paragraph("By influencing orbital velocities, bed shear stress, and suspended sediment transport, current circulation is a strong control on the spatial distribution of deposition, resuspension, and dispersal of terrigenous sediment discharged to reefs (Hoitink and Hoekstra, 2003; Storlazzi et al., 2004; Presto et al., 2006; Hoeke et al., 2013). Hydrodynamic conditions control sediment accumulation in two ways: by limiting primary deposition, and by resuspending and advecting previously deposited sediment. Following large or intense storm events, sediment-rich freshwater is discharged into reef-fringed bays and advected seaward over the reef by momentum in a thin surface layer. This sediment-rich layer significantly attenuates photosynthetically active radiation and transports fine sediment over the reef where it can settle out of the water column and damage corals. Although the hypopycnal surface plume is able to move counter to prevailing ocean currents (upcurrent) by sliding over denser seawater, as sediment particles settle they are entrained and transported in the prevailing current (Wolanski et al., 2003). As flow velocities increase, residence time of the plume over the reef flat is decreased, limiting time for small particles to settle out of the water column. In reef environments where shallow reef crests limit the propagation of incoming surface wave energy, wave action alone may be insufficient to resuspend and disperse sediment, but in combination with wave- or wind-driven currents, orbital velocities may reach critical shear stress for sediment resuspension and dispersal (Ogston et al., 2004; Hoeke et al., 2013).")

document.add_paragraph("Studies in various coral reef environments adjacent high islands showed current speeds, directions, and residence times over reef flats are controlled by wave, wind, and tidal forcing, depending on the orientation and shape of the reef, relative to the prevailing wave, wind, and tidal climates (Hench et al., 2008; Hoeke et al., 2011; Presto et al., 2006; Storlazzi and Field, 2008; Storlazzi et al., 2004). Variations in reef morphology relative to the orientation of the dominant meteorological and oceanographic forcing can generate heterogeneous waves and currents over relatively small (hundreds of meters) spatial scales, unlike those observed along relatively linear sandy shorelines (Storlazzi et al., 2009; Hoeke et al., 2011, 2013). Buoyancy forcing from hypopycnal river floods is generally ignored or considered inconsequential due to their rarity and short duration relative to other forcings (Hench et al., 2008; Hoeke et al., 2011). Current speeds and patterns over reefs exposed to remotely-generated groundswells are generally dominated by wave forcing (Hench et al., 2008; Hoeke et al., 2011; Vetter et al., 2010), whereas wind forcing is dominant for reefs protected from groundswells (Presto et al., 2006). Tidal elevation modulates both wave-driven currents by controlling the reef crest depth and subsequent wave energy propagation into the reef flat, and wind-driven currents by regulating water depth for wind-driven surface wave development (Presto et al., 2006). Reef flat currents in wave-driven environments exhibit a pattern of rapid, cross-shore flow near the reef crest that slows moving shoreward and turns along-shore towards a deep channel where water returns seaward (Hench et al., 2008; Lowe et al., 2009; Wyatt et al., 2010). In wind-driven systems, current directions are more predominantly in the direction of the wind with possible cross-shore exchange from the reef flat to the forereef (Storlazzi et al., 2004).")

## SHORTEN AND COMBINE THIS
document.add_paragraph("Water flow can be quantified in two ways: 1) the Lagrangian perspective observes an individual fluid parcel as it moves through space and time, 2) the Eulerian perspective observes flow past one or more fixed locations over time. Eulerian methods are well-suited to characterizing flows over long periods and a large range of forcing conditions by using bottom-mounted instruments to record wave height and period, current speed and direction, and/or tidal elevation (Presto et al., 2006; Storlazzi et al., 2009). Collecting high spatial resolution data on hydrodynamic processes using strictly Eulerian methods is expensive and logistically difficult (Storlazzi et al., 2006; Storlazzi et al., 2004), so other methods incuding hydrodynamic models, remote sensing, and Lagrangian methods have been used. Hydrodynamic computer models can predict spatially distributed flow (Hoeke et al., 2011), but these models typically require accurate bathymetry, detailed forcing data, and significant modeling expertise (Hoeke, 2010; King et al., 2012; Wolanski et al., 2009). Imagery-based remote sensing is useful to map the temporal and spatial distribution of flood plume boundaries (Klemas, 2012; Warrick et al., 2007), but even high resolution imagery may not quantify the underlying current circulation, which is a strong control on sediment transport. Instead, Lagrangian methods including the use of GPS-tracking drifters have been used to map flow patterns in coastal areas, compare to Eulerian flow descriptions (Storlazzi et al., 2006; Storlazzi et al., 2004; Wyatt et al., 2012) or validate hydrodynamic computer models (Ouillon et al., 2010). Research on rip currents in beach surf zones have shown the ability to capture synoptic measurements of small-scale flow structures and patterns by deploying large numbers of GPS-logging drifters to collect high-density observations of flow velocities (Johnson et al., 2003; MacMahan et al., 2010). While deploying a fleet of GPS-logging drifters has yielded synoptic measurements of water movement in surf zones near linear, sandy beaches, it has not been attempted in a shallow reef environment.")

document.add_paragraph("While Lagrangian measurements provide spatially explicit data on the flow field, drifter studies in nearshore environments are typically limited in number of drifters, number of deployments, and the range of oceanic and meteorological conditions experienced during deployments, making it uncertain whether they describe the dominant patterns, or short-lived anomalies (Storlazzi et al., 2006; Wyatt et al., 2010). Storlazzi et al., (2006) successfully combined Eulerian and Lagrangian methods by comparing Lagrangian drifter tracks with progressive vectors of cumulative flow calculated from Eulerian current meters to determine if short-term observations from drifters were representative of the dominant patterns. This approach yields spatially distributed flow data from the Lagrangian drifters, within the context of the longer time series of flow forcing from the Eulerian methods.")

## You now need a paragraph that wraps it all up. It needs to say, 
## â€œWell, because of these data/knowledge gaps we just described, we did x, y, and z to try to understand a, b, and c, etc.
#document.add_paragraph("Since it is known that hydrodynamic conditions control sediment accumulation and impact coral health, it is desirable to characterize spatially distributed flow patterns at the study site in relation to wave, wind, and tide forcings. For this study, Eulerian current profilers were used to characterize flow at fixed points on the reef flat in relation to long-term forcing conditions, and provide context for short-term, spatially distributed flow measurments from Lagrangian drifters.") 
document.add_paragraph("Since water residence time is critical to sediment dynamics and coral heath, what is the water residence time over the Faga'alu reef flat and how does it change under wave, wind and tidal forcing? To address this main research question we compared the spatially extensive Lagrangian measurements with the temporally extensive Eulerian measurements to calculate spatially distributed water residence time under different 'end-member' forcing conditions: tide, wind, wave.")

#### MATERIALS and METHODS
study_area_title = document.add_heading('MATERIALS AND METHODS',level=2)

#### STUDY AREA
study_area_title = document.add_heading('STUDY AREA',level=3)

## Study Area map
if 'Study_Area_map' in locals():
    tables_and_figures.add_picture(Study_Area_map['filename'],width=Inches(6))
    add_figure_caption(Study_Area_map['fig_num'],"Data collection locations in Faga'alu Bay. Wind speed and direction were recorded at the weather station (Weather Station), acoustic current profilers were deployed at three locations (ADCP) for one week to measure current speed and direction, and GPS-logging drifters were deployed thirty times (January to March, 2014) from five launch zones (Drifter Launch).")
# Description of the physical reef
document.add_paragraph("Faga'alu Bay, on the island of Tutuila, American Samoa (14.290 S, 170.677 W) is a V-shaped, reef-fringed embayment at the mouth of a small (2.48 km2), steep-sided watershed (Figure "+Study_Area_map['fig_num']+"). The reef is characterized by a shallow reef flat extending from just off the shore to the reef crest, where it then descends nearly vertically to the deep waters of Pago Pago Bay. Wave breaking is constrained to the shallow reef crests, the transitions between the steeply-sloping fore reef and the roughly horizontal reef flats.  Near the reef crest, the reef flat is cemented reef pavement, but near the shore in the southern backreef there are areas of deeper (1-5m) pools. An anthropogenically altered, vertical-walled, 5-15 m deep paleo-stream channel (ava) extends from the mouth of Faga'alu Stream eastward to Pago Pago Bay; this ava channel divides the reef into a larger southern and a smaller northern section. NOAA surveys in 2013 found coral coverage varies from <10% on the degraded northern reef, to >50% on the more intact southern reef (Vargas-Angel, unpublished). ")
# Description of prevailing wind, wave and tide conditions
document.add_paragraph("Faga'alu Bay is situated on the western side of Pago Pago Bay where the surrounding high topography blocks wet-season northerly winds from October-April, but the Bay is exposed to dry-season southeasterly tradewinds and accompanying short-period wind waves during May-September. Faga'alu Bay is characterized by a semi-diurnal, microtidal regime where parts of the shallow reef crest and reef flat are exposed at extreme low tides (<0 m MSL). Given that the reef crest is exposed at low tide, cross-reef transfer of wave energy and water flow is strongly dependent on the tidal stage and wave setup. Faga'alu Bay is only open to a narrow window (south-southeast) of swell directions, and swells approaching from a southerly angle must refract to the west, reducing their energy. Offshore significant wave heights (Hs) from southerly and southeasterly directions are generally less than 2.5 m and rarely exceed 3.0 m. Peak wave periods (Tp) are generally about 9 s or less, rarely exceed 13 s, but occasionally reach 25 s during austral winter storms (Thompson and Demirbilek, 2002). During 2013, O. Vetter (unpublished data) recorded peak significant wave heights on the fore reef in Faga'alu up to 1.7 m, but wave heights greater than 1.0 m were rare.")
# Prior work/data
document.add_paragraph("The only available data on current circulation around Tutuila was found in government and consultant reports, and no data on circulation over the reef flat has been collected (CH2M HILL, 1984; Jacob et al., 2012; Wiles et al., 2012). Militello et al. (2003) modeled wave-induced setup on reef flats and developed stage-frequency relationships for large tropical storms and hurricanes in American Samoa. Thompson and Demirbilek (2002) characterized offshore wave climate from data collected near Western Samoa (1985-1990), and used numerical modeling to simulate wave propagation dynamics in Pago Pago Harbor. Vetter (unpublished)  deployed wave/tide gauges in Faga'alu Bay on the southern forereef and reef flat, and an ADCP in the ava , for one year (2012-2013). Vetter (unpublished) concluded flow dynamics in the bay were predominantly forced by waves breaking over the southern reef crest, and the wave influence increased linearly with tide height. Using an estimate of total lagoon volume, Vetter (unpublished) calculated flushing time varied from 2-33 h with wave heights of 0-1.6 m, and mean current speed out of the ava channel was 0.14 m/s.")
## Picture of sediment plume
if 'Bay_sedplume' in locals():
    tables_and_figures.add_picture(Bay_sedplume['filename'],width=Inches(6))
    add_figure_caption(Bay_sedplume['fig_num']," Faga'alu Bay under storm and non-storm conditions. a) Image of the embayment on a typical, rain-free day. The darker areas of the bay are live coral, and the light areas are deeper pools with carbonate sand bottom. b) Image of a flood plume (2/21/14) in the northern portion of the bay following a heavy precipitation event: 51 mm in 2 h. Plumes usually persist for several hours, and rarely are seen after 24h due to the flushing of water through the ava channel and out to sea.")  

# Interaction of stream, currents, and sedimentation
document.add_paragraph("The timing of hydrodynamic conditions over the reef flat and sediment discharge during storms significantly controls sediment deposition, and is critical for understanding the impact on coral health from terrigenous sediment. Faga'alu Stream drains 1.86 km2 of the total watershed adjacent to Faga'alu Bay and discharges large amounts of suspended sediment during storm events, mainly due to naturally high sediment yield from the steep mountains and human disturbance in the village and an open aggregate quarry (Messina et al., in review). Following large or intense storm events, a thin surface plume of freshwater, with suspended sediment concentration (SSC) often exceeding 500 mg/L, is discharged from Faga'alu Stream into the northwest corner of Faga'alu Bay. Field observations show this plume is advected seaward, mainly over the northern reef and ava channel (Figure "+Bay_sedplume['fig_num']+"), where it significantly attenuates photosynthetically active radiation and deposits fine sediment (Messina et al., in review). For the same SSC and magnitude of flood plumes, increased flow velocities limit the residence time of the plume over the reef flat and hence the time for fine sediment to settle out of the water column.")
# USCRTF mitigation work 
document.add_paragraph("In August 2012, Faga'alu, was chosen by the US Coral Reef Task Force (USCRTF) as a priority watershed site for the Watershed Partnership Initiative (WPI). The WPI is an active effort of the USCRTF to reduce land-based sources of pollution (LBSP) by facilitating and enhancing coordination, partnerships, and contributions of US Federal agency resources and expertise to implement geographically specific integrated activities to reduce pollutant loads to coral reef ecosystems. Sediment mitigation efforts are underway to reduce sediment loading to Faga'alu Bay from the human-disturbed areas. ") 


#### METHODS
methods_title = document.add_heading('METHODS',level=3)

document.add_paragraph("To characterize the spatial flow pattern and determine the relationship between "+'endmember'+" forcing conditions and residence time of water over the reef flat in Faga'alu Bay, a combination of Eulerian and Lagrangian measurements was used. Lagrangian drifters were deployed to collect spatially distributed flow data and Eulerian current profilers were installed at fixed locations to collect long-term flow data in relation to forcing conditions.")

## Eulerian measurements (ADCPs)
document.add_heading('Eulerian Measurements',level=4) 

document.add_paragraph("Three Nortek Aquadopp 2-MHz acoustic current profilers (ADCP) recorded tide, wave, and current data at three locations on the reef flat in Faga'alu for one week (Figure "+Study_Area_map['fig_num']+"). The profilers were attached to cinder block anchors (Figure "+Drifter_ADCP_pics['fig_num']+"c) and placed on sand or rubble patches amongst the corals, as deep as possible to maintain adequate water levels over the profiler during low tide (Figure "+Drifter_ADCP_pics['fig_num']+"d). The profilers collected 580 current samples at 2 Hz every 10 min and 2,048 wave samples at 2 Hz every 60 min.") 

## Pics of drifters and ADCP
if 'Drifter_ADCP_pics' in locals():
    tables_and_figures.add_picture(Drifter_ADCP_pics['filename'],width=Inches(6))
    add_figure_caption(Drifter_ADCP_pics['fig_num']," Five GPS-logging drifters and three acoustic current profilers were deployed on the reef flat in Faga'alu. TOP: Images of the shallow-water drifters a) on land, and b) deployed in the field. BOTTOM: Images of the acoustic current profilers deployed on the southern reef flat (AS1).")

## Lagrangian measurements (GPS-logging drifters)
document.add_heading('Lagrangian Measurements',level=4)

document.add_paragraph("Drifters for shallow coral reef environments need to be shallow enough to avoid interaction with corals, deep enough to not be affected by the surface movements, extend high enough to be visible but not high enough to be affected by winds, and finally, rugged enough to sustain the impact of a breaking wave onto the reef in the event it is entrained in the surf zone. Due to Faga'alu Bay's relatively small area (0.25 km2), high spatial density drifter data could be collected with a small number of drifters (n = 5) and field personnel (n = 1). Five drifters were designed and constructed with materials available on-island (PVC tubing and plastic sheeting), with a small waterproof housing for a HOLUX M1000 GPS recorder, and a float collar to maintain upright orientation (Figure "+Drifter_ADCP_pics['fig_num']+"a and b). The fins of the drifters were roughly 30 cm wide and 18 cm in height, constructed of 1.3 cm diameter PVC with holes drilled to flood the piping and compensate for the buoyancy of the pipe. The GPS logger was installed in a PVC housing at the top. The drifters were transported to the launch zones and retrieved using a stand-up paddle board.")

document.add_paragraph("Five drifters were released from the same five launch zones within a 10 min time frame at the beginning of each deployment. Drifter position data was recorded by the GPS logger at 5 s intervals and resampled to 1 min intervals to reduce signal noise; speed and direction were calculated using a forward difference scheme on the drifter locations (Davis, 1991; MacMahan et al., 2010). Drifters were generally allowed to drift until they exited the ava channel to Pago Pago Bay, but tracks were limited to 1 h for comparisons with ADCP data.")


## Ancillary Data
document.add_heading('Ancillary Data',level=4) 

document.add_paragraph("The instrument deployments were timed to capture end-member forcing conditions that characterize the study area. The end member conditions time ranges were defined post-deployment using modeled and in situ wave, wind, and tide data following the methodology described by Presto et al. (2006).") 
## Wave data
document.add_paragraph("Incident wave conditions were recorded by a NIWA Dobie-A wave/tide gauge (DOBIE) deployed on the southern reef slope at a depth of 10 m (Figure "+Study_Area_map['fig_num']+"). The DOBIE sampled a 512s burst at 2 Hz every hour. The DOBIE malfunctioned and recorded no data coinciding with the ADCP deployment, but compared well (not shown) with NOAA/NCEP Wave Watch III (WW3; Tolman, 2002) modeled data on swell height and direction for the recorded data (Hoeke et al., 2011). WW3 model data, calibrated to DOBIE wave data, were used to define forcing during the ADCP and drifter deployments.")
## Wind data
document.add_paragraph("Wind speed, wind direction, barometric pressure, and precipitation were recorded at 15 min intervals using a Davis VantagePro weather station installed near the stream mouth, approximately 5 m above sea level on a pole mounted to a building (Figure "+Study_Area_map['fig_num']+"). Meteorological and tide data were also recorded at NOAA's National Data Buoy Center station NSTP6 (http://www.ndbc.noaa.gov) located approximately 1.8 km north of Faga'alu. Wind speed, wind direction, barometric pressure, and tidal elevation data were also recorded at NSTP6 at 6 min intervals. For this study, wind conditions are sufficiently described qualitatively so the topographic effects on wind speed and direction recorded at the stations are assumed to be inconsequential.")


## Analytical Methods
document.add_heading('Analytical Methods',level=4)

document.add_paragraph("Data from the drifters and ADCPs was subset by end-member forcing condition, and two techniques were used to compare the drifter results with the ADCP results: progressive vectors of cumulative flow and empirical orthogonal functions (EOF).")
## Progressive Vectors
document.add_paragraph("A series of 1 h progressive vector diagrams of cumulative flow were computed from ADCP data following the methodology used by Storlazzi et al. (2006) and Siegel et al. (2003). The progressive vectors were compared to simultaneous drifter tracks to demonstrate the usefulness of drifters for illustrating spatially variable flows compared to projected flow from fixed ADCPs. The progressive vectors from the ADCPs illustrate the temporal flow variability at those fixed points during the 1 h drift duration, but progressive vectors are calculated assuming spatial homogeneity of the flow, causing them to move onshore in some instances.")
## EOFs, mean current, residence time
document.add_paragraph("EOF principal axes, variance ellipses, mean flow velocities, and residence times were calculated from ADCP data and spatially binned drifter data (100 m x 100 m) (MacMahan et al., 2010) under different endmember forcing conditions. Where drifters did not travel through a spatial bin, no EOF or residence time could be calculated. EOFs and mean flow velocities from drifters and ADCPs were compared to determine if the short-term observations from the drifters were similar to the long-term ADCP observations, and to demonstrate the usefulness of Lagrangian methods for describing spatial flow patterns compared to fixed Eulerian methods. Mean flow velocities were also used to calculate water residence time over the reef under different forcing conditions. For ADCP data, the mean flow speeds under different forcings were used to calculate residence time for a 100 m bin to correspond to the drifter results.")

#### RESULTS ####
results_title = document.add_heading('RESULTS',level=2)
## Forcing: Wave, wind, tide during ADCP deployment
document.add_heading('Oceanographic and Meteorologic Forcing ',level=3)

### Forcing data
if 'Forcing_data_timeseries' in locals():
    tables_and_figures.add_picture(Forcing_data_timeseries['filename'],width=Inches(6))
    add_figure_caption(Forcing_data_timeseries ['fig_num'],caption="Time series of physical forcing data was used to define end-member forcing conditions for analysis. Forcing data included: a) tide stage, b) wind speed, c) wind direction from NDBC station NSTP6, d) wave height, e) wave period, and f) wave direction from NOAA WW3. Day 47=16 Feb 2014, Day 54=23 Feb 2014.")

document.add_paragraph("During the period of overlapping ADCP and intensive drifter deployments, 2014 Year Day (YD) 47-55 (15-23 February 2014), a large range of tide, wind, and wave conditions was sampled (Figure "+Forcing_data_timeseries ['fig_num']+"). Three distinct periods were observed including a strong onshore wind event, a high southeast groundswell, and weak winds from variable directions where tidal forcing was dominant . Three end-member forcings were defined: 1) Small waves and strong onshore winds ('WIND') during 2014 YD 47-49; 2) Small waves and weak winds ('TIDE') during YD 50-51; and 3) Large waves and weak winds ('WAVE') during YD 52- 55 (Table "+Endmember_table.table_num+"). During WIND, average wind speed was 2.6-5 m/s with maximum gusts of 14.5 m/s from the northeast to southeast on YD 48. These wind conditions are typical of average wind conditions observed during the winter tradewind season. During TIDE, wind speeds were low to moderate (1.5-3 m/s) and wind directions were variable, which is typical during the summer wet season. During WAVE, maximum wave height reached 1.3 m on YD 52, which is near the annual maximum height expected for this location (O. Vetter, unpublished data).")


## Table: End member definitions
if 'Endmember_table' in locals():
    dataframe_to_table(df=Endmember_table,table_num=Endmember_table.table_num,caption="End member periods",fontsize=9)
    #document.add_paragraph("**Note: Local time is UTC-11 so local dates are actually one day earlier (e.g. Tide=2/18-2/19 Local time)")

## Eulerian Measurements (ADCP)    
document.add_heading('Eulerian Measurements',level=3)

document.add_paragraph("ADCPs at three locations on the reef flat recorded water flow for one week during 2014 YD 47-55. On the northern reef flat (AS3) the water level dropped below the minimum blanking distance of the ADCP at low tides (Figure "+ADCP_measurements['fig_num']+" d), and flow was assumed to be nearly zero during these times given the relatively low water depth. The short data gap at AS1 on YD 50 was due to the ADCP being disturbed, likely by fishermen looking for octopus.") 

document.add_paragraph("In general, tidal forcing showed slow flow speeds and more variable directions, wind forcing showed slow flow speeds and less variable directions, and wave forcing showed the fastest flow speeds and most consistent flow directions. The highest velocity flow was observed over the southernmost part of the reef (AS1) and was oriented predominantly in a northwesterly direction, indicating the strong influence of even small breaking waves over the reef crest (Figure "+ADCP_measurements['fig_num']+" b, e). Flow direction at AS2 was consistently to the southwest, though direction was more variable under tidal forcing, even exhibiting some cross-reef flow to the northeast (Figure "+ADCP_measurements['fig_num']+" c). Flow speed at AS2 was responsive to high winds and high waves, and highest during high waves (Figure "+ADCP_measurements['fig_num']+" e). At AS3, flow directions and speeds were highly variable under all forcing conditions, and exhibited the lowest flow speeds of the three ADCPs (Figure "+ADCP_measurements['fig_num']+" d-e).")

document.add_paragraph("Flow speeds at AS1 and AS2 illustrated the modulating effects of tidal stage on wave-forced flow (Figure "+ADCP_measurements['fig_num']+" e). During wave forcing, and to a lesser degree during wind forcing, flow velocity is highest during high tide and decreases significantly as the tide stage falls. This is most evident at AS1, but is also observed at AS2, during YD 53-55. This effect is noticeably absent or significantly reduced during wind forcing on YD 47-49, and tidal forcing on YD 51-52.")

## ADCP measurements
if 'ADCP_measurements' in locals():
    tables_and_figures.add_picture(ADCP_measurements['filename'],width=Inches(6))
    add_figure_caption(ADCP_measurements['fig_num'],caption="Acoustic current profilers (ADCP) at three locations on the reef flat recorded water flow for one week. Time series of tide (a) and water flow measured by the acoustic current profilers at the southernmost point, AS1 (b), the central part of the reef, AS2 (c), and northern reef, AS3 (d). At AS3 (d), water depths at low tide were too shallow to measure flow data. Note the variations in current speeds both in space and time due to the different forcing conditions (e).")     
    

## Lagrangian Measurements (GPS-logging Drifters)
document.add_heading('Lagrangian Measurements',level=3)
document.add_paragraph("Thirty drifter deployments were conducted from January to February 2014, with 22 of those deployments coinciding with the ADCP deployment during YD 47-55 (February 15-23; Appendix Table "+Drifter_deployment_table.table_num+"). Drifter tracks from all deployments covered nearly the entire reef flat and ava channel (Figure "+ALL_Drifter_tracks['fig_num']+"), showing three gneral spatial patterns: 1) Faster flow speeds over the southern reef flat, 2) slower, more variable currents over the deeper pools of the southern backreef, northern reef, and ava channel near the stream mouth, and 3) faster current speeds exiting the east end of the ava. Several examples of cross-reef transport were observed, mainly exiting through a small channel in the southern reef crest at high tide under calm wave and wind conditions. Some continued moving out to sea and some were quickly re-entrained in the surf zone and traveled over the reef flat. Other anomalous drifter tracks show where drifters were entrained in the surf zone at the reef crest and quickly exited back out to sea in the far northeast portion of the study area.")

if 'ALL_Drifter_tracks' in locals():
    tables_and_figures.add_picture(ALL_Drifter_tracks['filename'],width=Inches(6))
    add_figure_caption(ALL_Drifter_tracks['fig_num'],caption="Map of all drifter tracks, colored by speed (m/s), recorded during the experiment.")
    

# Progressive Vectors
document.add_heading('Progressive Vectors',level=3)
document.add_paragraph("Progressive vectors were calculated from ADCP data and compared to drifter tracks for each end-member forcing condition (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). While the drifter tracks changed direction from onshore to cross-shore towards the ava channel, the progressive vectors over the southern reef showed little variation in flow direction, going ashore in some cases, indicating the flow velocity was relatively consistent at AS1 and AS2. The progressive vectors over the northern reef were much more erratic, and traveled much shorter distances than the drifter tracks due to the lower flow speeds observed at AS3. In general, the lengths of progressive vectors were similar to the actual tracks of the drifters, indicating similar flow speeds. The exception was over the northern reef, where drifters quickly moved into the ava channel and were influenced by very different currents than what was observed at AS3. While drifters could only be deployed at mid-high tides when the reef flat was deep enough to avoid getting stuck on corals, the ADCPs recorded flow over the complete tidal range. The shorter progressive vectors indicate flow at lower tides when flow speeds are reduced (Figure "+ADCP_measurements['fig_num']+").")

if 'Progressive_Vectors_ADCP_vs_Drifters' in locals():
    tables_and_figures.add_picture(Progressive_Vectors_ADCP_vs_Drifters['filename'],width=Inches(6))
    add_figure_caption(Progressive_Vectors_ADCP_vs_Drifters['fig_num'],caption=" Progressive vectors calculated from acoustic current profiler (ADCP) data, compared to drifter tracks under end-member forcing conditions: a-b)  Tide, c-d) Wind, and d-f) Wave . ") 
    
# Tide
document.add_paragraph("Under tidal forcing the drifters traveled in erratic directions and traveled farther than predicted by the progressive vectors from ADCPs, indicating higher flow speeds (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"a-b). Drifter tracks and progressive vectors compared poorly in speed and direction at AS3 on the northern reef, slightly better at AS2 though progressive vectors are still shorter and do not vary direction, and fairly well at AS1 on the southern reef. Under the low wave conditions, drifters were observed to flow seaward over the reef crest near AS2, but only at high tide. Drifters were also observed moving from the northern reef onto the southern reef during light and variable winds.")
# Wind
document.add_paragraph("Under wind forcing, progressive vectors and drifter tracks were shorter than during tide and wave forcing, indicating flow speeds were slower (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"c-d). Though moderate to strong easterly winds are most prevalent throughout the year due to the trade winds, fewer observations were made under wind forcing than tidal or wave forcing so there is less certainty in the observed flow patterns. Also, a drifter deployed at the northeast reef was lost during the WIND period, so no drifter tracks were available from that location. Progressive vectors compared well with drifter tracks in speed and direction for all locations, though the progressive vector at AS3 is still short in comparison to the drifter tracks near the same location. The drifter tracks show a general trend of flow towards the northwest corner of the bay, and suggest flow out of the ava channel (at least at the surface) may be suppressed under strong onshore (easterly) winds.")
# Wave
document.add_paragraph("Under wave forcing, longer progressive vectors at all locations, including the northern reef, indicate significantly faster flow speeds than during wind and tidal forcing (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e-f). The progressive vectors on the southern reef mainly indicate onshore flow, even going ashore in some instances. Despite waves breaking on the the northern reef crest, it appears the flow across the southern reef and into the ava channel influences an overall eastward flow over the northern reef and out to sea. The drifter tracks clearly indicate a coherent pattern of clockwise flow over the the southern reef, through the backreef pools and near the stream mouth, and then seaward over the northern reef and out the ava channel. All drifters exited the channel during the 1 h drift, suggesting under high waves the flushing time of the whole bay is under 1 h.")


# EOFs
## EOF Plots of all drifter data, in 100m bins, color ellipses by number of observations
document.add_heading('Empirical Orthogonal Functions (EOF)',level=3)

document.add_paragraph("EOFs, variance ellipses, and mean flow velocities were calculated from ADCP and spatially binned drifter data collected during each end member forcing condition (Figure "+PCA_gridded['fig_num']+"). The number of drifter tracks that traveled through each grid cell differed due to the spatial position of the grid cell relative to the flow pattern. Grid cells in the middle parts of the bay and ava channel had more drifter tracks than grid cells in the outer bay and near the shore. More observations suggests more certainty, while some of the outlying grid cells with a small number of observations may have been influenced by an anomalous drifter track or a small range of the end member forcing condition.")

document.add_paragraph("The overall pattern of EOFs and mean flow velocities from drifters are similar to the corresponding results from ADCPs. Variance ellipses from both data sources are more ellipsoid on the southern reef at AS1 and AS2, and more circular at AS3, under all forcing conditions. Mean velocities calculated from ADCP data showed similar directions during different forcings but varied in speed, with the highest mean flow speed under high waves (Figure "+PCA_gridded['fig_num']+" e). Finer resolution drifter data resolved the general clockwise flow from the southern reef, over the northern reef and out to sea. The drifter data also illustrates the decreased flow velocity near shore and in the southern backreef pools. Over the whole bay, mean flow velocity from drifters varied from 1-37 cm/s, 1-36 cm/s, and 5-64 cm/s under tidal, wind, and wave forcing, respectively. For tide forcing, mean velocity calculated from ADCP data was 14.6 cm/s, 5.3 cm/s, and 0.9 cm/s for AS1, AS2, and AS3, respectively. For wind forcing, mean velocity calculated from ADCP data was 11.6 cm/s, 3.9 cm/s, and 1.5 cm/s for AS1, AS2, and AS3, respectively. For wave forcing, mean velocity calculated from ADCP data was 18.1 cm/s, 10.9 cm/s, and 1.21 cm/s for AS1, AS2, and AS3, respectively (Table "+compare_drifters_ADCP_speed_res_time.table_num+").")

## Gridded EOF by endmembers
if 'PCA_gridded' in locals():
    tables_and_figures.add_picture(PCA_gridded['filename'],width=Inches(6))
    add_figure_caption(PCA_gridded['fig_num'],caption="Empirical Orthogonal Functions (EOF)  calculated from ADCP data, compared to EOFs calculated from spatially binned (100m x 100m grid cell) drifter data under different end member forcing conditions: tide, wind, wave. Drifter EOFs are colored by number of observations to illustrate varying data density.")   

#Tide
document.add_paragraph("Compared to wind and wave forcing, the most circular EOFs from both ADCP and drifter data were observed under tidal forcing, indicating flow directions were most variable under light, variable winds and low waves. EOFs from drifters were more ellipsoid and mean velocities were higher near the reef crest and on the southern reef, compared to the northern reef and southern backreef pools. Though flow directions were more variable, mean velocities indicated flow speeds were higher under tidal forcing than wind forcing, but still lower than wave forcing. While EOFs and mean velocities from ADCPs showed exclusively shoreward flow, EOFs and mean velocities from drifters showed clockwise flow across the southern reef and seaward out the ava channel.")

#Wind
document.add_paragraph("The lowest mean flow velocities from both ADCPs and drifters were observed under wind forcing, but the EOFs were more ellipsoid than under tide forcing, indicating flow directions were more consistent during strong onshore winds. While EOFs and mean velocities from ADCPs showed exclusively onshore flow under all forcing conditions, the higher resolution drifter data also showed the same pattern under wind forcing, with a notable lack of seaward flow out of the ava channel. This suggests that strong onshore winds, in the absence of high waves, drives all surface flows into the northwest corner of the bay. However, data density was lowest during wind forcing and perhaps drifter deployments longer than 1 h would have observed seaward flow. Similar to tide and wave forcing, the overall flow pattern from the drifters was more ellipsoid EOFs and higher velocities over the southern reef, and more circular EOFs and slower velocities in the backreef pools, ava channel, and northern reef.")

#Wave
document.add_paragraph("The highest mean flow speeds and most ellipsoid EOFs were observed under wave forcing, indicating high waves are a strong control on flow velocities in the bay. While flow speeds at AS1 were consistently influenced by even small breaking waves, as wave height increased, breaking waves were observed further north along the reef crest, particularly near the ava channel, increasing flow speeds over the reef flat near AS2. The increased flow near AS2 increased flow speeds near the ava channel and the southern backreef pools.  While the EOF at AS3 was still circular, indicating variable flow directions, the magnitude of the major and minor flow axes were larger than tide and wind forcings, indicating flow speeds were higher during wave forcing. The drifters showed a clear pattern of faster, more unidirectional flows near the reef crest on the southern reef, transitioning to slower, more variable flow over the backreef pools, and finally turning eastward over the northern reef and seaward out of the ava channel. Mean velocities increased moving seaward through the ava channel, similar to the results under tidal forcing, but due to the low data density outside the reef crest it is unclear whether the flow continues eastward to Pago Pago Harbor or swirls around and is re-entrained in the surf zone on the southern reef.") 
  

## Residence Times for 100m bin grid
document.add_heading('Residence Time', level=3)

document.add_paragraph("Water residence time over the reef flat was computed from the mean drifter velocities under different forcing conditions (Figure "+Gridded_ResidenceTime_endmembers['fig_num']+"). Residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.56-0.04 h under tidal, wind, and wave forcing, respectively. The shortest residence times were measured near the southern reef crest, and under high wave conditions in general. The longest residence times were observed over the inner reef flat close to shore and in the northwest corner of the embayment, under tidal and wind forcing.")

if 'Gridded_ResidenceTime_endmembers' in locals():
    tables_and_figures.add_picture(Gridded_ResidenceTime_endmembers['filename'],width=Inches(3))
    add_figure_caption(Gridded_ResidenceTime_endmembers['fig_num'],caption="Residence time calculated from mean velocity of drifters under endmember conditions")    

document.add_paragraph("To compare the Eulerian and Lagrangian methods, mean flow speed and residence time computed from the ADCP and the corresponding spatially-binned drifter data were compared under different forcing conditions (Table "+compare_drifters_ADCP_speed_res_time.table_num+"). Water residence times computed from mean flow velocities at AS1 were 0.19 h, 0.24 h, and 0.15 h, for tide, wind and wave forcing, respectively. Residence times at AS2 were 0.52 h, 0.72 h, and 0.26 h, for tide, wind and wave forcing, respectively. Residence times at AS3 were 2.95 h, 1.87 h, and 2.26 h, for tide, wind and wave forcing, respectively. Mean velocities from the ADCPs were lower than mean velocities from drifters in all cases except for on the southern reef under wind forcing. The RMSE and percent error (RMSE/mean) were computed for all locations during each forcing condition, and for each location under all forcing conditions. The highest percent error for a single location was at AS3 on the northern reef, likely due to the strong heterogeneity in the flow as the drifters moved into the ava channel. The lowest percent error was at AS1 on the southern reef, where the flow is most homogeneous. The percent error for all locations together was lowest for speed during tide forcing, and lowest for residence time during wind forcing.")

## Compare ADCP and drifter mean flow speeds and residence times
#dataframe_to_table(df=compare_drifters_ADCP_speed_res_time,table_num=compare_drifters_ADCP_speed_res_time.table_num,caption="Mean flow speed and residence time computed from ADCP and corresponding spatially binned drifter data for different forcing conditions. Percent error = RMSE/mean.",fontsize=9)

#### DISCUSSION
document.add_heading('DISCUSSION',level=2)

## General observations
document.add_paragraph("The bay-wide mean current speeds (residence times) varied from 1-37 cm/s (2.78-0.08 hr), 1-36 cm/s (2.78-0.08 hr), and 5-64 cm/s (0.56-0.04 hr) under tidal, wind, and wave forcing, respectively. The highest flow speeds were consistently observed at AS1 and over the southern reef near the reef crest, suggesting the strong influence of breaking waves, even when the waves were relatively small. Over the northern reef, mean flow directions were more variable, reversing and flowing towards the river mouth under strong onshore winds and sometimes during tidal forcing with variable winds. The lowest flow speeds and highest residence times were consistently observed in the northwest corner of the bay, when wave-driven flow was low or when winds were onshore.")

## Comparing differences in Lagrangian/Eulerian
document.add_paragraph("Both the Eulerian and Lagrangian methods characterized the main difference between the faster, less variable flow over the southern reef and the slower, more variable flow over the northern reef under all forcing conditions. However, where the Eulerian method characterized flows adequately over the southern reef flat where bathymetry and wave forcing were fairly simple, the spatially distributed Lagrangian method more accurately characterized spatially complex flows resulting from complex bathymetry. Mean flow directions at the ADCPs were exclusively onshore, but the higher resolution drifter measurements resolved the general flow pattern of clockwise flow over the southern reef and out to sea over the northern reef and through the ava channel. The spatially distributed drifter measurements also illustrated several unique features in the flow pattern, particularly near areas of complex bathymetry like the ava channel. From the orientation of the reef flat and channel, it would seem that flow over the southern reef near the ava channel would flow directly from the reef crest northward into the main channel. Hoowever the flow near AS2 is deflected away from the ava channel, shoreward to the west where it flows into the backreef pools and then enters the ava channel. This deflection is likely caused by wave energy refracting and surging into the ava channel, pushing southward from the main channel onto the southern reef.")

document.add_paragraph("Observations on the reef flat in Molokai, Hawaii, showed current speeds were faster where the reef is deeper and narrower (Curt D Storlazzi et al., 2006) but the EOFs and progressive vectors in Figures "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+" and "+PCA_gridded['fig_num']+" suggest the opposite: current speeds are rapid over the shallow reef crest, slowing significantly and becoming more variable when reaching deeper pools and the ava channel. However, flow through the ava channel was not spatially constant. Under both wave and tide forcing, the flow speed through the ava channel steadily increased moving seaward, reaching a maximum at the reef crest. The same pattern was not evident under wind forcing, possibly due to wind driven flow being forced into the bay at the surface, but the data density is too low to be certain. Hench (2008) vertically binned ADCP data in a similar reef in Moorea, and showed that under low wave forcing surface currents were lower in the reef pass and could reverse near the bottom. The increase in flow speed through the ava channel at the study site is either caused by the increasing volume of water contributed by the reef flats on either side or a narrowing of the channel cross-section. Either way, the increase is notable for it's implications for placing a Eulerian ADCP at a fixed point in the channel, and using data from that one point to define flow for all of Faga'alu Bay.")

document.add_paragraph("The Lagrangian methods measured higher mean flow speeds at all locations and during all forcings except for one, on the southern reef during wind forcing (Table 2). The disagreement between methods is possibly caused by the drifters being carried in the faster surface flow, while the ADCPs sample the more of the water column, including where slower near-bottom flow. The disagreement may also be due to the heterogeneity of flow speeds within the 100m grid cell. The ADCPs were installed in relatively deeper parts of the reef where they could sample during all tide stages, but the flow speeds could be faster where it is forced up and over the coral heads and influence the mobile drifter. ")


#document.add_paragraph("Drifter observations in the gridcell corresponding to Vetter's (unpublished) ADCP location showed flow speeds of 1-30 cm/s wtih a mean of 8 cm/s, for all forcing conditions. Vetter's (unpublished) ADCP time series shows lower flow speeds in the channel Jan-April than during the more active tradewind season June-October so it is likely that the drifter deployments included more quiescent distribution of days than occur during the whole year. While one large swell event was sampled during the drifter deployments, these conditions appear to be more common during the year than were observed during the one intensive week of drifter deployments. Also, Vetter's (unpublished) ADCP data sampled the full depth of the water column, as opposed to just the surface current that could be affected by winds, especially when strong east winds blow into the bay. This suggests that perhaps Eulerian and Lagrangian methods are more comparable in shallow depths, where the drifter is influenced by a relatively larger portion of the water column.")

## Take-away message
document.add_paragraph("The overrall pattern of mean flow speeds and flow directions showed a predominantly clockwise circulation through the bay under all forcing conditions, with higher flow speeds throughout the bay during wave forcing, compared to tidal and wind forcing. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the northwest corner of the embayment. Given the proximity of the northern reef to the stream mouth and the occurrence of floods under typically low wave conditions in the wet season, or moderate easterly winds during the dry season, this suggests the northern reef and areas of the southern reef bordering the ava channel are under greatest threat of land-based sources of pollution. The spatial flow pattern and longer residence times result in greater exposure (=intensity x duration) of the corals in these areas to sediment stress, and likely causes the reduced coral health in these locations.")

#### Acknowledgements
document.add_heading('ACKNOWLEDGEMENTS',level=2)
document.add_paragraph("This work was carried out in collaboration between San Diego State University and the US Geological Survey's Coral Reef Project. Funding was provided by a grant by the NOAA Coral Reef Conservation Program. A significant contribution of equipment and expertise was provided by the USGS Pacific Coastal and Marine Science Center. We would like to thank Dr. Michael Favazza for providing logistical support in the field.")

#### References
document.add_page_break()
document.add_heading('References')
document.add_paragraph('Add at the end, using Mendeley refs')

#### Appendix
document.add_page_break()
document.add_heading('APPENDIX',level=2)
## Appendix stuff goes here...
## Table: Drifter deployments dates and conditions
if 'Drifter_deployment_table' in locals():
    dataframe_to_table(df=Drifter_deployment_table,table_num=Drifter_deployment_table.table_num,caption="Drifter deployment dates and conditions. Red numbered Deployments coincide with ADCP deployment",fontsize=9)
    document.add_paragraph("")  
    
#### Figure Captions
document.add_heading('Figure Captions',level=2)
for caption in figure_captions:
    document.add_paragraph(caption)

#### Table Titles
document.add_heading('Table Titles',level=2)
for title in table_titles:
    document.add_paragraph(title)

## Save Document
document.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation.docx')
tables_and_figures.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation_tables_and_figures.docx')

## Clean up any open figures
plt.close('all')

