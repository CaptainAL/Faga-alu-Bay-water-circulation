# -*- coding: utf-8 -*-
"""
Created on Wed Mar 18 06:26:25 2015

@author: Alex

this paper is different than the Fagaalu-SSY paper because the figures are combined with figures from a collaborator
in this case the figures are generated by other scripts and manually combined with the collaborators figures
these cannot be automated but the scripts have README's associated with the figures.

"""
#### Import modules
## Data Processing
import os
import numpy as np
import pandas as pd
#import math
import datetime as dt
import matplotlib.pyplot as plt
#### Plotting Tools
import matplotlib.pyplot as plt
import matplotlib as mpl
plt.ioff()
plt.close('all')

## Python docx
from docx import *
from docx.shared import Inches
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH

## Set Directories
git=True
if git==True: ## Git repository
    maindir = 'C:/Users/Alex/Documents/GitHub/Faga-alu-Bay-water-circulation/' 
    datadir=maindir+'Data/'
    trackdir = maindir+'Data/AllTracks/'
    GISdir = maindir+'Data/DriftersGIS/'
    figdir = maindir+'Figures/fromAlex/'
    dirs={'main':maindir,'data':datadir,'track':trackdir,'GIS':GISdir,'fig':figdir}
elif git!=True: ## Local folders
    datadir = 'C:/Users/Alex/Desktop/'
    trackdir = 'samoa/DRIFTERS/AllTracks/'


##  Create Document
document = Document()

######## SOME TOOLS
def add_figure_caption(fig_num=str(len(document.inline_shapes)),caption=''):
    cap = document.add_paragraph("Figure "+fig_num+". "+caption)
    cap.paragraph_style = 'caption'
    return
    
def dataframe_to_table(df=pd.DataFrame(),table_num=str(len(document.tables)+1),caption='',fontsize=11):
    table = document.add_table(rows=1, cols=len(df.columns)) 
    ## Merge all cells in top row and add caption text
    table_caption = table.rows[0].cells[0].merge(table.rows[0].cells[len(df.columns)-1])
    table_caption.text = "Table "+table_num+". "+caption
    ## Add  header
    header_row = table.add_row().cells
    col_count =0 ## counter  to iterate over columns
    for col in  header_row:
        col.text = df.columns[col_count] #df.columns[0] is the index
        col_count+=1
    ## Add data by  iterating over the DataFrame rows, then using a dictionary of DataFrame column labels to extract data
    col_labels = dict(zip(range(len(df.columns)),df.columns.tolist())) ## create dictionary where '1  to  n' is key for DataFrame columns
    for row in df.iterrows():  ## iterate over  rows in  DataFrame
        #print row[1]
        row_cells = table.add_row().cells ## Add a row to the  table
        col_count  = 0
        for cell in row_cells: ## iterate over the columns in the row
            #print row[1][str(col_labels[col_count])]
            cell.text = str(row[1][str(col_labels[col_count])]) ## and plug in data using a dictionary to  get column labels for DataFrame
            col_count+=1
    ## Format Table Style  
    table.style = 'TableGrid' 
    table.style.font.size = Pt(fontsize)
    table.autofit
    #table.num = str(len(document.tables)+1)
    return table
    
def add_equation(eq_table):
    t = document.add_table(rows=len(eq_table.rows),cols=len(eq_table.columns))
    t.rows[0].cells[1].text = eq_table.rows[0].cells[1].text
    t.rows[0].cells[2].text = eq_table.rows[0].cells[2].text   
    if len(eq_table.rows)>1:
        t.rows[1].cells[0].merge(t.rows[1].cells[2]).text = eq_table.rows[1].cells[0].text
    t.style = 'TableGrid'   
    t.autofit
    return t
###################################################################################################################################################################    


#### TABLES ########################################################################################################################################################
### Landcover_Table
table_count=0
def tab_count():
    global table_count
    table_count+=1
    return str(table_count)
    
## End member definitions
def Endmember_definitions_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    endmember_table = XL.parse('EndmemberDefn',header=0,index_col=0,parse_cols='A:D',parse_dates=False)
    endmember_table['End member']=endmember_table.index
    endmember_table = endmember_table[['End member','Julian Day', 'Gregorian Day (UTC)','Gregorian Day (Local)']]
    return endmember_table  
Endmember_table = Endmember_definitions_table()
Endmember_table.table_num = str(tab_count())    
    
## Drifter deployment dates
def Drifter_deployments_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    deployment_table = XL.parse('Table',header=1,index_col=0,parse_cols='C:P',parse_dates=False)
    deployment_table['Deployment'] = deployment_table.index
    deployment_table['Date'] = deployment_table['Date'].apply(lambda x: "{:%m/%d/%Y}".format(x))
    deployment_table['Tide Start'] = deployment_table['Tide Start'].round(1)
    deployment_table['Tide End'] = deployment_table['Tide End'].round(1)
    deployment_table['Tide movement'] = deployment_table['Tide movement'].round(1)
    deployment_table['Wind Speed Avg'] = deployment_table['Wind Speed Avg'].round(1)
    deployment_table['Wind Direction Avg'] = deployment_table['Wind Direction Avg'].round(0)
    deployment_table['Wind Gust Max'] = deployment_table['Wind Gust Max'].round(0)
    deployment_table= deployment_table[['Deployment','Julian(local)', 'Date', 'Start Time', 'End Time', 'Tide Start', 'Tide End', 'Tide movement', 'Tide', 'Wind Speed Avg', 'Wind Direction Avg', 'Wind Gust Max', 'Wave Height(m)', 'Wave Period']]
    return deployment_table
Drifter_deployment_table = Drifter_deployments_table()
Drifter_deployment_table.table_num = str(tab_count())    


#### FIGURES ########################################################################################################################################################
figure_count=0
def fig_count():
    global figure_count
    figure_count+=1
    return str(figure_count)
    
## INTRODUCTION
#### Study Area Map
Study_Area_map = {'filename':maindir+'Figures/Maps/Fagaalu_water_circulation_study_area.tif', 'fig_num':str(fig_count())}

### Pics of Bay
Bay_clear = {'filename':maindir+'Figures/Maps/Bay_clear.jpg', 'fig_num':str(fig_count())}
Bay_sedplume = {'filename':maindir+'Figures/Maps/Bay_sedplume.jpg', 'fig_num':str(fig_count())}

### Pics of Drifters and ADCP's
Drifter_ADCP_pics = {'filename':maindir+'Figures/Maps/Drifter_ADCP_pics.tif', 'fig_num':str(fig_count())}

### Forcing data
Forcing_data_timeseries = {'filename':maindir+'Figures/Forcing/AmSam_ADCPdrifter_Fig_3_forcing.png', 'fig_num':str(fig_count())}

### ADCP measurements
ADCP_measurements = {'filename':maindir+'Figures/ADCP measurements/Figure4_ADCP.png', 'fig_num':str(fig_count())}

### All Drifter tracks
ALL_Drifter_tracks = {'filename':maindir+'Figures/ALL drifter tracks/drifters_all_arrows_speed.png', 'fig_num':str(fig_count())}

### Progressive Vectors vs drifter tracks
Progressive_Vectors_ADCP_vs_Drifters = {'filename':maindir+'Figures/Progressive Vectors/Figure6_progvec_driftervelocity.png', 'fig_num':str(fig_count())}

## Gridded PCA by endmember
PCA_gridded = {'filename':maindir+'Figures/Gridded PCA endmembers/Figure7_paxes_map_OMC.png', 'fig_num':str(fig_count())}

### Gridded velocity by endmember
Gridded_Velocity_endmembers = {'filename':maindir+'Figures/Gridded velocity endmembers/Fagaalu_velocity-endmembers.png', 'fig_num':str(fig_count())}

### Gridded residence time by endmember
Gridded_ResidenceTime_endmembers = {'filename':maindir+'Figures/Residence Times/Fagaalu_gridded_residence_time.png','fig_num':str(fig_count())}

###### EQUATIONS ############################################################################################################################################
equation_count=0
def eq_count():
    global equation_count
    equation_count+=1
    return str(equation_count)
    
#Equations = Document(maindir+'/Manuscript/Equations.docx').tables
#
### SSYev = Q*SSC 
#Equation_one = Equations[0].table
#Equation_one.eq_num = eq_count()

##### APPENDIX #################################################################################################################################
#### Appendix
table_count,figure_count,equation_count=0, 0, 0
### Appendix Table One
#Appendix_table_one = table_function() ## function to create table data
#Appendix_table_one.table_num =str(tab_count())

############################################################################################################################################

#### TITLE
title_title = document.add_heading('TITLE:',level=1)
title_title.paragraph_format.space_before = 0
title = document.add_heading("Eulerian and Lagrangian measurements of flow and residence time on a fringing reef flat embayment, American Samoa",level=1)
title.paragraph_format.space_before = 0
## subscript/superscript words
document.add_paragraph("")

#### ABSTRACT
abstract_title = document.add_heading('ABSTRACT',level=2)
abstract_title.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER
abstract = document.add_paragraph("Hydrodynamic processes on coral reefs are important for nutrient cycling, larval dispersal, temperature variability, and understanding the impacts on coral reef ecosystems from terrestrial sediment, nutrients, and contaminants from adjacent impaired watersheds. In order to understand the spatial and temporal variability in flow velocities and the resulting residence time of water in the fringing coral reef flat-lined embayment of Faga'alu, on the island of Tutuila in American Samoa, data from three bottom-mounted acoustic current profilers and 102 (4-5 drifters x 21 deployments) individual Lagrangian ocean surface current drifter deployments were combined with meteorologic data and numerical wave model results. These data and model results, collected over nine days, made it possible to evaluate the relative contribution of tidal, wind, and wave forcing on the flow patterns. The high number of drifter deployments made it possible for the velocity data to be binned into 100 m x 100 m grid cells and the resulting residence times computed for the different sets of forcing conditions. Cumulative progressive vectors calculated from the acoustic current profilers closely matched the tracks from concurrently-deployed surface current drifters, showing the applicability of this hybrid Lagrangian-Eulerian measurement scheme to understand flow patterns in this geomorphically-complex embayment. Mean current speeds (residence times) varied from 1-37 cm/s (2.8-0.1 hr), 1-36 cm/s (2.8-0.1 hr), and 5-64 cm/s (0.6-0.04 hr) under tidal, wind, and wave forcing, respectively; the highest speeds (lowest residence times) were measured on the outer reef flat closest to where waves were breaking on the reef crest and were slowest (longest) over the inner reef flat close to shore and deep in the embayment. ")

document.add_paragraph("scripted terms: km2")

#### INTRODUCTION
introduction_title = document.add_heading('Introduction',level=2)
document.add_paragraph("Hydrodynamic conditions, including the residence time of waters over the reef flat, are a primary control on sediment dynamics in fringing reef embayments (Draut et al., 2009; Storlazzi et al., 2009), and are important for other biologically important processes like nutrient cycling, larval dispersal, and temperature regimes (Falter et al., 2004; Wyatt et al., 2012). Current conservation planning is done with coarse estimations of pollutant discharge and distance-based plume models (Klein et al., 2012) but coral reef environments are more hydrodynamically complex and variable than estuaries or beaches. Studies in Hanalei Bay showed that variations in reef morphology relative to the orientation of the dominant meteorological and oceanographic forcing can generate heterogeneous waves and currents over relatively small (hundreds of meters) spatial scales, unlike those observed along relatively linear sandy shorelines (Hoeke et al., 2011; Storlazzi et al., 2009).  In reef environments where shallow reef crests limit the propagation of incoming surface wave energy, wave action alone may be insufficient to resuspend and disperse sediment, but in combination with wave- or wind-driven currents, orbital velocities may reach critical shear stress for sediment resuspension and dispersal (Ogston et al., 2004). By influencing orbital velocities, bed shear stress, and suspended sediment transport, current circulation is a strong control on the spatial distribution of sediment deposition, resuspension, and dispersal of terrigenous sediment discharged to the reef (Hoitink and Hoekstra, 2003; Presto et al., 2006; Storlazzi et al., 2004).")

document.add_paragraph("Studies in various coral reef environments adjacent high islands showed current speeds, directions, and residence times over reef flats are controlled by wave, wind, and tidal forcing, depending on the orientation and shape of the reef, relative to the prevailing wave, wind, and tidal climates (Hench et al., 2008; Hoeke et al., 2011; Presto et al., 2006; Storlazzi and Field, 2008; Storlazzi et al., 2004). Buoyancy forcing from hypopycnal river floods is generally ignored or considered inconsequential due to their rarity and short duration relative to other forcings (Hench et al., 2008; Hoeke et al., 2011).  Current speeds and patterns over reefs exposed to remotely-generated groundswells are generally dominated by wave forcing (Hench et al., 2008; Hoeke et al., 2011; Vetter et al., 2010), whereas wind forcing is dominant for reefs protected from groundswells (Presto et al., 2006). Tidal elevation modulates both wave-driven currents by controlling the reef crest depth and subsequent wave energy propagation into the reef flat, and wind-driven currents by regulating water depth for wind-driven surface wave development (Presto et al., 2006). Reef flat currents in wave-driven environments exhibit a pattern of rapid, cross-shore flow near the reef crest that slows moving shoreward and turns along-shore towards a deep channel where water returns seaward (Hench et al., 2008; Lowe et al., 2009; Wyatt et al., 2010). In wind-driven systems, current directions are more predominantly in the direction of the wind with possible cross-shore exchange from the reef flat to the forereef (Storlazzi et al., 2004). Observations on the reef flat in Molokai, Hawaii, showed current speeds were faster where the reef is deeper and narrower (Curt D Storlazzi et al., 2006) but field observations at the proposed study site suggest the opposite; current speeds are rapid over the shallow reef crest, slowing significantly when reaching deeper pools in the reef and the main channel that bisects the reef.")

document.add_paragraph("Understanding the current speeds, flow patterns, and residence time of water over the reef flat is critical for understanding spatial and temporal patterns of sedimentation in the study site, Faga'alu Bay, American Samoa. Following large or intense storm events, suspended sediment is discharged into Faga'alu Bay and advected seaward over the reef by momentum, in a thin surface layer of high suspended sediment concentration (SSC)(>500mg/L). This sediment-rich layer significantly attenuates photosynthetically active radiation (PAR) and transports fine sediment over the reef where it can settle out of the water column and onto coral organisms. Although the hypopycnal surface plume is able to move counter to prevailing currents (upcurrent) by sliding over denser seawater, as sediment particles settle they are entrained in the prevailing current and transported accordingly (Wolanski et al., 2003). As flow velocities increase, residence time of the plume over the reef flat decreases, limiting time for small particles to settle out of the water column and controlling the sedimentation rate, even for the same concentration and magnitude of different plumes.")

document.add_paragraph("Little data on current circulation around Tutuila is available, and almost no data on circulation over the reef flat has been collected (CH2M HILL, 1984; Jacob et al., 2012; Wiles et al., 2012). Militello et al. (2003) modeled wave-induced setup on reef flats and developed stage-frequency relationships for large tropical storms and hurricanes in American Samoa. Thompson and Demirbilek (2002) characterized offshore wave climate from data collected near Western Samoa (1985-1990), and used numerical modeling to simulate wave propagation dynamics in Pago Pago Harbor. Vetter et al (2013) deployed wave/tide gauges in Faga'alu Bay on the southern forereef and reef flat, and an ADCP in the 'ava, for one year (2012-2013). Vetter (2013) concluded flow dynamics in the bay were predominantly forced by waves breaking over the southern reef crest, and the wave influence increased linearly with tide height. Using an estimate of total lagoon volume, Vetter (2013) calculated flushing time varied from thirty-three hours during low wave height, to less than two hours during conditions when peak significant wave height was 1.6m, and mean current speed out of the main channel was 0.14 m/sec.")


#### STUDY AREA
study_area_title = document.add_heading('Study Area',level=2)

document.add_paragraph("Faga'alu Bay, on the island of Tutuila, American Samoa (14.290 S, 170.677 W) is a V-shaped, reef-fringed embayment at the mouth of a small, steep-sided watershed (2.48 km2)(Figure "+Study_Area_map['fig_num']+"). An anthropogenically altered, vertical-walled, 10-20m deep paleo-stream channel extends from the mouth of Faga'alu Stream eastward to Pago Pago Bay. This deep channel ('ava in Samoan language) divides the reef into a larger southern and a smaller northern section.")

## Study Area map
if 'Study_Area_map' in locals():
    document.add_picture(Study_Area_map['filename'],width=Inches(6))
    add_figure_caption(Study_Area_map['fig_num'],"Data collection locations in Faga'alu Bay. Wind speed and direction was recorded at the weather station (WxStation), a Dobie wave gauge recorded wave height and period (Wave Gauge), three ADCP's were deployed for one week to measure current speed and direction, and five GPS-logging drifters were deployed from the same five launch zones (DrifterLaunch) for thirty separate deployments (January to March, 2014). ")
    
document.add_paragraph("Faga'alu Bay is situated on the western side of Pago Pago Harbor where the surrounding high topography blocks wet-season northerly winds (October-April), but the bay is exposed to dry-season southeasterly tradewinds and accompanying short-period wind waves (May-September). Faga'alu is only open to a narrow window of swell directions (S-SE) and swells approaching from a southerly angle must refract to the west to break directly on the reef, reducing the energy of breaking waves. Offshore significant wave heights (Hs) from southerly and southeasterly directions are generally less than 2.5m and rarely exceed 3m. Wave periods (Tp) are generally about 9 sec or less, rarely exceed 13 sec but occasionally reach 25 sec during austral winter storms (Thompson and Demirbilek, 2002). Vetter (2013) recorded peak significant wave heights on the forereef in Faga'alu up to 1.7m but wave heights greater than 1m were rare. Wave-breaking is constrained to the shallow reef crests, the transitions between the steeply-sloping fore reef and the roughly horizontal reef flats. A microtidal regime (~0-1m) varies semi-diurnally, exposing parts of the shallow reef crest and reef flat at extreme low tides (<0m MSL). Given that the reef crest is exposed at low tide, cross-reef transfer of wave energy and water flow is strongly dependent on the tidal stage and wave setup.")

if 'Bay_clear' in locals():
    document.add_picture(Bay_clear['filename'],width=Inches(6))
    add_figure_caption(Bay_clear['fig_num']," Image of the embayment on a typical, rain-free day. The darker areas of the bay are live coral, and the light areas are deeper pools with carbonate sand bottom.")  
if 'Bay_sedplume' in locals():
    document.add_picture(Bay_sedplume['filename'],width=Inches(6))
    add_figure_caption(Bay_sedplume['fig_num'],"Image of a flood plume (2/21/14) in the northern portion of the bay following a heavy precipitation event. Plumes usually persist for several hours, and rarely are seen after 24h due to the flushing of water through the deep channel and out to sea.")    
    
#### METHODS
methods_title = document.add_heading('Methods',level=2)

document.add_paragraph("In a previous water circulation study in Faga'alu, Vetter (2013) used wave/tide data and current speed in the reef channel to calculate flushing time of the bay's total volume. Those calculations are highly dependent on the estimation of total volume in the bay and reliant on bathymetry data which is not well verified. Calculations of flushing time also do not provide information on the spatial distribution of flow speeds or specific flow paths over the reef. Since it is known that both quality and residence time of water over the reef are strong controls on coral health, it is desirable to characterize spatially distributed flow patterns in relation to wave, wind, and tide forcings. To characterize the spatial pattern of flows over the reef flat in Faga'alu Bay, and determine the relationship between offshore wave forcing and residence time of water over the reef flat, a combination of Eulerian and Lagrangian measurements was used.")

## Combining Eulerian and Lagrangian methods
document.add_heading('Combining Eulerian and Lagrangian methods',level=3)
document.add_paragraph("In fluid dynamics there are two ways to quantify the flow field: 1) the Lagrangian perspective observes an individual fluid parcel as it moves through space and time, 2) the Eulerian perspective focuses on specific locations, observing the fluid flow past that location over time. Eulerian methods characterize water circulation on the reef using bottom-mounted instruments to record wave height and period, current speed and direction, and/or tidal elevation (Presto et al., 2006; Storlazzi et al., 2009), however, collecting high spatial resolution data of hydrodynamic processes using strictly Eulerian methods is expensive and logistically difficult (Curt D. Storlazzi et al., 2006; Storlazzi et al., 2004).  Spatially distributed wave height, current speeds, and flow patterns can be predicted by hydrodynamic computer models (Hoeke et al., 2011), but models typically require accurate bathymetry, detailed forcing data, and significant modeling expertise (Hoeke, 2010; King et al., 2012; Wolanski et al., 2009). While imagery-based remote sensing is useful to map the temporal and spatial distribution of flood plume boundaries (Klemas, 2012; Warrick et al., 2007), the underlying current circulation is a strong control on sediment transport that may not be quantified by even high resolution remote sensing of plumes. Instead, Lagrangian methods including the use of GPS-tracking drifters have been used to map flow patterns over reef flats to compare to Eulerian descriptions of flow speeds (C. D. Storlazzi et al., 2006; Storlazzi et al., 2004; Wyatt et al., 2012) or validate hydrodynamic computer models (Ouillon et al., 2010). For this study, Lagrangian drifters were used to collect spatially distributed data on flow velocities, in conjunction with Eulerian current profilers at fixed locations to collect long-term data in relation to forcing conditions.")

document.add_paragraph("Drifter studies in nearshore environments are typically limited in number of drifters, number of deployments, and the range of oceanic and meteorological conditions experienced during deployments, making it uncertain whether they describe the dominant patterns, or short-lived anomalies (C. D. Storlazzi et al., 2006; Wyatt et al., 2010).  While Lagrangian measurements provide spatially explicit data on the flow field, observations are limited temporally by their short duration times relative to Eulerian methods like in situ current meters. Storlazzi et al., (2006) successfully combined Eulerian and Lagrangian methods by comparing Lagrangian drifter tracks with progressive vectors of cumulative flow calculated from Eulerian current meters to determine if short-term observations from drifters were representative of the dominant patterns. This approach yields spatially distributed flow data from the Lagrangian drifters, within the context of the longer time series of flow forcing from the Eulerian methods.")

## Lagrangian measurements (GPS-logging drifters)
document.add_heading('Lagrangian measurements (GPS-logging drifters)',level=3)
document.add_paragraph("GPS-tracking drifters have been traditionally used to characterize oceanic circulation in the deep or coastal ocean (Davis, 1991; Warrick et al., 2007), but cheaper, smaller GPS technology has recently made it possible to deploy many small drifters in nearshore environments to map flow patterns at finer spatiotemporal resolution (Austin and Atkinson, 2004; Johnson et al., 2003; MacMahan et al., 2010). Research on rip currents in beach surf zones have shown the ability to capture synoptic measurements of small-scale flow structures and patterns by deploying large numbers of GPS-logging drifters to collect high-density observations of flow velocities (Johnson et al., 2003; MacMahan et al., 2010). While deploying a fleet of GPS-logging drifters has yielded synoptic measurements of water movement in surf zones near linear, sandy beaches, it has not been attempted in a shallow reef environment.")

document.add_paragraph("Faga'alu Bay is a relatively small area (0.25km2) so very high density drifter data could be collected with a small number of drifters (n=5) and field personnel (n=1). Drifter designs typically involve the use of a suspended drogue (Johnson et al., 2003; Ouillon et al., 2010) or a finned tube (MacMahan et al., 2009) to extend into and anchor the drifter in the water column. However, due to the shallow conditions experienced on reef flats a novel drifter design was needed. Drifters for shallow coral reef environments need to be shallow enough to avoid interaction with corals, deep enough to not be affected by the surface movements, extend high enough to be visible but not high enough to be affected by winds, and finally, rugged enough to sustain the impact of a breaking wave onto the reef in the event it is entrained in the surf zone.")
document.add_paragraph("Five drifters were designed and constructed with materials avaialable on-island, from PVC tubing and plastic sheeting, with a small waterproof housing for the GPS recorder (HOLUX M1000), and a float collar to maintain upright orientation (Figure "+Drifter_ADCP_pics['fig_num']+"). The fins of the drifters were roughly 300 mm wide and 180 mm in height, constructed of 13mm diameter PVC pipe and elbows, with holes drilled to flood the piping and compensate for the buoyancy of the pipe. The GPS logger was housed in a PVC housing comprised of an end cap, a short piece of 50 mm diameter pipe, a threaded female adapter and a threaded plug. A hole was drilled in the plug to accomodate a stainless steel hose clamp for attaching the logger housing to the fins, and the hole was plugged with epoxy. The drifters were transported to the launch zones and retrieved using a stand-up paddle board (SUP) which had advantages over motorized craft or kayaks due to the low cost, single man operation, shallow draft, and better visibility to track the drifters. Drifter velocities and trajectories are calculated using a forward-difference scheme on the drifter locations (Davis, 1991; MacMahan et al., 2010).")

## Pics of drifters and ADCP
if 'Drifter_ADCP_pics' in locals():
    document.add_picture(Drifter_ADCP_pics['filename'],width=Inches(6))
    add_figure_caption(Drifter_ADCP_pics['fig_num'],"TOP: Images of the shallow-water drifters on land, and deployed in the field. BOTTOM: Images of the acoustic current profilers deployed on the southern reef flat (AS1).")

## Eulerian measurements (ADCP's)
document.add_heading('Eulerian measurements (ADCP)',level=3)      
document.add_paragraph("Three Nortek Auqadopp 2-MHz acoustic current profilers recorded tide, wave and current data at three locations on the reef flat in Faga'alu for one week (Figure "+Study_Area_map['fig_num']+"). The profilers were attached to cinder block anchors and placed on sand or rubble patches amongst the corals, as deep as possible to maintain adequate water levels over the profiler during low tide (Figure "+Drifter_ADCP_pics['fig_num']+"). The profilers collected 580 current samples at 2 Hz every 10 min and 2048 wave samples at 2Hz ever 60 min. On the northern reef, the water level dropped below the minimum blanking distance of the current profilers at low tides, and flow was assumed to be nearly zero during these times given the relatively low water depth relative to the height of the corals.")

## Analytical Methods
document.add_heading('Analytical Methods',level=3)
document.add_paragraph("Two techniques were used to compare the drifter results with the profiler results: Empirical orthogonal functions (EOF) and progressive vectors of cumulative flow. Considering the speed and bearing of the drifter movement at each time step as an independent observation of the flow, the EOF's identify the dominant modes of flow in the spatial domain. EOF principal axes and variance ellipses were calculated for spatially binned drifter data (100 m x 100 m) and compared to the EOF's calculated from profiler data, for each of the three forcing conditions: Tides, Strong Winds, and Strong Waves. More circular variance ellipses indicate that flow directions are more variable while more ellipsoid variance ellipses indicate flow is dominantly in the direction of the major principal axis. Progressive vectors of the profiler data, which are cumulative summations of flow assuming spatial homogeneity, were compared to the drifter data. Drifter tracks were limited to 1 hr and compared with progressive vectors calculated from the profiler data for the corresponding time period.")
document.add_paragraph("The mean velocity of drifters was calculated for each 100 m x 100 m spatial bin (MacMahan et al., 2010) and used to compare flow patterns, and to calculate water residence time over the reef under different forcing conditions. Where drifters did not travel through a spatial bin, no residence time could be calculated.")
    
## Forcing: Wave, Wind and Tide data
document.add_heading('End-member Forcing: Wave, Wind and Tide data',level=3)
document.add_paragraph("Drifter deployments were conducted opportunistically to capture "+'"end-member"'+" conditions for all combinations of High-Low waves, High-Low wind (offshore and onshore), and High-Low tide (Presto et al., 2006). Multiple daily deployments were scheduled during one randomly selected week, 2/15/14-2/23/14, coinciding with ADCP deployment to facilitate direct comparisons of Eulerian and Lagrangian flow measurements under tide, wind and wave forcing conditions. End member conditions were defined post-deployment using modeled and in situ data on wave, wind, and tide conditions. End-member forcing conditions are somewhat qualitatively defined, based on available data, but covered the commonly occuring range of forcings recorded at the study site (Thompson and Demirbilek, 2002; Vetter, 2013).") 
## Wave data
document.add_paragraph("Data on wave conditions was recorded by a NIWA Dobie-A wave/tide gauge (DOBIE) deployed on the southern reef slope at 10m depth (Figure "+Study_Area_map['fig_num']+"). The DOBIE sampled a 512s burst at 2Hz at the top of every hour. The DOBIE malfunctioned and recorded no data coinciding with the ADCP deployment, but showed good comparison with NOAA WaveWatchIII (WW3) modeled data on swell height and direction for the recorded data (Hoeke et al., 2011). Swell height and direction from NOAA's WW3 model, calibrated to wave data recorded in situ by the DOBIE wave/tide gauge, were used to define the end-member conditions.")
## Wind data
document.add_paragraph("Wind speed, wind direction, barometric pressure, and precipitation were recorded at 15min. intervals during the study, using a Davis VantagePro weather station installed near the stream mouth, approximately 5m above sea level on a pole mounted to a building (WxStation, Figure "+Study_Area_map['fig_num']+"). Meteorological and tide data was also recorded at a NOAA NDBC station (NSTP6), 1.8km north. Wind speed, wind direction, barometric pressure, and tidal elevation were recorded at NSTP6 at 6min. intervals. For this study, wind conditions are sufficiently described qualitatively so the topographic effects on wind speed and direction recorded at the stations are considered inconsequential (Storlazzi et al., 2004)")

#### RESULTS and DISCUSSION ####
results_title = document.add_heading('Results and Discussion',level=2)
## Forcing: Wave, wind, tide during ADCP deployment
document.add_heading('Forcing: Wave, wind, tide during ADCP deployment',level=3)

### Forcing data
if 'Forcing_data_timeseries' in locals():
    document.add_picture(Forcing_data_timeseries['filename'],width=Inches(6))
    add_figure_caption(Forcing_data_timeseries ['fig_num'],caption="Time series of physical forcing: Tide stage, wind speed, wind direction from NDBC station NSTP6, wave height and direction from NOAA WW3. Day 47=16 Feb 2014, Day 54=23 Feb 2014.")
    
document.add_paragraph("A large range of wind and wave conditions and combinations was sampled during the ADCP deployment (February 15-23, 2014), including a high onshore wind event, a high SE groundswell event, and low winds from variable directions where tidal forcing was dominant (Figure "+Forcing_data_timeseries ['fig_num']+"). The deployment period of the ADCP and intensive drifter deployments can be separated into three distinct time periods: 1) Low swell, High onshore wind (Day 47-49)="+'"WIND"'+", 2) Low swell, Low wind (Day 50-51)="+'"TIDE"'+", and 3) High swell, Low wind (Day 52-Day 55)="+'"WAVE"'+" (Table "+Endmember_table.table_num+"). Average wind speed reached a maximum of 9m/s (17knots) with maximum gusts of to 14m/s (28knots) from the NE-SE on February 17, 2014 (Day 48). Swell height during WAVE reached 1.3m (Day 52), which is near the annual maximum height expected for this location (Vetter, 2013).")

## Table: End member definitions
if 'Endmember_table' in locals():
    dataframe_to_table(df=Endmember_table,table_num=Endmember_table.table_num,caption="End member periods",fontsize=9)
document.add_paragraph("**Note: Local time is UTC-11 so local dates are actually one day earlier (e.g. Tide=2/18-2/19 Local time)")

## Eulerian Measurements (ADCP)    
document.add_heading('Eulerian Measurements (Acoustic Doppler Current Profilers)',level=3)
document.add_paragraph("Three Nortek Aquadopp ADCP were supplied by the USGS Pacific Water Science Center in Santa Cruz, CA, and deployed on the reef flat in Faga'alu for one week: February 15-23, 2014 (Figure "+Study_Area_map['fig_num']+"). On the Northern reef the water level dropped below the minimum blanking distance of the ADCP at low tides (Figure "+ADCP_measurements['fig_num']+"d), and flow is assumed to be nearly zero during these times given the relatively low water.")

## ADCP measurements
if 'ADCP_measurements' in locals():
    document.add_picture(ADCP_measurements['filename'],width=Inches(6))
    add_figure_caption(ADCP_measurements['fig_num'],caption="Time series of the resulting flow measured by the acoustic current profilers. Water depths at low tide were too shallow to measure flow data at AS3. Note the variations in current speeds both in space and time due to the different forcing conditions.")    
    
document.add_paragraph("The highest velocity flow was observed over the most southern part of the reef (AS1), in a dominant northwesterly direction for the entire deployment, indicating the strong influence of even small  breaking waves over the reef crest. The portion of the reef crest adjacent AS1 receives the most wave energy in Faga'alu, and flow from the reef further to the south of AS1 (at Fatumafuti) is open to an even wider window of swell directions to the south and southwest. High velocity flows were also observed at AS2, though not as consisently as at AS1, and in a dominantly southwesterly direction, reflecting the relative orientation of the reef crest and shore. Whereas the flow at AS1 is deflected by the shore, turning the cross-reef flow of water north toward the deeper parts of the bay and main channel, the flow at AS2 is primarily shoreward into the deep pools in the middle of the reef flat before turning into the main channel. It would seem that flow over the southern reef would flow directly into the main channel, however this flow is deflected away from the main channel, shoreward. This deflection is caused by wave energy refracting and surging into the main channel, pushing southward from the main channel onto the soouthern reef. Flow data at AS1 also illustrate the modulating effect of tidal stage on flow speed similar to Storlazzi et al., (2004). During Days 52 to 55 a decrease in flow speed is observed coinciding with the low tide. As the tide level decreases, less wave energy propagates over the reef crest and friction and turbulence over the reef increases. This effect is still observed, but is smaller in magnitude at AS2 because the water depth is higher and the coral elevation is lower at AS2.")

document.add_paragraph("Flow direction and velocities at AS1 were fairly consistent during all endmember conditions, whereas flow direction and velocities were more variable at AS2 and varied most strongly with higher wave conditions. As swell direction turns more easterly (Figure "+Forcing_data_timeseries['fig_num']+"), more wave energy is incident upon the northern portion of the southern reef. Under tidal influence or offshore winds in the absence of strong waves there is potential for cross-reef flow directions. When the swell was larger the flow at AS2 was higher in velocity and more dominantly towards shore. Flow velocities were most variable at AS3 on the northern reef, and while flow direction and velocity at AS1 and AS2 were mostly influenced by wave conditions, flow at AS3 did not show strong correlation with any of the endmember forcing conditions.")

## Lagrangian Measurements (GPS-logging Drifters)
document.add_heading('Lagrangian Measurements (GPS-logging Drifters)',level=3)
document.add_paragraph("Thirty drifter deployments were conducted from January to February, 2014, with twenty-two of those deployments coinciding with ADCP deployment, February 15-23, 2014 (Table "+Drifter_deployment_table.table_num+"). Five drifters were released from the same five launch zones  at the beginning of each deployment, and allowed to drift until they exited the main channel to Pago Pago Harbor (Figure "+Study_Area_map['fig_num']+"). Drifter position data was recorded by the HOLUX-M1000 GPS logger at 5 second intervals and resampled to 1 minute intervals to reduce signal noise. Drifters were allowed to drift until they exited the main channel but tracks were limited to 1 hr for analysis. Drifter speed and bearing were calculated using a forward difference scheme and gridded in 100 m x 100 m bins.")

## Table: Drifter deployments dates and conditions
if 'Drifter_deployment_table' in locals():
    dataframe_to_table(df=Drifter_deployment_table,table_num=Drifter_deployment_table.table_num,caption="Drifter deployment dates and conditions. Red numbered Deployments coincide with ADCP deployment",fontsize=9)
    
document.add_paragraph("Three general spatial patterns were evident (Figure "+ALL_Drifter_tracks['fig_num']+"): 1) Faster onshore transport speeds (lower residence times) over the southern reef flat, 2) Slower, more variable currents (longer residence times) over the deeper inshore portion of the reef flat and inner portion of the embayment that converge on the inshore side of the main channel, and 3) Faster offshore transport speeds (lower residence times) over the offshore side of the main channel. Only a few drifters traveled seaward across the reef crest, mainly exiting through a subtle depression in the southern reef crest, and these only occurred at high tide under calm wave and wind conditions. Other anomalous drifter tracks show where drifters were entrained in the surf zone at the reef crest and quuickly exited back out to sea (far northeast in the study area).")

if 'ALL_Drifter_tracks' in locals():
    document.add_picture(ALL_Drifter_tracks['filename'],width=Inches(6))
    add_figure_caption(ALL_Drifter_tracks['fig_num'],caption="Map of all drifter tracks, colored by speed, recorded during the experiment.")
    
document.add_paragraph("")

## Comparing Eulerian and Lagrangian Measurements
document.add_heading('Comparing Eulerian and Lagrangian Measurements',level=3)

# Progressive Vectors
document.add_heading('Progressive Vectors',level=4)
document.add_paragraph("A series of 1 h progressive vector diagrams of projected cumulative flow were computed from ADCP data (Storlazzi et al, 2006) collected during each end member condition period. Progressive vectors are calculated assuming spatial homogeneity of the flow, causing them to move onshore in some instances. The progressive vectors from ADCP data mainly illustrate how variable the flow velocity is at a fixed point over time: a progressive vecotr moving in a straight line indicates flow direction at the instrument does not change over time. The progressive vectors for AS1 and AS2 show little variation in flow direction, indicating the flow velocity is consistent (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). The progressive vectors for AS3 are much more erratic, and travel relatively shorter distances due to the lower flow speeds observed over the northern reef.")

document.add_paragraph("The drifter tracks, compared to the progressive vectors, show the spatial heterogeneity of the flow pattern as the water flows over the reef flat, turns parallel to shore and into the deep channel (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). Under tidal forcing the drifter tracks over the northern reef are highly erratic, but travel longer distances than under strong onshore winds (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"b). This indicates that under tidal forcing water movement is variable over the reef but strong winds push water into the northwest corner of the embayment, piling up water over the northern reef and increasing residence time. Drifter tracks crossing the reef crest are observed over the southern reef under tidal forcing, in the absence of breaking waves that would strongly force water flow across the reef, preventing seaward flow. Under strong wave conditions (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e), a more coherent, clockwise flow pattern is observed over both the northern and southern reef as large breaking waves force large amounts of water onto the reef flat, driving flow quickly across the southern reef flat and into the main channel. Despite waves breaking on the the northern reef crest, it appears the flow across the southern reef and into the main channel influences an overall eastward flow over the northern reef and out the main channel (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e).")

if 'Progressive_Vectors_ADCP_vs_Drifters' in locals():
    document.add_picture(Progressive_Vectors_ADCP_vs_Drifters['filename'],width=Inches(6))
    add_figure_caption(Progressive_Vectors_ADCP_vs_Drifters['fig_num'],caption="Progressive vectors calculated from ADCP data, compared to actual Lagrangian drifter tracks under different forcing conditions. ") 

# EOF's
## PCA Plots of all drifter data, in 100m bins, color ellipses by number of observations
document.add_heading('Empirical Orthogonal Functions (EOF)',level=4)

document.add_paragraph("EOF's and mean flow velocity were calculated from ADCP data collected during each end member condition period. Variance ellipses are more ellipsoid at AS1 and AS2, and more circular at AS3, under all forcing conditions. Similar to the progressive vectors, this indicates the current  is more unidirectional at AS1 and AS2, flowing in the direction of the main principal component axis. Currents at AS3 are more variable in direction and lower in magnitude, as indicated by the lower mean flow velocity arrows (Figure "+PCA_gridded['fig_num']+").")

## Gridded EOF by endmembers
if 'PCA_gridded' in locals():
    document.add_picture(PCA_gridded['filename'],width=Inches(6))
    add_figure_caption(PCA_gridded['fig_num'],caption="EOF's calculated from ADCP data, compared to EOF's calculated from spatially binned (100m x 100m grid cell) Lagrangian drifter data under different forcing conditions. Drifter EOF's are colored by number of observations to illustrate varying data density depending on grid cell.")    

document.add_paragraph("Drifter data was spatially binned and EOF's and mean flow velocity were calculated for each 100m x 100m grid cell (Figure "+PCA_gridded['fig_num']+"). Due to their spatial position relative to the flow pattern, some grid cells had a much higher number of observations, especially those grid cells in the middle parts of the bay. More observations suggests more certainty in observed patterns, while some of the outlying grid cells with a small number of observations may have been influenced by an anomalous drifter track. However, the overall pattern of drifter tracks is similar to the results from corresponding Eulerian results: Flow over the southern reef is driven by cross-shore wave-driven transport which flows northward to the main channel. However, while it may be hypothesized that water flows into the main channel and out to sea, the Eulerian data from the ADCPs' suggests all flow is into the bay. Finer resolution drifter data resolves the general counterclockwise flow from the southern reef, over the northern reef and out to sea. The drifter data also illustrates the decreased flow velocity near shore and in the deeper pools on the reef flat. The drifter data also illustrate the increase in flow velocity moving seaward in the main channel. Under both wave and tide forcing, the velocity steadily increases in the main channel, reaching a maximum at the reef crest. The same pattern is not evident under wind forcing, possibly due to wind driven flow being forced into the bay at the surface, but the data density is too low to be sure. Hench (2008) vertically binned ADCP data in Moorea showed that under low wave forcing surface currents were lower in the reef pass, and could reverse near the bottom. The increase in flow is either caused by the increasing volume of water contributed by the reef flats on either side or a narrowing of the channel cross-section. Either way the increase is notable for it's implications for placing a Eulerian ADCP at a fixed point in the channel, and using data from that one point to define flow for the whole bay.")


## Gridded velocity by endmembers
document.add_heading('Mean flow speed and direction in 100m gridded cells under Wind, Wave, Calm conditions',level=4)
document.add_paragraph("Drifter data was spatially binned and mean flow velocity was calculated for all drifter tracks under each forcing condition (Figure "+Gridded_Velocity_endmembers['fig_num']+"). Over the whole bay, mean flow velocity varied from 1-37 cm/s, 1-36 cm/s, and 5-64 cm/s under tidal, wind, and wave forcing, respectively. Vetter (2013) observed flow speed in the main channel of 1-60 cm/s, with a mean of 14 cm/s. Drifter observations in the gridcell corresponding to Vetter's (2013) ADCP location showed flow speeds of 1-30 cm/s wtih a mean of 8 cm/s, for all forcing conditions. Vetter's (2013) ADCP time series shows lower flow speeds in the channel Jan-April than duriung the more active tradewind season June-October so it is likely that the drifter deployments included more quiescent distribution of days than occur during the whole year. While one large swell event was sampled during the drifter deployments, these conditions appear to be more common during the year than were observed during the one intensive week of drifter deployments. Also, Vetter's (2013) ADCP data ampled the full depth of the water column, as opposed to just the surface current that could be affected by winds, especially when strong east winds blow into the bay. This suggests that perhaps Eulerian and Lagrangian methods are more comparable in shallow depths, where the drifter is influenced by a relatively larger portion of the water column.")

if 'Gridded_Velocity_endmembers' in locals():
    document.add_picture(Gridded_Velocity_endmembers['filename'],width=Inches(6))
    add_figure_caption(Gridded_Velocity_endmembers['fig_num'],caption="Drifter tracks and calculated mean velocity, colored by speed for different forcing conditions. Cells with no drifter observations are left empty.") 

document.add_paragraph("The overrall pattern of mean flow speeds and flow directions shows a strong clockwise circulation through the bay with higher flow speeds during wave forcing conditions, compared with tidal and wind forcing. The west-northwest flow directions over the southern reef remain nearly constant under all forcing conditions, but the flow speeds are highest under wave forcing and lowest under tidal forcing. Over the northern reef, however, mean flow directions are more variable, reversing and flowing towards the river mouth under strong onshore winds and tidal forcing. The drifter tracks for wind and wave forcing show nearly stationary drifter tracks over the northern reef, and only make alot of progress once they are entrained in the seaward flow of the main channel. ")


    
document.add_paragraph("")    

## Residence Times for 100m bin grid
document.add_heading('Residence Times from drifter observations', level=4)

document.add_paragraph("Residence times for 100m x 100m grid cells were computed from the mean flow speeds calculated from drifter data under different forcing conditions (Figure "+Gridded_ResidenceTime_endmembers['fig_num']+"). Residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.56-0.04 hr under tidal, wind, and wave forcing, respectively. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment.")

if 'Gridded_ResidenceTime_endmembers' in locals():
    document.add_picture(Gridded_ResidenceTime_endmembers['filename'],width=Inches(6))
    add_figure_caption(Gridded_ResidenceTime_endmembers['fig_num'],caption="Residence time calculated from mean velocity of drifters under endmember conditions")    

#### CONCLUSION
conclusion_title=document.add_heading('Conclusion',level=2)
conclusion_text = document.add_paragraph("The bay-wide mean current speeds (residence times) varied from 1-37 cm/s (2.78-0.08 hr), 1-36 cm/s (2.78-0.08 hr), and 5-64 cm/s (0.56-0.04 hr) under tidal, wind, and wave forcing, respectively. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment. These circulation patterns cause the spatial pattern of suspended sediment plumes observed in timelapse imagery. The spatial flow pattern and longer residence times result in greater exposure (=intensity x duration) of the corals in these areas to sediment stress and likely causes the reduced coral health in these locations. ")

#### Appendix
document.add_page_break()
document.add_heading('APPENDIX',level=2)
## Appendix stuff goes here...

## Save Document
document.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation.docx')

## Clean up any open figures
plt.close('all')

