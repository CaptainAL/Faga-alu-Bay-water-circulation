# -*- coding: utf-8 -*-
"""
Created on Wed Mar 18 06:26:25 2015

@author: Alex

this paper is different than the Fagaalu-SSY paper because the figures are combined with figures from a collaborator
in this case the figures are generated by other scripts and manually combined with the collaborators figures
these cannot be automated but the scripts have README's associated with the figures.

"""
#### Import modules
## Data Processing
import os
import numpy as np
import pandas as pd
#import math
import datetime as dt
import matplotlib.pyplot as plt
#### Plotting Tools
import matplotlib.pyplot as plt
import matplotlib as mpl
plt.ioff()
plt.close('all')

## Python docx
from docx import *
from docx.shared import Inches
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.style import WD_STYLE_TYPE
from docx.dml.color import ColorFormat
from docx.shared import RGBColor

## Set Directories
git=True
if git==True: ## Git repository
    maindir = 'C:/Users/Alex/Documents/GitHub/Faga-alu-Bay-water-circulation/' 
    datadir=maindir+'Data/'
    trackdir = maindir+'Data/AllTracks/'
    GISdir = maindir+'Data/DriftersGIS/'
    figdir = maindir+'Figures/fromAlex/'
    dirs={'main':maindir,'data':datadir,'track':trackdir,'GIS':GISdir,'fig':figdir}
elif git!=True: ## Local folders
    datadir = 'C:/Users/Alex/Desktop/'
    trackdir = 'samoa/DRIFTERS/AllTracks/'


##  Create Document
document = Document()
tables_and_figures = Document()

## Body Style
document.styles['Normal'].font.name = 'Times'
document.styles['Normal'].font.size = Pt(12)
document.styles['Normal'].paragraph_format.first_line_indent = Inches(0.5)
document.styles['Normal'].paragraph_format.line_spacing = 2

tables_and_figures.styles['Normal'].font.name = 'Times'
tables_and_figures.styles['Normal'].font.size = Pt(12)
tables_and_figures.styles['Normal'].paragraph_format.first_line_indent = Inches(0.0)

## Heading Styles
## Title
CR_Title = document.styles.add_style('Coral Reefs Title', WD_STYLE_TYPE.PARAGRAPH)
CR_Title.base_style = document.styles['Normal']
CR_Title.font.bold = True
CR_Title.paragraph_format.first_line_indent = Inches(0.0)
CR_Title.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER

## 1
CR_1 = document.styles.add_style('Heading CR1', WD_STYLE_TYPE.PARAGRAPH)
CR_1.base_style = document.styles['Heading 1']
CR_1.hidden = False
CR_1.quick_style = True
CR_1.priority = 1
CR_1.font.name = 'Times'
CR_1.font.size = Pt(12)
CR_1.font.color.rgb = RGBColor(0,0,0)
CR_1.font.bold = True
CR_1.font.all_caps = True
CR_1.paragraph_format.first_line_indent = Inches(0.0)

## 2
CR_2 = document.styles.add_style('Heading CR2', WD_STYLE_TYPE.PARAGRAPH)
CR_2.base_style = document.styles['Heading 2']
CR_2.font.name = 'Times'
CR_2.font.size = Pt(12)
CR_2.font.color.rgb = RGBColor(0,0,0)
CR_2.font.bold = True
CR_2.font.all_caps = True
CR_2.paragraph_format.first_line_indent = Inches(0.0)

## 3
CR_3 = document.styles.add_style('Heading CR3', WD_STYLE_TYPE.PARAGRAPH)
CR_3.base_style = document.styles['Heading 3']
CR_3.font.name = 'Times'
CR_3.font.size = Pt(12)
CR_3.font.color.rgb = RGBColor(0,0,0)
CR_3.font.bold = True
CR_3.font.italic = True
CR_3.paragraph_format.first_line_indent = Inches(0.0)


## Figure Captions
CR_cap = tables_and_figures.styles.add_style('Coral Reefs caption', WD_STYLE_TYPE.PARAGRAPH)
CR_cap.base_style = document.styles['Normal']
CR_cap.paragraph_format.first_line_indent = Inches(0.0)


######## SOME TOOLS
figure_captions = []
def add_figure_caption(fig_num=str(len(document.inline_shapes)),caption=''):
    #manuscript_cap = document.add_paragraph("Insert Figure "+fig_num+" here")
    #manuscript_cap = document.add_paragraph("Figure "+fig_num+". "+caption)
    #manuscript_cap.paragraph_style = 'caption'
    figs_cap = tables_and_figures.add_paragraph("Figure "+fig_num+". "+caption)
    figs_cap.style = 'Coral Reefs caption'
    figure_captions.append("Figure "+fig_num+". "+caption)
    return

table_titles = []
def dataframe_to_table(df=pd.DataFrame(),table_num=str(len(document.tables)+1),caption='',fontsize=11):
    ## Add a place holder in the manuscript
    #manuscript_cap = document.add_paragraph("Insert Table "+table_num+" here")
    #manuscript_cap = document.add_paragraph("Table "+table_num+". "+caption)
    #manuscript_cap.paragraph_style = 'caption'
    
    ## construct table
    try:
        table = tables_and_figures.add_table(rows=1, cols=len(df.columns)) 
        ## Merge all cells in top row and add caption text
        table_caption_cell = table.rows[0].cells[0].merge(table.rows[0].cells[len(df.columns)-1])
        table_caption = table_caption_cell.add_paragraph()
        table_caption.add_run("Table "+table_num+". ").bold=True
        table_caption.add_run(caption).bold=False
        ## Add  header
        header_row = table.add_row().cells
        col_count =0 ## counter  to iterate over columns
        for col in  header_row:
            col.text = df.columns[col_count] #df.columns[0] is the index
            col_count+=1
        ## Add data by  iterating over the DataFrame rows, then using a dictionary of DataFrame column labels to extract data
        col_labels = dict(zip(range(len(df.columns)),df.columns.tolist())) ## create dictionary where '1  to  n' is key for DataFrame columns
        for row in df.iterrows():  ## iterate over  rows in  DataFrame
            #print row[1]
            row_cells = table.add_row().cells ## Add a row to the  table
            col_count  = 0
            for cell in row_cells: ## iterate over the columns in the row
                #print row[1][str(col_labels[col_count])]
                cell.text = str(row[1][str(col_labels[col_count])]) ## and plug in data using a dictionary to  get column labels for DataFrame
                col_count+=1
        ## Format Table Style  
        table.style = 'TableGrid' 
        table.style.font.size = Pt(fontsize)
        table.autofit
        #table.num = str(len(document.tables)+1)
    except:
        pass
    table_titles.append("Table "+table_num+". "+caption)
    return table
    
def add_equation(eq_table):
    t = document.add_table(rows=len(eq_table.rows),cols=len(eq_table.columns))
    t.rows[0].cells[1].text = eq_table.rows[0].cells[1].text
    t.rows[0].cells[2].text = eq_table.rows[0].cells[2].text   
    if len(eq_table.rows)>1:
        t.rows[1].cells[0].merge(t.rows[1].cells[2]).text = eq_table.rows[1].cells[0].text
    t.style = 'TableGrid'   
    t.autofit
    return t
###################################################################################################################################################################    


#### TABLES ###########################################################################################################################
table_count=0
def tab_count():
    global table_count
    table_count+=1
    return str(table_count)

Endmember_table= pd.DataFrame()
Endmember_table.table_num =str(tab_count())    
    
## Table comparing ADCP and Drifter speeds
## Table is in an excel book, saved as a pdf and added later
compare_drifters_ADCP_speed_res_time = {'filename':maindir+'Figures/compare ADCP drifters.PNG', 'fig_num':str(tab_count())}

## Appendix
table_count=0   
## Drifter deployment dates
def Drifter_deployments_table():
    XL = pd.ExcelFile(datadir+'Drifter deployment checklist.xlsx')
    deployment_table = XL.parse('Table',header=1,index_col=0,parse_cols='C:P',parse_dates=False)
    deployment_table['Deployment'] = deployment_table.index
    deployment_table['Date'] = deployment_table['Date'].apply(lambda x: "{:%m/%d/%Y}".format(x))
    ## Tide start, end, movement
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft']*0.3048 #ft to m
    deployment_table['Tide Start m'] = deployment_table['Tide Start ft'].round(1)
    deployment_table['Tide End m'] = deployment_table['Tide End ft']*0.3048 #ft to m
    deployment_table['Tide End m'] = deployment_table['Tide End m'].round(1)
    deployment_table['Tide movement m'] = deployment_table['Tide movement ft']*0.3048 #ft to m
    deployment_table['Tide movement m'] = deployment_table['Tide movement m'].round(2)
    ## Wind speed, gust direction
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg kts']*0.514 # kts to m/s
    deployment_table['Wind Speed Avg m/s'] = deployment_table['Wind Speed Avg m/s'].round(1)
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max kts']*0.514 # kts to m/s
    deployment_table['Wind Gust Max m/s'] = deployment_table['Wind Gust Max m/s'].round(0)
    deployment_table['Wind Direction Avg deg'] = deployment_table['Wind Direction Avg deg'].apply(int)
    ## Wave height
    deployment_table['Wave Height m'] = deployment_table['Wave Height m']
    ## Combine into table
    deployment_table= deployment_table[['Deployment','Year Day 2014 (local)','Start Time','End Time','Tide Start m','Tide End m','Tide movement m','Wind Speed Avg m/s','Wind Gust Max m/s','Wind Direction Avg deg','Wave Height m']]
    return deployment_table
Drifter_deployment_table = Drifter_deployments_table()
Drifter_deployment_table.table_num = str(tab_count())    


#### FIGURES ########################################################################################################################################################
figure_count=0
def fig_count():
    global figure_count
    figure_count+=1
    return str(figure_count)
    
## INTRODUCTION
#### Study Area Map
Study_Area_map = {'filename':maindir+'Figures/Maps/Drifter LZ ADCP.jpg', 'fig_num':str(fig_count())}

### Pics of Drifters and ADCPs
Drifter_ADCP_pics = {'filename':maindir+'Figures/Pics/ADCP Drifter pics.png', 'fig_num':str(fig_count())}

### Forcing data
Forcing_data_timeseries = {'filename':maindir+'Figures/Forcing/AmSam_ADCPdrifter_Fig_3_forcing_lettered.jpg', 'fig_num':str(fig_count())}

### ADCP measurements
ADCP_measurements = {'filename':maindir+'Figures/ADCP measurements/Figure4_ADCP.png', 'fig_num':str(fig_count())}

### All Drifter tracks
ALL_Drifter_tracks = {'filename':maindir+'Figures/ALL drifter tracks/drifters_all_arrows_speed.png', 'fig_num':str(fig_count())}

### Progressive Vectors vs drifter tracks
Progressive_Vectors_ADCP_vs_Drifters = {'filename':maindir+'Figures/Progressive Vectors/Figure6_progvec_driftervelocity_lettered.png', 'fig_num':str(fig_count())}

## Gridded PCA by endmember
PCA_gridded = {'filename':maindir+'Figures/Gridded PCA endmembers/Figure7_paxes_map_OMC_lettered.png', 'fig_num':str(fig_count())}

#### Gridded velocity by endmember
#Gridded_Velocity_endmembers = {'filename':maindir+'Figures/Gridded velocity endmembers/Fagaalu_velocity-endmembers.png', 'fig_num':str(fig_count())}

### Gridded residence time by endmember
Gridded_ResidenceTime_endmembers = {'filename':maindir+'Figures/Residence Times/Fagaalu_gridded_residence_time_lettered.png','fig_num':str(fig_count())}

###### EQUATIONS ############################################################################################################################################
equation_count=0
def eq_count():
    global equation_count
    equation_count+=1
    return str(equation_count)
    
#Equations = Document(maindir+'/Manuscript/Equations.docx').tables
#
### SSYev = Q*SSC 
#Equation_one = Equations[0].table
#Equation_one.eq_num = eq_count()

##### APPENDIX #################################################################################################################################
#### Appendix
table_count,figure_count,equation_count=0, 0, 0
### Appendix Table One
#Appendix_table_one = table_function() ## function to create table data
#Appendix_table_one.table_num =str(tab_count())

############################################################################################################################################

#### TITLE
document.add_paragraph("Eulerian and Lagrangian measurements of flow and residence time on a fringing reef flat embayment, American Samoa").style = document.styles['Coral Reefs Title']

document.add_paragraph("")

## Authors
document.add_paragraph("by").paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER
document.add_paragraph("")

p = document.add_paragraph("Messina, A.M.")
p.add_run("a*").font.superscript = True
p.add_run(", Storlazzi, C.D.")
p.add_run("b").font.superscript = True
p.add_run(", Cheriton, O.M.")
p.add_run("b").font.superscript = True
p.add_run(", Biggs, T.W.")
p.add_run("a").font.superscript = True
p.paragraph_format.alignment = WD_ALIGN_PARAGRAPH.CENTER
document.add_paragraph("")

p = document.add_paragraph("")
p.add_run("a").font.superscript = True
p.add_run(" San Diego State University, Department of Geography, San Diego, CA 92182, amessina@rohan.sdsu.edu, +1-619-594-5437, tbiggs@mail.sdsu.edu, +1-619-594-0902")
p.paragraph_format.first_line_indent = Inches(0.0)
document.add_paragraph("")

p = document.add_paragraph("")
p.add_run("b").font.superscript = True
p.add_run("  US Geological Survey, Pacific Coastal and Marine Science Center, Santa Cruz, CA 95060, cstorlazzi@usgs.gov, +1-831-460-7521, ocheriton@usgs.gov, +1-831-460-7579")
p.paragraph_format.first_line_indent = Inches(0.0)

document.add_paragraph("scripted terms: km2")
document.add_page_break()
#### ABSTRACT
document.add_paragraph('ABSTRACT').style = document.styles['Heading CR1']
abstract = document.add_paragraph("Hydrodynamic processes on coral reefs are important for nutrient cycling, larval dispersal, temperature variability, and understanding the impacts of terrestrial sediment, nutrients, and contaminants from adjacent disturbed watersheds on coral reef ecosystems. In order to understand the spatial and temporal variability in flow velocities and the resulting residence time of water in the fringing coral reef flat-lined embayment of Faga'alu, on the island of Tutuila in American Samoa, data from acoustic current profilers and surface cruciform drifter deployments were combined with meteorologic data and numerical wave model results. These data and model results, collected over nine days, made it possible to evaluate the relative contribution of tidal, wind, and wave forcing on the flow patterns and resulting residence times of water masses over the reef. Mean residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.55-0.04 h under tidal, wind, and wave forcing, respectively; the lowest residence times were on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the embayment near the streammouth. These results demonstrate the applicability of a hybrid Lagrangian-Eulerian measurement scheme to understand spatially distribued and temporally extensive flow patterns and thus residence time in geomorphically-complex embayments that characterize many reef-lined coasts.")

## Keywords
document.add_paragraph("")
document.add_paragraph('KEYWORDS:').style = document.styles['Heading CR1']
document.add_paragraph("coral reefs, drifters, Water circulation, Residence time").paragraph_format.first_line_indent = Inches(0.0)
document.add_paragraph("")

#### INTRODUCTION
document.add_paragraph('INTRODUCTION').style = document.styles['Heading CR1']
document.add_paragraph("Circulation and residence time of reef waters are significant controls on the chemistry and biology of coral reefs (Lowe and Falter, 2015). Hydrodynamic conditions, including the residence time of waters over the reef flat, are a primary control on sediment dynamics in fringing reef embayments (Draut et al., 2009; Storlazzi et al., 2009) and are important for other biologically important processes like nutrient cycling, larval dispersal, and temperature regimes (Falter et al., 2004; Wyatt et al., 2012). By influencing orbital velocities, bed shear stress, and suspended sediment transport, current circulation is a strong control on the spatial distribution of deposition, resuspension, and dispersal of terrigenous sediment discharged to reefs (Hoitink and Hoekstra, 2003; Storlazzi et al., 2004; Presto et al., 2006; Hoeke et al., 2013). Spatially distributed flow patterns under variable forcing conditions are logistically difficult to quantify, so conservation planning and remediation studies are currently done with coarse estimations of pollutant discharge and distance-based plume models (Klein et al., 2012). An improved understanding of the spatial and temporal variability in flow speeds, flow directions, and residence times of water over corals is needed for understanding sedimentation patterns and impacts to coral health.")

document.add_paragraph("Studies in various coral reef environments adjacent high islands showed current speeds, directions, and residence times over reef flats are controlled by wave, wind, and tidal forcing, depending on the orientation and shape of the reef, relative to the prevailing wave, wind, and tidal climates (Storlazzi et al., 2004; Presto et al., 2006; Hench et al., 2008; Storlazzi and Field, 2008; Hoeke et al., 2011). Variations in reef morphology relative to the orientation of the dominant meteorological and oceanographic forcing can generate heterogeneous waves and currents over relatively small (hundreds of meters) spatial scales, unlike those observed along relatively linear sandy shorelines (Storlazzi et al., 2009; Hoeke et al., 2011, 2013). Current speeds and patterns over reefs exposed to remotely-generated swell are generally dominated by wave forcing (Hench et al., 2008; Hoeke et al., 2011; Vetter et al., 2010), whereas wind forcing dominates reefs protected from swell (Yamano et al. 1998; Presto et al., 2006). Tidal elevation modulates both wave-driven currents by controlling the reef crest depth and subsequent wave energy propagation into the reef flat, and wind-driven currents by regulating water depth for wind-driven surface wave development (Presto et al., 2006). Reef flat currents in wave-driven environments exhibit a pattern of rapid, cross-shore flow near the reef crest that slows moving shoreward and turns along-shore towards a deep channel where water returns seaward (Hench et al., 2008; Lowe et al., 2009; Wyatt et al., 2010). In wind-driven systems, current directions are more predominantly in the direction of the wind with possible cross-shore exchange from the reef flat to the forereef (Storlazzi et al., 2004).")

document.add_paragraph("Water flow can be quantified in two ways: 1) the Lagrangian perspective observes an individual fluid parcel as it moves through space and time, 2) the Eulerian perspective observes flow past one or more fixed locations over time. Eulerian methods are well-suited to characterizing flows over long periods and a large range of forcing conditions by using bottom-mounted instruments to record wave height and period, current speed and direction, and/or tidal elevation (Presto et al., 2006; Storlazzi et al., 2009). Collecting high spatial resolution data on hydrodynamic processes using strictly Eulerian methods is expensive and logistically difficult (Storlazzi et al., 2006; Storlazzi et al., 2004), so other methods incuding hydrodynamic models, remote sensing, and Lagrangian methods have been used. Hydrodynamic computer models can predict spatially distributed flow (Hoeke et al., 2011), but these models typically require accurate bathymetry, detailed forcing data, and significant modeling expertise (Hoeke, 2010; King et al., 2012; Wolanski et al., 2009). Lagrangian methods including the use of GPS-tracking drifters have been used to map flow patterns in coastal areas, compare to Eulerian flow descriptions (Storlazzi et al., 2006; Storlazzi et al., 2004; Wyatt et al., 2012), or validate hydrodynamic computer models (Ouillon et al., 2010). Research on rip currents in beach surf zones have shown the ability to capture synoptic measurements of small-scale flow structures and patterns by deploying large numbers of GPS-logging drifters to collect high-density observations of flow velocities (Johnson et al., 2003; MacMahan et al., 2010). Although deploying a fleet of GPS-logging drifters has yielded synoptic measurements of water movement in surf zones near linear, sandy beaches, it has not been attempted in a shallow reef environment.")

document.add_paragraph("Whereas Lagrangian measurements provide spatially explicit data on the flow field, drifter studies in nearshore environments are typically limited in number of drifters, number of deployments, and the range of oceanic and meteorological conditions experienced during deployments, making it uncertain whether they describe the dominant patterns, or short-lived anomalies (Storlazzi et al., 2006; Wyatt et al., 2010). Storlazzi et al. (2006) and Andutta et al. (2012) successfully combined Eulerian and Lagrangian methods to investigate transport patterns between adjacent reefs and islands by comparing Lagrangian drifter tracks with progressive vectors of cumulative flow calculated from Eulerian current meters to determine if short-term observations from drifters were representative of the dominant patterns.")

# USCRTF mitigation work 
document.add_paragraph("In August 2012, Faga'alu Bay on the island of Tutuila in American Samoa, was chosen by the US Coral Reef Task Force (USCRTF) as a priority watershed site for the Watershed Partnership Initiative (WPI). The WPI is an active effort of the USCRTF to reduce land-based sources of pollution by facilitating and enhancing coordination, partnerships, and contributions of US Federal agency resources and expertise to implement geographically specific integrated activities to reduce pollutant loads to coral reef ecosystems. Sediment mitigation efforts are underway to reduce sediment loading to Faga'alu Bay from the anthropogenically-disturbed areas, and other studies monitoring sediment loading from Faga'alu Stream and sediment accumulation on the reef are underway (Holst-Rice et al., 2015).")

document.add_paragraph("Because the exposure of corals to terrestrial sediment effects are a function of the magnitude of sediment loading and the duration of time the corals are exposed to sediment, our goal was to apply both Eulerian and Lagrangian methods to understand the controls on, and spatial patterns of, flow in a bathymetrically complex coral reef-lined embayment. This approach provided insight into the controls on, and elucidated the spatial patterns of, flow within the context of variations in forcing and made it possible to calculate spatially distributed water residence times (duration of exposuure) under different 'end-member' forcing conditions")

#### MATERIALS and METHODS
document.add_paragraph("")
document.add_paragraph('MATERIALS AND METHODS').style = document.styles['Heading CR1']

#### STUDY AREA
document.add_paragraph('STUDY AREA').style = document.styles['Heading CR2']

## Study Area map
if 'Study_Area_map' in locals():
    tables_and_figures.add_picture(Study_Area_map['filename'],width=Inches(6))
    add_figure_caption(Study_Area_map['fig_num'],"Maps of the study area and locations of instrumentation in Faga'alu Bay. Wind speed and direction were recorded at the weather station (Weather Station), acoustic current profilers were deployed at three locations (ADCP) for one week to measure current speed and direction, and GPS-logging drifters were deployed thirty times (January to March, 2014) from five launch zones (Drifter Launch).")
    
# Physical description of the reef
p = document.add_paragraph("Faga'alu Bay, on the island of Tutuila, American Samoa (14.290 S, 170.677 W) is a V-shaped, reef-fringed embayment at the mouth of a small (2.48 km2), steep-sided watershed (Figure "+Study_Area_map['fig_num']+"). The reef is characterized by a shallow reef flat extending from just off the shore to the reef crest, where it then descends nearly vertically to the deep (>20 m) waters of Pago Pago Bay. Near the reef crest, the reef flat is primarily cemented reef pavement, but within a few 10s of m transitions into thickets of primarily ")
p.add_run("Acropora spp.").font.italic = True
p.add_run("; closer to the shore in the southern back-reef there are areas of deeper (1-5m) sediment-floored pools with coral bommies. An anthropogenically altered, vertical-walled, 5-15 m deep paleo-stream channel ('ava') extends from the mouth of Faga'alu Stream eastward to Pago Pago Bay; this ava channel divides the reef into a larger southern and a smaller northern section. NOAA's National Centers for Coastal and Ocean Science (2005) surveys describe coral coverage varies from less than 10% on the degraded northern reef, to more than 50% on the more intact southern reef. ")

# Description of prevailing wind, wave and tide conditions
p=document.add_paragraph("Faga'alu Bay is situated on the western side of Pago Pago Bay where the surrounding high topography blocks wet-season northerly winds from October-April, but the Bay is exposed to dry-season southeasterly tradewinds and accompanying short-period wind waves during May-September (Craig, 2009). Faga'alu Bay is characterized by a semi-diurnal, microtidal regime where parts of the shallow reef crest and reef flat are exposed at extreme low tides (<0 m MSL; Vetter, unpublished). Faga'alu Bay is only open to a narrow window (south-southeast) of swell directions, and swells approaching from a southerly angle must refract to the west, reducing their energy. Offshore significant wave heights (")
p.add_run("H").font.italic=True
s= p.add_run("s")
s.font.italic, s.font.subscript = True, True
p.add_run(") from southerly and southeasterly directions are generally less than 2.5 m and rarely exceed 3.0 m. Peak wave periods (")
p.add_run("T").font.italic=True
s = p.add_run("p")
s.font.italic, s.font.subscript = True, True
p.add_run(") are generally about 9 s or less, rarely exceed 13 s, but occasionally reach 25 s during austral winter storms (Thompson and Demirbilek, 2002). During 2013, Vetter (unpublished data) recorded peak significant wave heights on the fore reef in Faga'alu up to 1.7 m, but wave heights greater than 1.0 m were rare. Tropical cyclones can cause high, destructive waves and storm surge (Militello et al., 2003). Cycones in the South Pacific typically occur from November-April, and have impacted American Samoa every 1-13 years recently (1981-present) (Thompson et al., 2002; Craig, 2009). The only available data on current circulation around Tutuila was found in government and consultant reports, and no data on circulation over the reef flat has been collected (CH2M HILL, 1984; Jacob et al., 2012; Wiles et al., 2012).")


#### METHODS
document.add_paragraph("")
methods_title = document.add_paragraph('METHODS').style = document.styles['Heading CR2']

document.add_paragraph("To characterize the spatial flow pattern and determine the relationship between "+'endmember'+" forcing conditions and residence time of water over the reef flats in Faga'alu Bay, a combination of Eulerian and Lagrangian measurements were used. Lagrangian drifters were deployed to collect spatially distributed flow data and Eulerian current profilers were installed at fixed locations to collect long-term flow data in relation to forcing conditions.")

## Pics of drifters and ADCP
if 'Drifter_ADCP_pics' in locals():
    tables_and_figures.add_picture(Drifter_ADCP_pics['filename'],width=Inches(6))
    add_figure_caption(Drifter_ADCP_pics['fig_num']," Images of the oceanographic instrumentation used in the study: a) Shallow-water drifters on land with ruler for scale. b) Shallow-water drifter deployed in the field over the southern reef flat. c) The acoustic current profiler at location AS1. d) The acoustic current profiler deployed at location AS2")
    
## Lagrangian measurements (GPS-logging drifters)
document.add_paragraph("")
document.add_paragraph('Lagrangian Measurements').style = document.styles['Heading CR3']

document.add_paragraph("Due to Faga'alu Bay's relatively small area (0.25 km2), high spatial density drifter data could be collected with a small number of drifters (n = 5) with rapid turn-around. Five cruciform drifters were constructed with materials available on-island (PVC tubing and plastic sheeting), adapted from the design of Austin and Atkinson (2004), with a small waterproof housing for a HOLUX M1000 GPS recorder, and a float collar to maintain upright orientation (Figure "+Drifter_ADCP_pics['fig_num']+"a and b). The fins of the drifters were approximately 30 cm wide and 18 cm in height, constructed of 1.3 cm diameter PVC with holes drilled to flood the piping and compensate for the buoyancy of the pipe. The GPS logger was installed in a PVC housing at the top. The drifters were transported to the launch zones and retrieved using a stand-up paddle board.")

document.add_paragraph("Five drifters were released from the same five launch zones within a 10 min time frame at the beginning of each deployment. Drifter position data was recorded by the GPS logger at 5 s intervals and resampled to 1 min intervals to increase signal-to-noise ratios; speed and direction were calculated using a forward difference scheme on the drifter locations (Davis, 1991; MacMahan et al., 2010). Drifters were generally allowed to drift until they exited the ava channel to Pago Pago Bay, but tracks were limited to 1 h for comparisons with ADCP data.")

## Eulerian measurements (ADCPs)
document.add_paragraph("")
document.add_paragraph('Eulerian Measurements').style = document.styles['Heading CR3']

document.add_paragraph("Three Nortek Aquadopp 2-MHz acoustic current profilers (ADCP) recorded tide, wave, and current data at three locations on the reef flat in Faga'alu for one week (Figure "+Study_Area_map['fig_num']+"). The profilers were deployed on sand or rubble patches amongst the corals, as deep as possible to maintain adequate water levels over the profiler during low tide (Figure "+Drifter_ADCP_pics['fig_num']+"c-d). The profilers collected 580 current samples at 2 Hz every 10 min and 2,048 wave samples at 2 Hz every 60 min.") 

## Ancillary Data
document.add_paragraph("")
document.add_paragraph('Ancillary Data').style = document.styles['Heading CR3']

document.add_paragraph("The instrument deployments were timed to capture end-member forcing conditions that characterize the study area (Yamano et al. 1998). The end member conditions time ranges were defined post-deployment using modeled and in situ wave, wind, and tide data following the methodology described by Presto et al. (2006).") 
## Wave data
document.add_paragraph("Incident wave conditions were recorded by a NIWA Dobie-A wave/tide gauge (DOBIE) deployed on the southern reef slope at a depth of 10 m (Figure "+Study_Area_map['fig_num']+"). The DOBIE sampled a 512s burst at 2 Hz every hour. The DOBIE malfunctioned and recorded no data coinciding with the ADCP deployment, but compared well (not shown) with NOAA/NCEP Wave Watch III (WW3; Tolman, 2002) modeled data on swell height and direction for the recorded data (Hoeke et al., 2011). WW3 model data, calibrated to DOBIE wave data, were used to define forcing during the ADCP and drifter deployments.")
## Wind data
document.add_paragraph("Wind speed, wind direction, barometric pressure, and precipitation were recorded at 15 min intervals using a Davis VantagePro weather station installed near the stream mouth, approximately 5 m above sea level on a pole mounted to a building (Figure "+Study_Area_map['fig_num']+"). Meteorological and tide data were also recorded at NOAA's National Data Buoy Center (2014) station NSTP6 located approximately 1.8 km north of Faga'alu. Wind speed, wind direction, barometric pressure, and tidal elevation data were also recorded at NSTP6 at 6 min intervals. For this study, wind conditions are sufficiently described qualitatively so the topographic effects on wind speed and direction recorded at the stations are assumed to be inconsequential.")


## Analytical Methods
document.add_paragraph("")
document.add_paragraph('Analytical Methods').style = document.styles['Heading CR3']

document.add_paragraph("Data from the drifters and ADCPs was subset by end-member forcing condition, and two techniques were used to compare the drifter results with the ADCP results: progressive vectors of cumulative flow and empirical orthogonal functions (EOF).")
## Progressive Vectors
document.add_paragraph("A series of 1 h progressive vector diagrams of cumulative flow were computed from ADCP data following the methodology used by Siegel et al. (2003) and Storlazzi et al. (2006). The progressive vectors were compared to simultaneous drifter tracks to demonstrate the usefulness of drifters for illustrating spatially variable flows compared to projected flow from fixed ADCPs.")
## EOFs, mean current, residence time
document.add_paragraph("EOF principal axes, variance ellipses, mean flow velocities, and residence times were calculated from ADCP data and spatially binned drifter data (100 m x 100 m) following the methodology of MacMahan et al. (2010) for different endmember forcing conditions. Where drifters did not travel through a specific spatial bin, no EOF or residence times were calculated. EOFs and mean flow velocities from drifters and ADCPs were compared to determine if the short-term observations from the drifters were similar to the long-term ADCP observations, and to demonstrate the usefulness of Lagrangian methods for describing spatial flow patterns compared to fixed Eulerian methods. Mean flow velocities were also used to calculate water residence time over the reef under different forcing conditions. For ADCP data, the mean flow speeds under different forcings were used to calculate residence time for a 100 m bin to correspond to the drifter results.")

#### RESULTS ####
document.add_paragraph("")
document.add_paragraph('RESULTS').style = document.styles['Heading CR1'] 
## Forcing: Wave, wind, tide during ADCP deployment
document.add_paragraph('Oceanographic and Meteorologic Forcing').style = document.styles['Heading CR2']

### Forcing data
if 'Forcing_data_timeseries' in locals():
    tables_and_figures.add_picture(Forcing_data_timeseries['filename'],width=Inches(6))
    add_figure_caption(Forcing_data_timeseries ['fig_num'],caption=" Time series of physical forcing data was used to define end-member periods for analysis. a) Tidal stage. b) Wind speed. c) Wind speed and direction. d) Wave height. e) Wave period. f) Wave height and direction. Vectors denote direction "+'"to"'+". Wind data are from NDBC station NSTP6; wave model data are from NOAA WW3. ")

document.add_paragraph("During the period of overlapping ADCP and intensive drifter deployments, 2014 Year Day (YD) 47-55 (15-23 February 2014), a range of tide, wind, and wave conditions was sampled (Figure "+Forcing_data_timeseries ['fig_num']+"). Three distinct periods were observed: (1) a strong onshore wind event wtih small waves; (2) a large southeast swell wtih weak winds; and (3) weak winds from variable directions and no significant wave forcing where tidal forcing was dominant. Three end-member forcings were defined: 1) Small waves and strong onshore winds ('WIND') during 2014 YD 47-49; 2) Small waves and weak winds ('TIDE') during YD 50-51; and 3) Large waves and weak winds ('WAVE') during YD 52- 55 (Table "+Endmember_table.table_num+"). During WIND, average wind speed was 2.6-4.9 m/s with maximum gusts of 14.5 m/s from the northeast to southeast on YD 48. These wind conditions are typical of average wind conditions observed during the winter tradewind season. During TIDE, wind speeds were low to moderate (1.5-3.4 m/s) and wind directions were variable, which is typical during the summer wet season. During WAVE, maximum wave height reached 1.3 m on YD 52, which is near the annual maximum height expected for this location (Vetter, unpublished data).")


## Eulerian Measurements (ADCP)
document.add_paragraph("")    
document.add_paragraph('Eulerian Measurements').style = document.styles['Heading CR2'] 

document.add_paragraph("The three ADCPs on the reef flat recorded data for one week during 2014 YD 47-55. On the northern reef flat (AS3; Figure "+Study_Area_map['fig_num']+"), the water level dropped below the minimum blanking distance of the ADCP at low tides (Figure "+ADCP_measurements['fig_num']+" d), and flow was assumed to be nearly zero during these times given the relatively low water depth relative to the height of the corals, many of which were above the water surface. The short data gap at AS1 on YD 50 was due to the ADCP being anthropogenically disturbed.") 

document.add_paragraph("In general, tidal forcing was characterized by slow flow speeds and more variable directions, wind forcing by slow flow speeds and less variable directions, and wave forcing by the fastest flow speeds and most consistent flow directions. The highest velocity flow was observed over the southernmost part of the reef (AS1) and was oriented predominantly in a northwesterly direction, indicating the strong influence of even small breaking waves over the reef crest (Figure "+ADCP_measurements['fig_num']+"b, e). Flow direction at AS2 was consistently to the southwest, though direction was more variable under tidal forcing, even exhibiting some cross-reef flow to the northeast (Figure "+ADCP_measurements['fig_num']+"c). Flow speed at AS2 was responsive to high winds and high waves, and highest during high waves (Figure "+ADCP_measurements['fig_num']+"e). At AS3, flow directions and speeds were highly variable under all forcing conditions, and exhibited the lowest flow speeds of the three ADCPs (Figure "+ADCP_measurements['fig_num']+"d-e).")

document.add_paragraph("Flow speeds at AS1 and AS2 illustrated the modulating effects of tidal stage on wave-forced flow (Figure "+ADCP_measurements['fig_num']+"e). During wave forcing, and to a lesser degree during wind forcing, flow velocity was highest during high tide and decreased significantly as the tide stage falls. This was most evident at AS1, but was also observed at AS2, during YD 53-55. This effect was noticeably absent or significantly reduced during wind forcing on YD 47-49, and tidal forcing on YD 51-52.")

## ADCP measurements
if 'ADCP_measurements' in locals():
    tables_and_figures.add_picture(ADCP_measurements['filename'],width=Inches(6))
    add_figure_caption(ADCP_measurements['fig_num'],caption=" Time series of acoustic current profilers data on the reef flats a) Tide level at location AS1. b) Current speed and direction at AS1. c) Current speed and direction at AS2. d) Current speed and direction at AS3. d) Current speeds at all three locations. Vectors denote direction "+'"to"'+". AS3, water depths at low tide were too shallow to measure currents. Note the variations in current speeds both in space and time due to the different forcing conditions shown in Figure "+Forcing_data_timeseries ['fig_num']+".")     
    

## Lagrangian Measurements (GPS-logging Drifters)
document.add_paragraph("")
document.add_paragraph('Lagrangian Measurements').style = document.styles['Heading CR2'] 
document.add_paragraph("Thirty drifter deployments were conducted from January to February 2014, with 22 of those deployments coinciding with the ADCP deployments during YD 47-55 (15-23 February; Appendix Table "+Drifter_deployment_table.table_num+"). Drifter tracks from all deployments covered nearly the entire reef flat and ava channel (Figure "+ALL_Drifter_tracks['fig_num']+"), showing three gneral spatial patterns: 1) Faster flow speeds over the southern reef flat; 2) slower, more variable currents over the deeper pools of the southern back-reef, northern reef, and ava channel near the stream mouth; and 3) faster current speeds exiting the east end of the ava channel. Off-reef transport over the reef crest was observed a few times, mainly exiting through a small channel in the southern reef crest at high tide under calm wave and wind conditions; most of these continued moving out to sea and some were quickly re-entrained in the surf zone and traveled landward over the reef flat. Other anomalous drifter tracks show where drifters were entrained in the surf zone at the reef crest and quickly exited back out to sea in the far northeast portion of the study area.")

if 'ALL_Drifter_tracks' in locals():
    tables_and_figures.add_picture(ALL_Drifter_tracks['filename'],width=Inches(6))
    add_figure_caption(ALL_Drifter_tracks['fig_num'],caption="Map of all drifter tracks during the experiment, colored by speed (m/s).")
##    SENTENCE DESCRIBING GENERAL PATTERNS/DIFFERENCES. 
    

# Progressive Vectors
document.add_paragraph("")
document.add_paragraph('Progressive Vectors').style = document.styles['Heading CR2'] 
document.add_paragraph("Progressive vectors were calculated from ADCP data and compared to drifter tracks for each end-member forcing condition (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"). The progressive vectors from the ADCPs illustrate the temporal flow variability at those fixed points during the 1 h drift duration, but progressive vectors are calculated assuming spatial homogeneity of the flow, causing them to move onshore in some instances. Whereas the drifter tracks changed direction from onshore to cross-shore towards the ava channel, the progressive vectors over the southern reef showed little variation in flow direction, going ashore in some cases, indicating the flow velocity was relatively consistent at AS1 and AS2 and demonstrating the non-spatially uniform nature of the flow on the reef flat. The progressive vectors over the northern reef were much more erratic, and traveled much shorter distances than the drifter tracks due to the lower flow speeds observed at AS3. In general, the lengths of progressive vectors were similar to the actual tracks of the drifters, indicating similar flow speeds, albeit sometime different directions, over portions of the reef flat. The exception was over the northern reef, where drifters quickly moved into the ava channel and were influenced by very different currents than what was observed at AS3. Because drifters could only be deployed at mid-high tides when the reef flat was deep enough to avoid getting stuck on corals, the ADCPs recorded flow over the complete tidal range. The shorter progressive vectors indicate flow at lower tides when flow speeds are reduced (Figure "+ADCP_measurements['fig_num']+").")

if 'Progressive_Vectors_ADCP_vs_Drifters' in locals():
    tables_and_figures.add_picture(Progressive_Vectors_ADCP_vs_Drifters['filename'],width=Inches(6))
    add_figure_caption(Progressive_Vectors_ADCP_vs_Drifters['fig_num'],caption=" Progressive vectors calculated from acoustic current profiler (ADCP) data, compared to drifter tracks under end-member forcing conditions: a) ADCP data under tidal forcing. b) Drifter data under tidal forcing. c) ADCP data during strong winds. d) Drifter data during strong winds. d) ADCP data during large waves. f) Drifter data during large waves.  ") 
## SENTENCE DESCRIBING GENERAL PATTERNS/DIFFERENCES.     
    
    
# Tide
document.add_paragraph("Under tidal forcing the drifters traveled in erratic directions and traveled farther than predicted by the progressive vectors from ADCPs, indicating higher flow speeds (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"a-b). Drifter tracks and progressive vectors compared poorly in speed and direction at AS3 on the northern reef, slightly better at AS2 though progressive vectors are still shorter and do not vary direction, and fairly well at AS1 on the southern reef. Under the low wave conditions, drifters were observed to flow seaward over the reef crest near AS2, but only at high tide. Drifters were also observed moving from the northern reef onto the southern reef during light and variable winds.")
# Wind
document.add_paragraph("Under wind forcing, progressive vectors and drifter tracks were shorter than during tide and wave forcing, indicating flow speeds were slower (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"c-d). Though moderate to strong easterly winds are most prevalent throughout the year due to the trade winds, fewer observations were made under wind forcing than tidal or wave forcing so there is less certainty in the observed flow patterns. Also, a drifter deployed at the northeast reef was lost during the WIND period, so no drifter tracks were available from that location. Progressive vectors compared well with drifter tracks in speed and direction for all locations, though the progressive vector at AS3 is still short in comparison to the drifter tracks near the same location. The drifter tracks show a general trend of flow towards the northwest corner of the bay, and suggest flow out of the ava channel (at least at the surface) may be suppressed under strong onshore (easterly) winds.")
# Wave
document.add_paragraph("Under wave forcing, longer progressive vectors at all locations, including the northern reef, indicate significantly faster flow speeds than during wind and tidal forcing (Figure "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"e-f). The progressive vectors on the southern reef mainly indicate onshore flow, even going ashore in some instances. Despite waves breaking on the northern reef crest, it appears the flow across the southern reef and into the ava channel influences an overall eastward flow over the northern reef and out to sea. The drifter tracks clearly indicate a coherent pattern of clockwise flow over the southern reef, through back-reef pools and near the stream mouth, and then seaward over the northern reef and out the ava channel. All drifters exited the channel during the 1 h period, suggesting under high waves the flushing time of the whole bay is under 1 h.")


# EOFs
## EOF Plots of all drifter data, in 100m bins, color ellipses by number of observations
document.add_paragraph("")
document.add_paragraph('Empirical Orthogonal Functions (EOF)').style = document.styles['Heading CR2']

document.add_paragraph("Variance ellipses and mean flow velocities were calculated from ADCP and spatially binned drifter data collected during each end member forcing condition (Figure "+PCA_gridded['fig_num']+"). The number of drifter tracks that traveled through each grid cell differed due to the spatial position of the grid cell relative to the flow pattern. Grid cells in the middle parts of the bay and ava channel had more drifter tracks than grid cells in the outer bay and near the shore. More observations suggests more certainty, whereas some of the outlying grid cells with a small number of observations may have been influenced by an anomalous drifter track or a small range of the end member forcing condition.")

document.add_paragraph("The overall pattern of variance ellipses and mean flow velocities from drifters are similar to the corresponding results from ADCPs. Variance ellipses from both data sources are more ellipsoid on the southern reef at AS1 and AS2, and more circular at AS3, under all forcing conditions. Mean velocities calculated from ADCP data showed similar directions during different forcings but varied in speed, with the highest mean flow speed under high waves (Figure "+PCA_gridded['fig_num']+"e). Finer-resolution drifter data resolved the general clockwise flow from the southern reef, over the northern reef, and out to sea. The drifter data also illustrate the decreased flow velocities close to shore and in the southern back-reef pools. Over the whole bay, mean flow velocities from drifters varied from 1-37 cm/s, 1-36 cm/s, and 5-64 cm/s under tidal, wind, and wave forcing, respectively. For tide forcing, mean velocities calculated from ADCP data were 14.6 cm/s, 5.3 cm/s, and 0.9 cm/s for AS1, AS2, and AS3, respectively. For wind forcing, mean velocities calculated from ADCP data were 11.6 cm/s, 3.9 cm/s, and 1.5 cm/s for AS1, AS2, and AS3, respectively. For wave forcing, mean velocities calculated from ADCP data were 18.1 cm/s, 10.9 cm/s, and 1.21 cm/s for AS1, AS2, and AS3, respectively (Table "+compare_drifters_ADCP_speed_res_time['fig_num']+").")

## Gridded EOF by endmembers
if 'PCA_gridded' in locals():
    tables_and_figures.add_picture(PCA_gridded['filename'],width=Inches(6))
    add_figure_caption(PCA_gridded['fig_num'],caption=" Variance ellipses and mean current vectors for the ADCP data and spatially binned drifter data under different end member forcing conditions. a) ADCP data under tidal forcing. b) Drifter data under tidal forcing. c) ADCP data during strong winds. d) Drifter data during strong winds. d) ADCP data during large waves. f) Drifter data during large waves. Drifter data are colored by number of observations to illustrate the varying data density.")   

#Tide
document.add_paragraph("Compared to wind and wave forcing, the most circular variance ellipses from both ADCP and drifter data were observed under tidal forcing, indicating flow directions were most variable under light, variable winds and low waves. The drifter's variance ellipses were more ellipsoid and mean velocities were higher near the reef crest and on the southern reef, compared to the northern reef and southern back-reef pools. Though flow directions were more variable, mean velocities indicated flow speeds were higher under tidal forcing than wind forcing, but still lower than wave forcing. Whereas the variance ellipses and mean velocities from ADCPs showed exclusively shoreward flow, the variance ellipses and mean velocities from drifters showed clockwise flow across the southern reef and seaward out the ava channel.")

#Wind
document.add_paragraph("The lowest mean flow velocities from both ADCPs and drifters were observed under wind forcing, but the variance ellipses were more ellipsoid than under tide forcing, indicating flow directions were more consistent during strong onshore winds. Similar to tide and wave forcing, the overall flow pattern from the drifters was more variable ellipses and higher velocities over the southern reef, and more circular EOFs and slower velocities in the back-reef pools, ava channel, and northern reef.")

#Wave
document.add_paragraph("The highest mean flow speeds and most ellipsoid variance ellipses were observed under wave forcing, indicating high waves are a strong control on flow velocities in the bay. While flow speeds at AS1 were consistently influenced by even small breaking waves, as wave height increased, breaking waves were observed further north along the reef crest, particularly near the ava channel, increasing flow speeds over the reef flat near AS2. The increased flow near AS2 increased flow speeds near the ava channel and the southern back-reef pools. While the variance ellipses at AS3 was still circular, indicating variable flow directions, the magnitude of the major and minor flow axes were larger than tide and wind forcings, indicating flow speeds were higher during wave forcing. The drifters showed a clear pattern of faster, more unidirectional flows near the reef crest on the southern reef, transitioning to slower, more variable flow over the back-reef pools, and finally turning eastward over the northern reef and seaward out of the ava channel. Mean velocities increased moving seaward through the ava channel, similar to the results under tidal forcing, but due to the low data density outside the reef crest it is unclear whether the flow continues eastward to Pago Pago Harbor or swirls around and is re-entrained in the surf zone on the southern reef.") 
  

## Residence Times for 100m bin grid
document.add_paragraph("")
document.add_paragraph('Residence Time').style = document.styles['Heading CR2'] 

document.add_paragraph("Water residence time over the reef flat was computed from the mean drifter velocities under different forcing conditions (Figure "+Gridded_ResidenceTime_endmembers['fig_num']+"). Residence times varied from 2.78-0.08 hr, 2.78-0.08 hr, and 0.56-0.04 h under tidal, wind, and wave forcing, respectively. The shortest residence times were measured near the southern reef crest, and under high wave conditions in general. The longest residence times were observed over the inner reef flat close to shore and in the northwest corner of the embayment, under tidal and wind forcing.")

if 'Gridded_ResidenceTime_endmembers' in locals():
    tables_and_figures.add_picture(Gridded_ResidenceTime_endmembers['filename'],width=Inches(3))
    add_figure_caption(Gridded_ResidenceTime_endmembers['fig_num'],caption=" Residence time calculated from mean velocity of drifters under endmember conditions. a) Tidal forcing. b) Strong winds. c) Large waves. ")    
## SENTENCE DESCRIBING GENERAL PATTERNS/DIFFERENCES.

document.add_paragraph("To compare the Eulerian and Lagrangian methods, mean flow speed and residence time computed from the ADCP during drifter deployment only, and the corresponding spatially-binned drifter data were compared under different forcing conditions (Table "+compare_drifters_ADCP_speed_res_time['fig_num']+"). Water residence times computed from mean flow velocities at AS1 were 0.34 h, 0.23 h, and 0.16 h, for tide, wind and wave forcing, respectively. Residence times at AS2 were 0.60 h, 0.52 h, and 0.28 h, for tide, wind and wave forcing, respectively. Residence times at AS3 were 1.45 h and 2.72 h, for wind and wave forcing, respectively. No data was recorded by the ADCP at AS3 simultaneously with drifters during tide forcing, due to the low water level during drifter deployments. Mean velocities from the ADCPs were lower than mean velocities from drifters in all cases except for on the southern reef under wind forcing. The RMSE and percent error (RMSE/mean) were computed for all locations during each forcing condition, and for each location under all forcing conditions. The highest percent error for a single location was at AS3 on the northern reef, likely due to the strong heterogeneity in the flow as the drifters moved into the ava channel. The lowest percent error was at AS1 on the southern reef, where the flow is most homogeneous. The percent error for all locations together was lowest for speed during tide forcing, and lowest for residence time during wind forcing.")

## From Olivia: The reason there are no values for AS3 during the "tide" period is because those drifters were only out during very low tide and the ADCP data processing filters out questionable data, which includes times when water levels get low (cutoff ends up being ~0.5 m). This may also explain the general discrepancies between the mean values from the ADCP vs the drifters ... the ADCP data (particularly at AS3) is biased to times when WL's are > 0.5 m.

## Compare ADCP and drifter mean flow speeds and residence times
if 'compare_drifters_ADCP_speed_res_time' in  locals():
    tables_and_figures.add_paragraph("Table "+compare_drifters_ADCP_speed_res_time['fig_num']+". Mean flow speed and residence time computed from the ADCPs and corresponding spatially binned drifter data for different forcing conditions.")
    tables_and_figures.add_picture(compare_drifters_ADCP_speed_res_time['filename'],width=Inches(6))
    
#### DISCUSSION
document.add_paragraph("")
document.add_paragraph('DISCUSSION').style = document.styles['Heading CR1'] 

## General observations

# STATEMENT ABOUT HOW THIS STUDY PRESENTS AN UNPRESCEDENTED DATA SET.
document.add_paragraph("Like the atmospheric climate, global ocean circulation controls large-scale biophysical patterns such as nutrient and heat distributions. However, whereas atmospheric climate and global ocean circulation have benefitted from remote-sensing methods, water circulation over small-scale reef ecosystems are more similar to atmospheric micro-climates, and the long-term, synoptic observations of remote sensing have not been possible. The high number of drifter deployments provided an unprecedented data set for a reef flat area, with high data density, extensive spatial coverage, and wide range of sampled forcing conditions. The bay-wide mean current speeds (residence times) varied from 1-37 cm/s (2.78-0.08 hr), 1-36 cm/s (2.78-0.08 hr), and 5-64 cm/s (0.56-0.04 hr) under tidal, wind, and wave forcing, respectively. The highest flow speeds were consistently observed at AS1 and over the southern reef near the reef crest, suggesting the strong influence of breaking waves, even when the waves were relatively small. Over the northern reef, mean flow directions were more variable, reversing and flowing towards the river mouth under strong onshore winds and sometimes during tidal forcing with variable winds. The lowest flow speeds and highest residence times were consistently observed in the northwest corner of the bay, when wave-driven flow was low or when winds were onshore.")


## Comparing differences in Lagrangian/Eulerian
document.add_paragraph("Both the Eulerian and Lagrangian methods characterized the main difference between the faster, less variable flow over the southern reef and the slower, more variable flow over the northern reef under all forcing conditions. However, where the Eulerian method characterized flows adequately over the southern reef flat where bathymetry and wave forcing were fairly simple, the spatially distributed Lagrangian method more accurately characterized spatially complex flows resulting from complex bathymetry.")

document.add_paragraph("Mean flow directions at the ADCPs were exclusively onshore, but the higher resolution drifter measurements resolved the pattern of clockwise flow over the southern reef and out to sea over the northern reef and through the ava channel. The variance ellipses and mean velocities from ADCPs showed exclusively onshore flow under all forcing conditions, whereas the higher resolution drifter data only showed the same pattern under wind forcing. This suggests that strong onshore winds, in the absence of high waves, drives all surface flows into the northwest corner of the bay, with a notable lack of seaward flow out of the ava channel. However, data density was lowest during wind forcing and perhaps drifter deployments longer than 1 h would have observed seaward flow.")

document.add_paragraph("The spatially distributed drifter measurements also illustrated several unique features in the flow pattern, particularly near areas of complex bathymetry like the ava channel. From the orientation of the reef flat and channel, it would seem that flow over the southern reef near the ava channel would flow directly from the reef crest northward into the main channel. Hoowever the flow near AS2 is deflected away from the ava channel, shoreward to the west where it flows into the back-reef pools and then enters the ava channel. This deflection is likely caused by wave energy refracting and surging into the ava channel, pushing southward from the main channel onto the southern reef.")

document.add_paragraph("Observations on the linear reef flat in Molokai, Hawaii (Presto et al., 2006), showed near-bed current speeds were faster where the reef is deeper and narrower but the variance ellipses and progressive vectors presented here (Figures "+Progressive_Vectors_ADCP_vs_Drifters['fig_num']+"-"+PCA_gridded['fig_num']+") suggest the opposite for surface drifters in this reef-lined embayment: current speeds were rapid over the shallow reef crest, slowing significantly and becoming more variable when reaching deeper back-reef pools and the ava channel. However, flow through the ava channel was not spatially constant. Under both wave and tide forcing, the flow speed through the ava channel steadily increased moving seaward, reaching a maximum at the reef crest. The same pattern was not evident under wind forcing, possibly due to wind driven flow being forced into the bay at the surface, but the data density is too low to be certain. Hench (2008) vertically binned ADCP data in a similarly configured reef in Moorea, and showed that under low wave forcing surface currents were lower in the reef pass and could reverse near the bottom. The increase in flow speed through the ava channel at the study site is either caused by the increasing volume of water contributed by the reef flats on either side or a narrowing of the channel cross-section. Either way, the increase is notable for it's implications for placing a Eulerian ADCP at a fixed point in the channel, and using data from that one point to define flow for all of Faga'alu Bay.")

document.add_paragraph("Compared to Eulerian measurements, the Lagrangian measurements recorded higher mean flow speeds at all locations and during all forcings except for one: on the southern reef during wind forcing (Table 2). Lagrangian measurements are more influenced by processes at the surface, while Eulerian methods make a depth-averaged flow measurement. Surface flows can be faster due to the decreased flow speed near the bottom, or processes related to wind and gravity waves. One source of disagreement between the Eulerian and Lagrangian methods is the potential importance of Stokes drift (Stokes, 1847; Kenyon, 1969). On a 1.5-2 m deep reef flat in Oahu, Hawaii, Falter et al. (2008) found that cruciform drifter speeds exceeded both Lagrangian dye and depth-averaged Eulerian current speeds (which included computed depth-averaged Stokes transport from wave gauge data) by 30-100% on average. A numerical simulation of a water column profile (Delft 3D) predicted drifter speeds at the surface should exceed the depth-averaged current speed plus Stokes drift by 30%, so Falter et al. (2008) attributed the discrepancy to higher Stokes transport near the surface, compared with the depth-averaged Stokes transport. Importantly, while the drifter speeds in Falter et al. (2008) were significantly higher, they did not differ from Eulerian measurements in current direction, and the ratio of Stokes transport to total transport decreased with increasing wave-driven currents. The results presented here show that the difference between Lagrangian and Eulerian measurements (not including Stokes drift) increased with wave-driven current speed (Table 2). The discrepancy between the ADCP and the drifter speeds may also be due to the heterogeneity of flow speeds within the 100m grid cell. The ADCPs were installed in relatively deeper parts of the reef where they could sample during all tide stages, but the flow speeds could be faster where it is forced up and over the coral heads and influence the drifter. Another potential error is surfing of the drifter, however, Falter et al. (2008) concluded the wave-induced deflection, normal to the current was low, so while this may explain some of the discrepancy it was not the dominant process.") 

document.add_paragraph("While the combination of Eulerian and Lagrangian methods is advantageous for interpreting spatial current patterns and speeds in relation to long-term forcing, in some cases, a single estimate of transport is needed, and the decision to use the Eulerian or Lagrangian estimates depends on the application. Falter et al. (2008) concluded that relying on solely Lagrangian estimates of water transport would have caused an overestimation of nutrient uptake on the reef by 30-100%, however, Falter et al. (2008) and others are interested in water properties that are evenly distributed through the water column. Other studies might be more interested in surface transport related to sediment plumes (Warrick, et al., 2007), plankton and larvae transport (Siegel et al., 2003), or alternatively, focused on currents near the bottom affecting shear stress and benthic sediment movement (Presto et al., 2006).")


## Take-away message
document.add_paragraph("The overrall pattern of mean flow speeds and flow directions showed a predominantly clockwise circulation through the bay under all forcing conditions, with higher flow speeds throughout the bay during wave forcing, compared to tidal and wind forcing. The shortest residence times were measured on the outer reef flat closest to where waves were breaking on the reef crest and were longest over the inner reef flat close to shore and deep in the northwest corner of the embayment. Given the proximity of the northern reef to the stream mouth and the occurrence of floods under typically low wave conditions in the wet season, or moderate easterly winds during the dry season, this suggests the northern reef and areas of the southern reef bordering the ava channel are under greatest threat of land-based sources of pollution. The spatial flow pattern and longer residence times result in greater exposure (= intensity x duration) of the corals in these areas to stress from terrestrial pollution, and likely causes the reduced coral health in these locations.")

# YOU NEED A PARAGRAPH OR TWO THAT GETS OUT OF FAGAALU AND EXTRAPOLATES THESE DATA TO OTHER LOCATIONS, FOR MOST PEOPLE COULDNT CARE LESS ABOUT FAGAALU. STATEMENT ABOUT HOW, COMBINED, THESE METHODS MAKE IT POSSIBLE TO GENERATE GREAT SPATIAL DATA NEEDED FOR UNDERSTANDING BIOLOGICALLY-RELEVANT PROCESSES (POSITIVE OR NEGATIVE) AND HOW THEY MIGHT VARY ACROSS THE REEF. NEED MORE IN HERE ABOUT THE APPLICABILITY OF THESE DATA  GAS AND NUTRIENT FLUXES, LARVAL RECRUITMENT, ETC

# THESE METHODS ALSO MAKE IT POSSIBLE TO EXTRAPOLATE THE FINDINGS OUT TO ANNUAL TIME SCALES TO DETERMINE BUDGETS BASED ON METEOROLOGIC AND OCEANOGRAPHIC (DEEPWATER) FORCING, IN THAT YOU COULD DETERMINE THERE ARE XXXX DAYS PER YEAR OF TIDAL FORCING CONDITIONS, YYYY OF WIND FORCING, AND ZZZZ OF WAVE FORCING. 


document.add_paragraph("Coral reefs are physically and biologically heterogeneous environments, but ecologically important flow speeds and spatial patterns have been difficult to measure in relation to the long-term forcing conditions. Many water circulation studies significantly simplify the study site for modeling purposes or rely on only a few fixed instrument locations. The combination of spatially extensive Lagrangian drifters and temporally extensive Eulerian current meters presented here provides insight on the spatial patterns of flow within the context of variable circulation-forcing conditions. Nutrient uptake on coral reefs is considered to be limited primarily by the flow of water over the benthic surface (Bilger and Atkinson, 1992; Falter et al., 2004), and our results show that flow speeds can be highly variable over small scales on the reef. Nutrient uptake and other water quality parameters can be influenced by the depth and metabolic activity of the benthic surface contacted by a traveling water parcel, so the particular flow path and residence times of water over various benthic surfaces are important. Lowe and Falter (2015) argue that nutrient uptake mass-transfer models should be refined for smaller scale flows and tested in actual reef sites, but critical water circulation measurements to parameterize these models will require a combination of Eulerian and Lagrangian measurements similar to the methodology presented in this study.")


document.add_paragraph("Quantifying residence time and flow patterns in relation to endemember forcing conditions can be used to extrapolate the findings from a targeted study period to seasonal, annual, or longer time scale, by determining the proportion of days that are dominated by tidal, wind, or wave forcing. A similar approach could be used to extrapolate the effects on reef flat circulation from future climate scenarios with changing storm frequencies and characteristics. For instance, a predicted increase in the strength and frequency of Southern Ocean storms (Hemer et al., 2013) could be extended to predict changing sediment dynamics, temperature regimes and nutrient cycling at the study site (Lowe and Falter, 2015). The end-member forcing conditions could also be further refined to describe wave heights and wind speeds of varying magnitude, or combined with an empirical relationship accounting for varying tide stage, for finer-resolution predictive models of current speeds" )
#Or, flow speeds and directions could be determined by empirical relationships from the combination of forcing conditions instead of discrete categories. 

document.add_paragraph("This study investigated water circulation patterns driving sediment dynamics and resulting impacts on coral health at the study site, but water circulation is critical for understanding both the natural ecological processes and the impacts of anthropogenic impacts on all coral reefs. This study showed that flow speeds, flow directions, and water residence times were spatially heterogeneous in fringing-reef environments.")

#sediment: Storlazzi et al., 2009
#
#nutrients: Nutrient uptake by benthic organisms in coral reefs is limited only by the transfer of water , so variations in water flow at the small scales of coral organisms-coral canopies are very important. Our measurements show that water circulation is highly variable over the reef. Nutrient uptake models need to be refined and tested in live coral environments (Lowe 2015), but better methods for measuring water flow for those experiments are needed like our method presented here.
#
#Water quality changes depending on residence time (or water age) in the reef but also depends on its path of travel and which portions of the reef the water parcel was in contact with. These are only known by Lagrangian measurement methods. Organism metabolism can be highly variable over the reef but heat fluxes are near constant, and thus only changed by residence time and flow path.
#Dissolved oxygen fluxes as proxy for metabolic activity (Falter et al., 2008) net primary productivity



#### Acknowledgements
document.add_paragraph('ACKNOWLEDGEMENTS').style = document.styles['Heading CR1'] 
document.add_paragraph("This work was carried out in collaboration between San Diego State University and the US Geological Survey's Pacific Coral Reef Project. Funding was provided by a grant by the NOAA Coral Reef Conservation Program and the US Geological Survey's Coastal and Marine Geology Porgram. We would like to thank Dr. Michael Favazza for providing logistical support in the field. We would also like to thank YYY (USGS) and the reviewers at Coral Reefs who contributed numerous excellent suggestions and a timely review of our work. Use of trademark names does not imply USGS endorsement of products.")

#### References
document.add_page_break()
document.add_paragraph('References')
document.add_paragraph('Add at the end, using Mendeley refs')
document.add_page_break()

#### Table Titles
document.add_paragraph('Tables').style = document.styles['Heading CR2'] 
for t in table_titles:
    document.add_paragraph(t)
    
p = document.add_paragraph("Table 1. End member periods.")
p.paragraph_style = 'caption'

p  = document.add_paragraph("Table 2. Mean flow speed and residence time computed from the ADCPs and corresponding spatially binned drifter data for different forcing conditions.")
#### Figure Captions
document.add_paragraph('Figure Captions').style = document.styles['Heading CR2'] 
for caption in figure_captions:
    document.add_paragraph(caption)    

#### Appendix
document.add_page_break()
document.add_paragraph('APPENDIX').style = document.styles['Heading CR1'] 

document.add_paragraph("Appendix 1. Drifter deployment dates and conditions. Red numbered deployments coincide with ADCP deployments.")

## Table: Drifter deployments dates and conditions
if 'Drifter_deployment_table' in locals():
    dataframe_to_table(df=Drifter_deployment_table,table_num=Drifter_deployment_table.table_num,caption="Drifter deployment dates and conditions. Red numbered Deployments coincide with ADCP deployment",fontsize=9)
    document.add_paragraph("")  
    


    
## Save Document
document.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation.docx')
tables_and_figures.save(maindir+'Manuscript/DRAFT-Fagaalu_water_circulation_tables_figures.docx')

## Clean up any open figures
plt.close('all')

